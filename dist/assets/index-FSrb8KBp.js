(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})(),Z({DEVICE_LOST:`Device::Lost`});var e=Z({WEBGPU_NOT_SUPPORTED:`WEBGPU_NOT_SUPPORTED`,ADAPTER_NOT_FOUND:`ADAPTER_NOT_FOUND`,FEATURE_NOT_FOUND:`FEATURE_NOT_FOUND`,DEVICE_NOT_FOUND:`DEVICE_NOT_FOUND`,DEVICE_NOT_REQUESTED:`DEVICE_NOT_REQUESTED`,DEVICE_LOST:`DEVICE_LOST`,INVALID_CALL:`INVALID_CALL`,SHADER_CODE_NOT_FOUND:`SHADER_CODE_NOT_FOUND`,SHADER_MODULE_NOT_FOUND:`SHADER_MODULE_NOT_FOUND`,VERTEX_ENTRY_NOT_FOUND:`VERTEX_ENTRY_NOT_FOUND`,VERTEX_ATTRIBUTE_NOT_FOUND:`VERTEX_ATTRIBUTE_NOT_FOUND`,UNIFORM_NOT_FOUND:`UNIFORM_NOT_FOUND`,STORAGE_NOT_FOUND:`STORAGE_NOT_FOUND`,INVALID_UNIFORM_NAME:`INVALID_UNIFORM_NAME`,BINDING_NOT_FOUND:`BINDING_NOT_FOUND`,PIPELINE_NOT_FOUND:`PIPELINE_NOT_FOUND`,RENDERER_NOT_FOUND:`RENDERER_NOT_FOUND`,TEXTURE_SIZE_NOT_FOUND:`TEXTURE_SIZE_NOT_FOUND`,TEXTURE_NOT_FOUND:`TEXTURE_NOT_FOUND`,INVALID_BYTES_PER_ROW:`INVALID_BYTES_PER_ROW`,CANVAS_NOT_FOUND:`CANVAS_NOT_FOUND`,CONTEXT_NOT_FOUND:`CONTEXT_NOT_FOUND`,RENDER_PASS_NOT_FOUND:`RENDER_PASS_NOT_FOUND`,COMMAND_ENCODER_NOT_FOUND:`COMMAND_ENCODER_NOT_FOUND`,TIMESTAMP_QUERY_NOT_FOUND:`TIMESTAMP_QUERY_NOT_FOUND`,COMMAND_BUFFER_SUBMITTED:`COMMAND_BUFFER_SUBMITTED`}),t=Z({WEBGPU_NOT_SUPPORTED:`WebGPU is not supported in this browser.`,ADAPTER_NOT_FOUND:`Failed to get a GPUAdapter.`,DEVICE_NOT_FOUND:`Failed to get a GPUDevice.`,FEATURE_NOT_FOUND:`Failed to get a GPUFeature `,DEVICE_NOT_REQUESTED:`GPUDevice was not requested.`,DEVICE_LOST:`WebGPU device was lost. `,INVALID_CALL:`Invalid call to the following `,SHADER_CODE_NOT_FOUND:`Failed to get a WGSL shader when creating shader module.
        An empty shader will be used instead.`,SHADER_MODULE_NOT_FOUND:`Failed to get shader module in `,VERTEX_ENTRY_NOT_FOUND:`Failed to find function `,VERTEX_ATTRIBUTE_NOT_FOUND:`Failed to find vertex attribute `,UNIFORM_NOT_FOUND:`Failed to find uniform `,STORAGE_NOT_FOUND:`Failed to find storage `,INVALID_UNIFORM_NAME:`Requested uniform is already in use and managed internally: `,BINDING_NOT_FOUND:`Failed to find binding `,PIPELINE_NOT_FOUND:`Failed to get GPU`,RENDERER_NOT_FOUND:'"Device.Renderer" instance is required in `Texture` for this operation.\n        Pass it to the `Texture` constructor or use `Texture.Renderer` setter before ',TEXTURE_SIZE_NOT_FOUND:"`size` array or a `width` value is required in `options` parameter of ",TEXTURE_NOT_FOUND:"`options` is required to have a `texture` value or its `create` entry\n        to be either `true` or a `TextureDescriptor` object when calling ",INVALID_BYTES_PER_ROW:"`bytesPerRow` parameter is not a multiple of 256 in ",CANVAS_NOT_FOUND:`Failed to get a WebGPU canvas.`,CONTEXT_NOT_FOUND:`Failed to get a WebGPU context.`,RENDER_PASS_NOT_FOUND:`Failed to use pipeline in render pass because it has not started.`,COMMAND_ENCODER_NOT_FOUND:`Failed to get a GPUCommandEncoder.`,TIMESTAMP_QUERY_NOT_FOUND:'"timestamp-query" feature is required to be set with\n        `Device.SetRequiredFeatures` when creating a new `GPUTiming` instance.',COMMAND_BUFFER_SUBMITTED:"Failed get `GPUCommandEncoder` because `GPUCommandBuffer` was already submitted.\n        Pipeline's `Render` or `Compute` method has to be called with `submit` flag set to `false`."}),n=Z({WEBGPU_NOT_SUPPORTED:0,ADAPTER_NOT_FOUND:1,DEVICE_NOT_FOUND:2,DEVICE_NOT_REQUESTED:3,DEVICE_LOST:4,CANVAS_NOT_FOUND:5,CONTEXT_NOT_FOUND:6,COMMAND_ENCODER_NOT_FOUND:7,PIPELINE_NOT_FOUND:8});function r(e,n){console.warn(`${t[e]}${n??``}`.replace(/\s\s+/g,` `))}function i(e,r){throw Error(`${t[e]}${r??``}`.replace(/\s\s+/g,` `),{cause:n[e]})}var a=class{Pipelines=[];#n;Device;#e;#t;#r;constructor(e,t,n){this.#r=n,this.#t=t,this.Device=e,this.#e=this.CreateStageLabel(`Command Encoder`)}CreateStageLabel(e){return this.#r&&e&&`${this.#r} ${e}`||``}#i(){return this.#t===`Render`&&GPUShaderStage.FRAGMENT||GPUShaderStage.COMPUTE}CreateTimestampWrites(e,t=0,n=1){return{querySet:e,beginningOfPassWriteIndex:t,endOfPassWriteIndex:n}}ResolveQuerySet(e,t,n=0,r=e.count,i=0){this.GetCommandEncoder(!0).resolveQuerySet(e,n,r,t,i)}CreateBufferBindingLayout(e,t,n,r,i){return r??=this.#i(),{binding:i,visibility:r,buffer:{type:e,hasDynamicOffset:t,minBindingSize:n}}}CreateSamplerBindingLayout(e,t,n){return t??=this.#i(),{binding:n,visibility:t,sampler:{type:e}}}CreateTextureBindingLayout(e,t,n,r,i){return r??=this.#i(),{binding:i,visibility:r,texture:{sampleType:e,viewDimension:t,multisampled:n}}}CreateStorageTextureBindingLayout(e,t,n,r,i){return r??=this.#i(),{binding:i,visibility:r,storageTexture:{access:t,format:e,viewDimension:n}}}CreateExternalTextureBindingLayout(e,t){return e??=this.#i(),{binding:t,visibility:e,externalTexture:{}}}CreateCommandEncoder(){return this.#n=this.Device.createCommandEncoder({label:this.#e})}GetCommandEncoder(t=!1){if(!this.#n){if(t){let t=`${this.#e&&`Label: "${this.#e}".`}`;r(e.COMMAND_ENCODER_NOT_FOUND,` ${t} Creating a new one.`)}return this.CreateCommandEncoder()}return this.#n}SubmitCommandBuffer(){this.Device.queue.submit([this.#n.finish()])}CopyBufferToBuffer(e,t,n=t.size,r=0,i=0){this.GetCommandEncoder(!0).copyBufferToBuffer(e,r,t,i,n)}RemovePipeline(t){let n=this.Pipelines.indexOf(t);n<0?(r(e.PIPELINE_NOT_FOUND,`${this.#t}Pipeline. The following pipeline was not found when
                calling \`${this.#t===`Render`&&`${this.#t}er`||`Computation`}.RemovePipeline\` method.`),console.warn(t)):(this.Pipelines[n].Destroy(),this.Pipelines.splice(n,1),this.Pipelines.forEach((e,t)=>e.Index=t))}set CommandEncoder(e){this.#n=e}set CommandEncoderLabel(e){this.#e=e}get Name(){return this.#r}Destroy(){this.Pipelines.forEach(e=>e.Destroy()),this.CommandEncoder=void 0,this.Pipelines.splice(0)}},o=Z({RENDER:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST,STORAGE:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING}),s=Z({ALL:`all`,STENCIL:`stencil-only`,DEPTH:`depth-only`}),c=Z({CLAMP:`clamp-to-edge`,REPEAT:`repeat`,MIRROR:`mirror-repeat`}),l=Z({NEAREST:`nearest`,LINEAR:`linear`}),u=Z({NEVER:`never`,LESS:`less`,EQUAL:`equal`,LESS_EQUAL:`less-equal`,GREATER:`greater`,NOT_EQUAL:`not-equal`,GREATER_EQUAL:`greater-equal`,ALWAYS:`always`});Object.freeze(Object.defineProperty({__proto__:null,ADDRESS:c,ASPECT:s,COMPARE:u,FILTER:l,USAGE:o},Symbol.toStringTag,{value:`Module`}));var d=`@group(0)@binding(0)var<uniform>meshModelViewProjection: mat4x4f;fn GetVertexClipSpace(position: vec4f)->vec4f{return meshModelViewProjection*position;}@vertex fn vertex(@location(0)position: vec4f)->@builtin(position)vec4f {return GetVertexClipSpace(position);}`,f=`@group(0)@binding(1)var<uniform>color: vec4f;@fragment fn fragment()->@location(0)vec4f {return color;}`,p=`@vertex fn vertex()->@builtin(position)vec4f {return vec4f(0);}@fragment fn fragment()->@location(0)vec4f {return vec4f(0);}@compute @workgroup_size(1)fn compute(){}`,m=`const QUAD=array(vec2f(-1.0,-1.0),vec2f(1.0,-1.0),vec2f(1.0,1.0),vec2f(1.0,1.0),vec2f(-1.0,1.0),vec2f(-1.0,-1.0));fn GetQuadCoord(index: u32)->vec2f{return QUAD[index];}struct VertexOutput{@builtin(position)position: vec4f,@location(0)textureCoord: vec2f};@group(0)@binding(0)var Sampler: sampler;@group(0)@binding(1)var Texture: texture_2d<f32>;@vertex fn vertex(@builtin(vertex_index)index: u32)->VertexOutput {let position=GetQuadCoord(index);let coord=(position+1)*0.5;var output: VertexOutput;output.position=vec4f(position,0.0,1.0);output.textureCoord=vec2f(coord.x,1-coord.y);return output;}@fragment fn fragment(@location(0)textureCoord: vec2f)->@location(0)vec4f {return textureSample(Texture,Sampler,textureCoord);}`,h=`const VERTEX=array(vec2f(0,-1),vec2f(1,-1),vec2f(0,0),vec2f(1,0));struct char{coords: vec2f,extent: vec2f,size : vec2f,offset: vec2f};struct text{alpha: f32,scale: f32,color: vec4f,transform: mat4x4f,chars: array<vec3f>};struct camera{view: mat4x4f,projection: mat4x4f};struct MSDFTextVertexOutput{@location(0)textureCoord: vec2f,@builtin(position)position: vec4f};@group(0)@binding(0)var Sampler: sampler;@group(0)@binding(1)var Texture: texture_2d<f32>;@group(0)@binding(2)var<storage>Characters: array<char>;@group(0)@binding(3)var<uniform>Camera: camera;@group(1)@binding(0)var<storage>Text: text;@vertex fn vertex(@builtin(vertex_index)index: u32,@builtin(instance_index)instance: u32)->MSDFTextVertexOutput{var output: MSDFTextVertexOutput;let vertexPosition=VERTEX[index];let textElement=Text.chars[instance];let character=Characters[u32(textElement.z)];output.textureCoord=vertexPosition*vec2f(1,-1);let characterPosition=(vertexPosition*character.size+textElement.xy+character.offset)*Text.scale;output.position=Camera.projection*Camera.view*Text.transform*vec4f(characterPosition,0,1);output.textureCoord*=character.extent;output.textureCoord+=character.coords;return output;}fn SampleMSDFTexture(coord: vec2f)->f32{let c=textureSample(Texture,Sampler,coord);return max(min(c.r,c.g),min(max(c.r,c.g),c.b));}@fragment fn fragment(@location(0)textureCoord: vec2f)->@location(0)vec4f {let signDistance=SampleMSDFTexture(textureCoord)-0.5;let dimensions=vec2f(textureDimensions(Texture,0));let dpdx=dpdxFine(textureCoord);let dpdy=dpdyFine(textureCoord);let x=length(vec2f(dpdx.x,dpdy.x));let y=length(vec2f(dpdx.y,dpdy.y));let dx=dimensions.x*x;let dy=dimensions.y*y;let px=inverseSqrt(dx*dx+dy*dy)*4;let pxDistance=signDistance*px;let a=smoothstep(Text.alpha,-Text.alpha,pxDistance);if(a<0.001){discard;}return vec4f(Text.color.rgb,Text.color.a*a);}`,g=`@group(0)@binding(0)var<uniform>shapeModelViewProjection: mat3x3f;fn GetVertexClipSpace(position: vec2f)->vec4f{return vec4f((shapeModelViewProjection*vec3f(position,1)).xy,0,1);}@vertex fn vertex(@location(0)position: vec2f)->@builtin(position)vec4f {return GetVertexClipSpace(position);}`,_=`@group(0)@binding(1)var<uniform>color: vec4f;@fragment fn fragment()->@location(0)vec4f {return color;}`,v=`${d}

${f}`,y=`${g}

${_}`,b=Object.freeze(Object.defineProperty({__proto__:null,Cube:v,CubeFragment:f,CubeVertex:d,Empty:p,MSDFText:h,Mipmaps:m,Quad:`const QUAD=array(vec2f(-1.0,-1.0),vec2f(1.0,-1.0),vec2f(1.0,1.0),vec2f(1.0,1.0),vec2f(-1.0,1.0),vec2f(-1.0,-1.0));fn GetQuadCoord(index: u32)->vec2f{return QUAD[index];}`,Resolution:`@group(0)@binding(0)var<uniform>resolution: vec3f;fn GetClipSpace(position: vec2f)->vec2f{let clipSpace=position/resolution.xy*2-1;return clipSpace*vec2f(1,-1);}`,Shape:y,ShapeFragment:_,ShapeVertex:g},Symbol.toStringTag,{value:`Module`})),x=class{#n;#e;#t;#r;#i;constructor(t,n){!t&&i(e.DEVICE_NOT_REQUESTED),this.#t=n,this.#n=t}#a(e){return e instanceof HTMLVideoElement?[e.videoWidth,e.videoHeight]:e instanceof VideoFrame?[e.codedWidth,e.codedHeight]:[e.width,e.height]}#s(t,n){let{size:r,width:a,height:o,depthOrArrayLayers:s}=t;return!r&&!a&&i(e.TEXTURE_SIZE_NOT_FOUND,`\`${n}\` method.`),r??{width:a,height:o,depthOrArrayLayers:s}}#o(t,n){let i=t/256;i!==(0|i)&&r(e.INVALID_BYTES_PER_ROW,`\`${n}\` options.`)}CreateSampler(e){if(!e)return this.#n.createSampler();let{addressModeUV:t,addressMode:n,minMagFilter:r,filter:i}=e;return t&&(e.addressModeU=e.addressModeV=t),n&&(e.addressModeU=e.addressModeV=e.addressModeW=n),r&&(e.minFilter=e.magFilter=r),i&&(e.minFilter=e.magFilter=e.mipmapFilter=i),this.#n.createSampler(e)}CreateTexture(e){let t=e.label??`Texture`,{format:n=Xt.PreferredCanvasFormat,usage:r=o.RENDER}=e;return this.#n.createTexture({label:t,format:n,usage:r,...e})}WriteTexture(e,t){let{texture:n,mipLevel:r,origin:i,aspect:a,offset:o,rowsPerImage:s}=t,[c,l]=this.#a(n),{bytesPerRow:u}=t;u??=(t.width??c)*Float32Array.BYTES_PER_ELEMENT,this.#n.queue.writeTexture({texture:n,mipLevel:r,origin:i,aspect:a},e,{offset:o,bytesPerRow:u,rowsPerImage:s},this.#s({width:c,height:l,...t},`WriteTexture`))}CreateStorageTexture(e){let{size:t}=e,n=o.STORAGE|e.usage,r=e.label??`Storage Texture`,{format:i=this.PreferredStorageFormat}=e;return t=this.#t&&!t?this.#t.CanvasSize:t,this.CreateTexture({label:r,size:t,format:i,...e,usage:n})}CreateTextureFromSource(e,t={}){let n=(t=typeof t==`boolean`&&{}||t).size,r=t.size,i=t.mipLevelCount??((t.mipmaps??!0)&&this.GetMipmapLevels(e)||void 0),a=Array.isArray(t.size)||!t.size?n??this.#a(e):[r.width,r.height];return this.CreateTexture({size:a,mipLevelCount:i,...t})}ImportExternalTexture(e,t,n){return this.#n.importExternalTexture({source:e,label:t,colorSpace:n})}async LoadExternalImageSource(e,t={}){return new Promise(n=>{let r=new Image;for(let e in t)r[e]=t[e];r.onload=()=>n(r),r.src=e})}async CreateImageBitmap(e,t,n){let r=await(await fetch(e,n)).blob();return t??={colorSpaceConversion:`none`},createImageBitmap(r,t)}CreateMultisampleTexture(t=!1,n=4,r){!this.#t&&i(e.RENDERER_NOT_FOUND,`creating a multisample texture.`);let{width:a,height:o,format:s}=this.#t.CurrentTexture;return!t&&this.#e&&this.#e.width===a&&this.#e.height===o||(this.#e?.destroy(),this.#e=this.CreateTexture({usage:GPUTextureUsage.RENDER_ATTACHMENT,label:r??`Multisample Texture`,size:[a,o],sampleCount:n,format:s})),this.#e}async CopyImageToTexture(t,n={create:!0}){let{create:r,texture:a}=n,[o,s]=this.#a(t),{flipY:c,mipLevel:l,aspect:u,colorSpace:d,premultipliedAlpha:f,mipmaps:p}=n;return p===!1&&((r=typeof r==`object`&&r||{}).mipmaps??=!1),!a&&!r&&i(e.TEXTURE_NOT_FOUND,"`CopyImageToTexture`."),a??=this.CreateTextureFromSource(t,r),this.#n.queue.copyExternalImageToTexture({source:t,origin:n.sourceOrigin,flipY:c},{texture:a,mipLevel:l,origin:n.destinationOrigin,aspect:u,colorSpace:d,premultipliedAlpha:f},this.#s({width:o,height:s,...n},`CopyImageToTexture`)),(p??1)&&1<a.mipLevelCount&&await(a.depthOrArrayLayers===1?this.GenerateMipmaps(a):this.GenerateCubeMipmaps(a)),a}async#u(t,n,r){!this.#t&&i(e.RENDERER_NOT_FOUND,`creating a texture with mipmaps.`);let{UseDepthStencilAttachment:a,RenderPassDescriptor:o}=this.#t,s=this.#t.Pipelines.map(e=>{let t=e.Active;return e.Active=!1,t}),c=new this.#t.Pipeline;this.#t.UseDepthStencilAttachment=!1,c.DestroyPassEncoder=!0,c.UseTextureView=!1,c.SetDrawParams(6),this.#i&&this.#r||(this.#i=c.CreateShaderModule(m),this.#r=this.CreateSampler(n)),await this.#t.AddPipeline(c,{vertex:c.CreateVertexState(this.#i),fragment:c.CreateFragmentState(this.#i,c.CreateColorTargetState(t.format))});for(let e=1;e<t.mipLevelCount;++e)r(c,e);this.#t.SubmitCommandBuffer(),this.#t.CommandEncoder=void 0,this.#t.RemovePipeline(c),this.#i=this.#r=void 0,this.#t.UseDepthStencilAttachment=a,s.forEach((e,t)=>this.#t.Pipelines[t].Active=e);let l=o.depthStencilAttachment&&this.#t.CreateDepthStencilAttachment(o.depthStencilAttachment.view,o.depthStencilAttachment.depthClearValue,o.depthStencilAttachment.depthLoadOp,o.depthStencilAttachment.depthStoreOp,o.depthStencilAttachment.depthReadOnly,o.depthStencilAttachment.stencilAttachment);this.#t.CreatePassDescriptor(o.colorAttachments,l,o.label,o.occlusionQuerySet,o.timestampWrites,o.maxDrawCount)}async GenerateCubeMipmaps(e){return this.#u(e,{minMagFilter:l.LINEAR},(t,n)=>{for(let r=0;r<e.depthOrArrayLayers;++r)t.SetBindGroupFromResources([this.#r,e.createView({baseMipLevel:n-1,arrayLayerCount:1,baseArrayLayer:r,mipLevelCount:1,dimension:`2d`})]),this.#t.CreatePassDescriptor(this.#t.CreateColorAttachment(void 0,e.createView({arrayLayerCount:1,baseArrayLayer:r,mipLevelCount:1,dimension:`2d`,baseMipLevel:n}))),this.#t.Render(!1)})}async GenerateMipmaps(e){return this.#u(e,{minFilter:l.LINEAR},(t,n)=>{t.SetBindGroupFromResources([this.#r,e.createView({baseMipLevel:n-1,mipLevelCount:1})]),this.#t.CreatePassDescriptor(this.#t.CreateColorAttachment(void 0,e.createView({baseMipLevel:n,mipLevelCount:1}))),this.#t.Render(!1)})}CopyTextureToTexture(t){let{source:n,create:r}=t,{srcTexture:a,dstTexture:o}=t;!this.#t&&i(e.RENDERER_NOT_FOUND,`copying a texture to a texture.`),!a&&!n&&!r&&i(e.TEXTURE_NOT_FOUND,"`CopyTextureToTexture`."),a??=this.CreateTextureFromSource(n,r),o??=this.CreateTextureFromSource(a,r);let{srcMipLevel:s,srcOrigin:c,srcAspect:l}=t,{dstMipLevel:u,dstOrigin:d,dstAspect:f}=t,[p,m]=this.#a(a);this.#t.GetCommandEncoder(!0).copyTextureToTexture({texture:a,mipLevel:s,origin:c,aspect:l},{texture:o,mipLevel:u,origin:d,aspect:f},this.#s({width:p,height:m,...t},`CopyTextureToTexture`))}CopyTextureToBuffer(t){let{source:n,create:r}=t,{texture:a,bytesPerRow:o}=t;!this.#t&&i(e.RENDERER_NOT_FOUND,`copying a texture to a buffer.`),!a&&!n&&!r&&i(e.TEXTURE_NOT_FOUND,"`CopyTextureToBuffer`."),a??=this.CreateTextureFromSource(n,r);let[s,c]=this.#a(a),{buffer:l,offset:u,rowsPerImage:d,mipLevel:f,origin:p,aspect:m}=t;o??=(t.width??s)*Float32Array.BYTES_PER_ELEMENT,this.#o(o,`CopyTextureToBuffer`),this.#t.GetCommandEncoder(!0).copyTextureToBuffer({texture:a,mipLevel:f,origin:p,aspect:m},{buffer:l,offset:u,bytesPerRow:o,rowsPerImage:d},this.#s({width:s,height:c,...t},`CopyTextureToBuffer`))}CopyBufferToTexture(t){let{source:n,create:r}=t,{texture:a,bytesPerRow:o}=t;!this.#t&&i(e.RENDERER_NOT_FOUND,`copying a buffer to a texture.`),!a&&!n&&!r&&i(e.TEXTURE_NOT_FOUND,"`CopyBufferToTexture`."),a??=this.CreateTextureFromSource(n,r);let[s,c]=this.#a(a),{buffer:l,offset:u,rowsPerImage:d,mipLevel:f,origin:p,aspect:m}=t;o??=(t.width??s)*Float32Array.BYTES_PER_ELEMENT,this.#o(o,`CopyBufferToTexture`),this.#t.GetCommandEncoder(!0).copyBufferToTexture({buffer:l,offset:u,bytesPerRow:o,rowsPerImage:d},{texture:a,mipLevel:f,origin:p,aspect:m},this.#s({width:s,height:c,...t},`CopyBufferToTexture`))}get PreferredStorageFormat(){let e=Xt.PreferredCanvasFormat;return this.#n.features.has(`bgra8unorm-storage`)&&e===`bgra8unorm`?e:`rgba8unorm`}GetMipmapLevels(e){let[t,n]=this.#a(e);return 1+(0|Math.log2(Math.max(t,n)))}set Renderer(e){this.#t=e}Destroy(){this.#e=this.#e?.destroy()}},S=class{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}get isPointer(){return!1}getTypeName(){return this.name}},C=class{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}},w=class extends S{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}},T=class extends S{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}getTypeName(){return`array<${this.format.getTypeName()}, ${this.count}>`}},E=class extends S{constructor(e,t,n){super(e,n),this.format=t}get isPointer(){return!0}getTypeName(){return`&${this.format.getTypeName()}`}},D=class extends S{constructor(e,t,n,r){super(e,n),this.format=t,this.access=r}get isTemplate(){return!0}getTypeName(){let e=this.name;if(this.format!==null){if(e===`vec2`||e===`vec3`||e===`vec4`||e===`mat2x2`||e===`mat2x3`||e===`mat2x4`||e===`mat3x2`||e===`mat3x3`||e===`mat3x4`||e===`mat4x2`||e===`mat4x3`||e===`mat4x4`){if(this.format.name===`f32`)return e+=`f`,e;if(this.format.name===`i32`)return e+=`i`,e;if(this.format.name===`u32`)return e+=`u`,e;if(this.format.name===`bool`)return e+=`b`,e;if(this.format.name===`f16`)return e+=`h`,e}e+=`<${this.format.name}>`}else if(e===`vec2`||e===`vec3`||e===`vec4`)return e;return e}},O;(e=>{e[e.Uniform=0]=`Uniform`,e[e.Storage=1]=`Storage`,e[e.Texture=2]=`Texture`,e[e.Sampler=3]=`Sampler`,e[e.StorageTexture=4]=`StorageTexture`})(O||={});var ee=class{constructor(e,t,n,r,i,a,o){this.name=e,this.type=t,this.group=n,this.binding=r,this.attributes=i,this.resourceType=a,this.access=o}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}},te=class{constructor(e,t){this.name=e,this.type=t}},ne=class{constructor(e,t,n,r){this.name=e,this.type=t,this.locationType=n,this.location=r,this.interpolation=null}},re=class{constructor(e,t,n,r){this.name=e,this.type=t,this.locationType=n,this.location=r}},ie=class{constructor(e,t,n,r){this.name=e,this.type=t,this.attributes=n,this.id=r}},ae=class{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n}},oe=class{constructor(e,t=null,n){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=n}},se=class{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}};function ce(e){var t=(32768&e)>>15,n=(31744&e)>>10,r=1023&e;return n==0?(t?-1:1)*2**-14*(r/2**10):n==31?r?NaN:1/0*(t?-1:1):(t?-1:1)*2**(n-15)*(1+r/2**10)}var le=new Float32Array(1),ue=new Int32Array(le.buffer),k=new Uint16Array(1);function de(e){le[0]=e;let t=ue[0],n=t>>31&1,r=t>>23&255,i=8388607&t;if(r===255)return k[0]=n<<15|31744|(i===0?0:512),k[0];if(r===0){if(i===0)return k[0]=n<<15,k[0];i|=8388608;let e=113;for(;!(8388608&i);)i<<=1,e--;return r=127-e,i&=8388607,r>0?(i=(i>>126-r)+(i>>127-r&1),k[0]=n<<15|r<<10|i>>13,k[0]):(k[0]=n<<15,k[0])}return r=r-127+15,r>=31?(k[0]=n<<15|31744,k[0]):r<=0?r<-10?(k[0]=n<<15,k[0]):(i=(8388608|i)>>1-r,k[0]=n<<15|i>>13,k[0]):(i>>=13,k[0]=n<<15|r<<10|i,k[0])}var fe=new Uint32Array(1),pe=new Float32Array(fe.buffer,0,1);function me(e){return fe[0]=112+(e>>6&31)<<23|(63&e)<<17,pe[0]}function A(e,t,n,r){let i=[0,0,0,0];for(let a=0;a<r;++a)switch(n){case`8unorm`:i[a]=e[t]/255,t++;break;case`8snorm`:i[a]=e[t]/255*2-1,t++;break;case`8uint`:i[a]=e[t],t++;break;case`8sint`:i[a]=e[t]-127,t++;break;case`16uint`:i[a]=e[t]|e[t+1]<<8,t+=2;break;case`16sint`:i[a]=(e[t]|e[t+1]<<8)-32768,t+=2;break;case`16float`:i[a]=ce(e[t]|e[t+1]<<8),t+=2;break;case`32uint`:case`32sint`:i[a]=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24,t+=4;break;case`32float`:i[a]=new Float32Array(e.buffer,t,1)[0],t+=4}return i}function j(e,t,n,r,i){for(let a=0;a<r;++a)switch(n){case`8unorm`:e[t]=255*i[a],t++;break;case`8snorm`:e[t]=127.5*(i[a]+1),t++;break;case`8uint`:e[t]=i[a],t++;break;case`8sint`:e[t]=i[a]+127,t++;break;case`16uint`:new Uint16Array(e.buffer,t,1)[0]=i[a],t+=2;break;case`16sint`:new Int16Array(e.buffer,t,1)[0]=i[a],t+=2;break;case`16float`:{let n=de(i[a]);new Uint16Array(e.buffer,t,1)[0]=n,t+=2;break}case`32uint`:new Uint32Array(e.buffer,t,1)[0]=i[a],t+=4;break;case`32sint`:new Int32Array(e.buffer,t,1)[0]=i[a],t+=4;break;case`32float`:new Float32Array(e.buffer,t,1)[0]=i[a],t+=4}return i}var he={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:`depth32float`,channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:`depth32float`,channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:`depth32float`,channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}},M=class e{constructor(){this.id=e._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return``}search(e){e(this)}searchBlock(e,t){if(e){t(ge.instance);for(let n of e)n instanceof Array?this.searchBlock(n,t):n.search(t);t(_e.instance)}}constEvaluate(e,t){throw Error(`Cannot evaluate node`)}constEvaluateString(e){return this.constEvaluate(e).toString()}};M._id=0;var ge=class extends M{};ge.instance=new ge;var _e=class extends M{};_e.instance=new _e;var ve=new Set(`all.all.any.select.arrayLength.abs.acos.acosh.asin.asinh.atan.atanh.atan2.ceil.clamp.cos.cosh.countLeadingZeros.countOneBits.countTrailingZeros.cross.degrees.determinant.distance.dot.dot4U8Packed.dot4I8Packed.exp.exp2.extractBits.faceForward.firstLeadingBit.firstTrailingBit.floor.fma.fract.frexp.insertBits.inverseSqrt.ldexp.length.log.log2.max.min.mix.modf.normalize.pow.quantizeToF16.radians.reflect.refract.reverseBits.round.saturate.sign.sin.sinh.smoothStep.sqrt.step.tan.tanh.transpose.trunc.dpdx.dpdxCoarse.dpdxFine.dpdy.dpdyCoarse.dpdyFine.fwidth.fwidthCoarse.fwidthFine.textureDimensions.textureGather.textureGatherCompare.textureLoad.textureNumLayers.textureNumLevels.textureNumSamples.textureSample.textureSampleBias.textureSampleCompare.textureSampleCompareLevel.textureSampleGrad.textureSampleLevel.textureSampleBaseClampToEdge.textureStore.atomicLoad.atomicStore.atomicAdd.atomicSub.atomicMax.atomicMin.atomicAnd.atomicOr.atomicXor.atomicExchange.atomicCompareExchangeWeak.pack4x8snorm.pack4x8unorm.pack4xI8.pack4xU8.pack4x8Clamp.pack4xU8Clamp.pack2x16snorm.pack2x16unorm.pack2x16float.unpack4x8snorm.unpack4x8unorm.unpack4xI8.unpack4xU8.unpack2x16snorm.unpack2x16unorm.unpack2x16float.storageBarrier.textureBarrier.workgroupBarrier.workgroupUniformLoad.subgroupAdd.subgroupExclusiveAdd.subgroupInclusiveAdd.subgroupAll.subgroupAnd.subgroupAny.subgroupBallot.subgroupBroadcast.subgroupBroadcastFirst.subgroupElect.subgroupMax.subgroupMin.subgroupMul.subgroupExclusiveMul.subgroupInclusiveMul.subgroupOr.subgroupShuffle.subgroupShuffleDown.subgroupShuffleUp.subgroupShuffleXor.subgroupXor.quadBroadcast.quadSwapDiagonal.quadSwapX.quadSwapY`.split(`.`)),N=class extends M{constructor(){super()}},ye=class extends N{constructor(e,t,n,r,i,a){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=n,this.body=r,this.startLine=i,this.endLine=a}get astNodeType(){return`function`}search(e){if(this.attributes)for(let t of this.attributes)e(t);e(this);for(let t of this.args)e(t);this.searchBlock(this.body,e)}},be=class extends N{constructor(e){super(),this.expression=e}get astNodeType(){return`staticAssert`}search(e){this.expression.search(e)}},xe=class extends N{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return`while`}search(e){this.condition.search(e),this.searchBlock(this.body,e)}},Se=class extends N{constructor(e,t){super(),this.body=e,this.loopId=t}get astNodeType(){return`continuing`}search(e){this.searchBlock(this.body,e)}},Ce=class extends N{constructor(e,t,n,r){super(),this.init=e,this.condition=t,this.increment=n,this.body=r}get astNodeType(){return`for`}search(e){var t,n,r;(t=this.init)==null||t.search(e),(n=this.condition)==null||n.search(e),(r=this.increment)==null||r.search(e),this.searchBlock(this.body,e)}},we=class extends N{constructor(e,t,n,r,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=r,this.value=i}get astNodeType(){return`var`}search(e){var t;e(this),(t=this.value)==null||t.search(e)}},Te=class extends N{constructor(e,t,n){super(),this.attributes=null,this.name=e,this.type=t,this.value=n}get astNodeType(){return`override`}search(e){var t;(t=this.value)==null||t.search(e)}},Ee=class extends N{constructor(e,t,n,r,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=r,this.value=i}get astNodeType(){return`let`}search(e){var t;e(this),(t=this.value)==null||t.search(e)}},De=class extends N{constructor(e,t,n,r,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=r,this.value=i}get astNodeType(){return`const`}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),(t=this.value)==null||t.search(e)}},Oe,ke,P,F;(e=>{e.increment=`++`,e.decrement=`--`})(Oe||={}),(e=>{e.parse=t=>{let n=t;if(n==`parse`)throw Error(`Invalid value for IncrementOperator`);return e[n]}})(Oe||={});var Ae=class extends N{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return`increment`}search(e){this.variable.search(e)}};(e=>{e.assign=`=`,e.addAssign=`+=`,e.subtractAssin=`-=`,e.multiplyAssign=`*=`,e.divideAssign=`/=`,e.moduloAssign=`%=`,e.andAssign=`&=`,e.orAssign=`|=`,e.xorAssign=`^=`,e.shiftLeftAssign=`<<=`,e.shiftRightAssign=`>>=`})(ke||={}),(ke||={}).parse=e=>{let t=e;if(t==`parse`)throw Error(`Invalid value for AssignOperator`);return t};var je=class extends N{constructor(e,t,n){super(),this.operator=e,this.variable=t,this.value=n}get astNodeType(){return`assign`}search(e){this.variable.search(e),this.value.search(e)}},Me=class extends N{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return`call`}isBuiltin(){return ve.has(this.name)}search(e){for(let t of this.args)t.search(e);e(this)}},Ne=class extends N{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return`loop`}search(e){var t;this.searchBlock(this.body,e),(t=this.continuing)==null||t.search(e)}},Pe=class extends N{constructor(e,t){super(),this.condition=e,this.cases=t}get astNodeType(){return`switch`}search(e){e(this);for(let t of this.cases)t.search(e)}},Fe=class extends N{constructor(e,t,n,r){super(),this.condition=e,this.body=t,this.elseif=n,this.else=r}get astNodeType(){return`if`}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}},Ie=class extends N{constructor(e){super(),this.value=e}get astNodeType(){return`return`}search(e){var t;(t=this.value)==null||t.search(e)}},Le=class extends N{constructor(e){super(),this.name=e}get astNodeType(){return`enable`}},Re=class extends N{constructor(e){super(),this.extensions=e}get astNodeType(){return`requires`}},ze=class extends N{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return`diagnostic`}},Be=class extends N{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return`alias`}},Ve=class extends N{constructor(){super()}get astNodeType(){return`discard`}},He=class extends N{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return`break`}},Ue=class extends N{constructor(){super(),this.loopId=-1}get astNodeType(){return`continue`}},I=class e extends N{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return`type`}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(t){let n=t[0];if(n.name===`f32`)return n;for(let r=1;r<t.length;++r){let i=e._priority.get(n.name);e._priority.get(t[r].name)<i&&(n=t[r])}return n.name===`x32`?e.i32:n}getTypeName(){return this.name}};I.x32=new I(`x32`),I.f32=new I(`f32`),I.i32=new I(`i32`),I.u32=new I(`u32`),I.f16=new I(`f16`),I.bool=new I(`bool`),I.void=new I(`void`),I._priority=new Map([[`f32`,0],[`f16`,1],[`u32`,2],[`i32`,3],[`x32`,3]]);var We=class extends I{constructor(e){super(e)}},Ge=class extends I{constructor(e,t,n,r){super(e),this.members=t,this.startLine=n,this.endLine=r}get astNodeType(){return`struct`}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}search(e){for(let t of this.members)e(t)}},L=class extends I{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return`template`}getTypeName(){let e=this.name;if(this.format!==null){if(e===`vec2`||e===`vec3`||e===`vec4`||e===`mat2x2`||e===`mat2x3`||e===`mat2x4`||e===`mat3x2`||e===`mat3x3`||e===`mat3x4`||e===`mat4x2`||e===`mat4x3`||e===`mat4x4`){if(this.format.name===`f32`)return e+=`f`,e;if(this.format.name===`i32`)return e+=`i`,e;if(this.format.name===`u32`)return e+=`u`,e;if(this.format.name===`bool`)return e+=`b`,e;if(this.format.name===`f16`)return e+=`h`,e}e+=`<${this.format.name}>`}else if(e===`vec2`||e===`vec3`||e===`vec4`)return e;return e}};L.vec2f=new L(`vec2`,I.f32,null),L.vec3f=new L(`vec3`,I.f32,null),L.vec4f=new L(`vec4`,I.f32,null),L.vec2i=new L(`vec2`,I.i32,null),L.vec3i=new L(`vec3`,I.i32,null),L.vec4i=new L(`vec4`,I.i32,null),L.vec2u=new L(`vec2`,I.u32,null),L.vec3u=new L(`vec3`,I.u32,null),L.vec4u=new L(`vec4`,I.u32,null),L.vec2h=new L(`vec2`,I.f16,null),L.vec3h=new L(`vec3`,I.f16,null),L.vec4h=new L(`vec4`,I.f16,null),L.vec2b=new L(`vec2`,I.bool,null),L.vec3b=new L(`vec3`,I.bool,null),L.vec4b=new L(`vec4`,I.bool,null),L.mat2x2f=new L(`mat2x2`,I.f32,null),L.mat2x3f=new L(`mat2x3`,I.f32,null),L.mat2x4f=new L(`mat2x4`,I.f32,null),L.mat3x2f=new L(`mat3x2`,I.f32,null),L.mat3x3f=new L(`mat3x3`,I.f32,null),L.mat3x4f=new L(`mat3x4`,I.f32,null),L.mat4x2f=new L(`mat4x2`,I.f32,null),L.mat4x3f=new L(`mat4x3`,I.f32,null),L.mat4x4f=new L(`mat4x4`,I.f32,null),L.mat2x2h=new L(`mat2x2`,I.f16,null),L.mat2x3h=new L(`mat2x3`,I.f16,null),L.mat2x4h=new L(`mat2x4`,I.f16,null),L.mat3x2h=new L(`mat3x2`,I.f16,null),L.mat3x3h=new L(`mat3x3`,I.f16,null),L.mat3x4h=new L(`mat3x4`,I.f16,null),L.mat4x2h=new L(`mat4x2`,I.f16,null),L.mat4x3h=new L(`mat4x3`,I.f16,null),L.mat4x4h=new L(`mat4x4`,I.f16,null),L.mat2x2i=new L(`mat2x2`,I.i32,null),L.mat2x3i=new L(`mat2x3`,I.i32,null),L.mat2x4i=new L(`mat2x4`,I.i32,null),L.mat3x2i=new L(`mat3x2`,I.i32,null),L.mat3x3i=new L(`mat3x3`,I.i32,null),L.mat3x4i=new L(`mat3x4`,I.i32,null),L.mat4x2i=new L(`mat4x2`,I.i32,null),L.mat4x3i=new L(`mat4x3`,I.i32,null),L.mat4x4i=new L(`mat4x4`,I.i32,null),L.mat2x2u=new L(`mat2x2`,I.u32,null),L.mat2x3u=new L(`mat2x3`,I.u32,null),L.mat2x4u=new L(`mat2x4`,I.u32,null),L.mat3x2u=new L(`mat3x2`,I.u32,null),L.mat3x3u=new L(`mat3x3`,I.u32,null),L.mat3x4u=new L(`mat3x4`,I.u32,null),L.mat4x2u=new L(`mat4x2`,I.u32,null),L.mat4x3u=new L(`mat4x3`,I.u32,null),L.mat4x4u=new L(`mat4x4`,I.u32,null);var Ke=class extends I{constructor(e,t,n,r){super(e),this.storage=t,this.type=n,this.access=r}get astNodeType(){return`pointer`}},qe=class extends I{constructor(e,t,n,r){super(e),this.attributes=t,this.format=n,this.count=r}get astNodeType(){return`array`}get isArray(){return!0}},Je=class extends I{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return`sampler`}},Ye=class extends M{constructor(){super(),this.postfix=null}},Xe=class extends Ye{constructor(e){super(),this.value=e}get astNodeType(){return`stringExpr`}toString(){return this.value}constEvaluateString(){return this.value}},Ze=class extends Ye{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return`createExpr`}search(e){if(e(this),this.args)for(let t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}},Qe=class extends Ye{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return`callExpr`}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return ve.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(let t of this.args)t.search(e);e(this)}},$e=class extends Ye{constructor(e){super(),this.name=e}get astNodeType(){return`varExpr`}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}},et=class extends Ye{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return`constExpr`}constEvaluate(e,t){if(this.initializer){let t=e.evalExpression(this.initializer,e.context);return t!==null&&this.postfix?t.getSubData(e,this.postfix,e.context):t}return null}search(e){this.initializer.search(e)}},R=class extends Ye{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return`literalExpr`}constEvaluate(e,t){return t!==void 0&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof B}get isVector(){return this.value instanceof V||this.value instanceof H}get scalarValue(){return this.value instanceof B?this.value.value:(console.error(`Value is not scalar.`),0)}get vectorValue(){return this.value instanceof V||this.value instanceof H?this.value.data:(console.error(`Value is not a vector or matrix.`),new Float32Array)}},tt=class extends Ye{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return`bitcastExpr`}search(e){this.value.search(e)}},nt=class extends Ye{constructor(e){super(),this.index=e}search(e){this.index.search(e)}},rt=class extends Ye{constructor(){super()}},z=class extends rt{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return`unaryOp`}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}},it=class extends rt{constructor(e,t,n){super(),this.operator=e,this.left=t,this.right=n}get astNodeType(){return`binaryOp`}_getPromotedType(e,t){return e.name===t.name?e:e.name===`f32`||t.name===`f32`?I.f32:e.name===`u32`||t.name===`u32`?I.u32:I.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}},at=class extends M{constructor(e){super(),this.body=e}search(e){e(this),this.searchBlock(this.body,e)}},ot=class extends Ye{constructor(){super()}get astNodeType(){return`default`}},st=class extends at{constructor(e,t){super(t),this.selectors=e}get astNodeType(){return`case`}search(e){this.searchBlock(this.body,e)}},ct=class extends at{constructor(e){super(e)}get astNodeType(){return`default`}search(e){this.searchBlock(this.body,e)}},lt=class extends M{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return`argument`}},ut=class extends M{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return`elseif`}search(e){this.condition.search(e),this.searchBlock(this.body,e)}},dt=class extends M{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return`member`}},ft=class extends M{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return`attribute`}},pt=class e{constructor(t,n){this.parent=null,this.typeInfo=t,this.parent=n,this.id=e._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(e,t,n,r){console.error(`SetDataValue: Not implemented for ${this.constructor.name}`)}getSubData(e,t,n){return console.error(`GetDataValue: Not implemented for ${this.constructor.name}`),null}toString(){return`<${this.typeInfo.getTypeName()}>`}};pt._id=0;var mt=class extends pt{constructor(){super(new S(`void`,null),null)}toString(){return`void`}};mt.void=new mt;var ht=class extends pt{constructor(e){super(new E(`pointer`,e.typeInfo,null),null),this.reference=e}clone(){return this}setDataValue(e,t,n,r){this.reference.setDataValue(e,t,n,r)}getSubData(e,t,n){return t?this.reference.getSubData(e,t,n):this}toString(){return`&${this.reference.toString()}`}},B=class e extends pt{constructor(e,t,n=null){super(t,n),e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array?this.data=e:this.typeInfo.name===`x32`?e-Math.floor(e)===0?this.data=e>=0?new Uint32Array([e]):new Int32Array([e]):this.data=new Float32Array([e]):this.typeInfo.name===`i32`||this.typeInfo.name===`bool`?this.data=new Int32Array([e]):this.typeInfo.name===`u32`?this.data=new Uint32Array([e]):this.typeInfo.name===`f32`||this.typeInfo.name===`f16`?this.data=new Float32Array([e]):console.error(`ScalarData2: Invalid type`,t)}clone(){if(this.data instanceof Float32Array)return new e(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new e(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new e(new Uint32Array(this.data),this.typeInfo,null);throw`ScalarData: Invalid data type`}get value(){return this.data[0]}set value(e){this.data[0]=e}setDataValue(t,n,r,i){if(r)return void console.error(`SetDataValue: Scalar data does not support postfix`,r);if(!(n instanceof e))return void console.error(`SetDataValue: Invalid value`,n);let a=n.data[0];this.typeInfo.name===`i32`||this.typeInfo.name===`u32`?a=Math.floor(a):this.typeInfo.name===`bool`&&(a=a?1:0),this.data[0]=a}getSubData(e,t,n){return t?(console.error(`getSubData: Scalar data does not support postfix`,t),null):this}toString(){return`${this.value}`}};function gt(e,t,n){let r=t.length;return r===2?n===`f32`?new V(new Float32Array(t),e.getTypeInfo(`vec2f`)):n===`i32`||n===`bool`?new V(new Int32Array(t),e.getTypeInfo(`vec2i`)):n===`u32`?new V(new Uint32Array(t),e.getTypeInfo(`vec2u`)):n===`f16`?new V(new Float32Array(t),e.getTypeInfo(`vec2h`)):(console.error(`getSubData: Unknown format ${n}`),null):r===3?n===`f32`?new V(new Float32Array(t),e.getTypeInfo(`vec3f`)):n===`i32`||n===`bool`?new V(new Int32Array(t),e.getTypeInfo(`vec3i`)):n===`u32`?new V(new Uint32Array(t),e.getTypeInfo(`vec3u`)):n===`f16`?new V(new Float32Array(t),e.getTypeInfo(`vec3h`)):(console.error(`getSubData: Unknown format ${n}`),null):r===4?n===`f32`?new V(new Float32Array(t),e.getTypeInfo(`vec4f`)):n===`i32`||n===`bool`?new V(new Int32Array(t),e.getTypeInfo(`vec4i`)):n===`u32`?new V(new Uint32Array(t),e.getTypeInfo(`vec4u`)):n===`f16`?new V(new Float32Array(t),e.getTypeInfo(`vec4h`)):(console.error(`getSubData: Unknown format ${n}`),null):(console.error(`getSubData: Invalid vector size ${t.length}`),null)}var V=class e extends pt{constructor(e,t,n=null){if(super(t,n),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.data=e;else{let t=this.typeInfo.name;t===`vec2f`||t===`vec3f`||t===`vec4f`?this.data=new Float32Array(e):t===`vec2i`||t===`vec3i`||t===`vec4i`?this.data=new Int32Array(e):t===`vec2u`||t===`vec3u`||t===`vec4u`?this.data=new Uint32Array(e):t===`vec2h`||t===`vec3h`||t===`vec4h`?this.data=new Float32Array(e):t===`vec2b`||t===`vec3b`||t===`vec4b`?this.data=new Int32Array(e):t===`vec2`||t===`vec3`||t===`vec4`?this.data=new Float32Array(e):console.error(`VectorData: Invalid type ${t}`)}}clone(){if(this.data instanceof Float32Array)return new e(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new e(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new e(new Uint32Array(this.data),this.typeInfo,null);throw`VectorData: Invalid data type`}setDataValue(t,n,r,i){r instanceof Xe?console.error(`TODO: Set vector postfix`):n instanceof e?this.data=n.data:console.error(`SetDataValue: Invalid value`,n)}getSubData(e,t,n){if(t===null)return this;let r=e.getTypeInfo(`f32`);if(this.typeInfo instanceof D)r=this.typeInfo.format||r;else{let t=this.typeInfo.name;t===`vec2f`||t===`vec3f`||t===`vec4f`?r=e.getTypeInfo(`f32`):t===`vec2i`||t===`vec3i`||t===`vec4i`?r=e.getTypeInfo(`i32`):t===`vec2b`||t===`vec3b`||t===`vec4b`?r=e.getTypeInfo(`bool`):t===`vec2u`||t===`vec3u`||t===`vec4u`?r=e.getTypeInfo(`u32`):t===`vec2h`||t===`vec3h`||t===`vec4h`?r=e.getTypeInfo(`f16`):console.error(`GetSubData: Unknown type ${t}`)}let i=this;for(;t!==null&&i!==null;){if(t instanceof nt){let a=t.index,o=-1;if(a instanceof R){if(!(a.value instanceof B))return console.error(`GetSubData: Invalid array index ${a.value}`),null;o=a.value.value}else{let t=e.evalExpression(a,n);if(!(t instanceof B))return console.error(`GetSubData: Unknown index type`,a),null;o=t.value}if(o<0||o>=i.data.length)return console.error(`GetSubData: Index out of range`,o),null;if(i.data instanceof Float32Array){let e=new Float32Array(i.data.buffer,i.data.byteOffset+4*o,1);return new B(e,r)}if(i.data instanceof Int32Array){let e=new Int32Array(i.data.buffer,i.data.byteOffset+4*o,1);return new B(e,r)}if(i.data instanceof Uint32Array){let e=new Uint32Array(i.data.buffer,i.data.byteOffset+4*o,1);return new B(e,r)}throw`GetSubData: Invalid data type`}if(!(t instanceof Xe))return console.error(`GetSubData: Unknown postfix`,t),null;{let n=t.value.toLowerCase();if(n.length===1){let e=0;if(n===`x`||n===`r`)e=0;else if(n===`y`||n===`g`)e=1;else if(n===`z`||n===`b`)e=2;else{if(n!==`w`&&n!==`a`)return console.error(`GetSubData: Unknown member ${n}`),null;e=3}if(this.data instanceof Float32Array){let t=new Float32Array(this.data.buffer,this.data.byteOffset+4*e,1);return new B(t,r,this)}if(this.data instanceof Int32Array){let t=new Int32Array(this.data.buffer,this.data.byteOffset+4*e,1);return new B(t,r,this)}if(this.data instanceof Uint32Array){let t=new Uint32Array(this.data.buffer,this.data.byteOffset+4*e,1);return new B(t,r,this)}}let a=[];for(let e of n)e===`x`||e===`r`?a.push(this.data[0]):e===`y`||e===`g`?a.push(this.data[1]):e===`z`||e===`b`?a.push(this.data[2]):e===`w`||e===`a`?a.push(this.data[3]):console.error(`GetDataValue: Unknown member ${e}`);i=gt(e,a,r.name)}t=t.postfix}return i}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}},H=class e extends pt{constructor(e,t,n=null){super(t,n),e instanceof Float32Array?this.data=e:this.data=new Float32Array(e)}clone(){return new e(new Float32Array(this.data),this.typeInfo,null)}setDataValue(t,n,r,i){r instanceof Xe?console.error(`TODO: Set matrix postfix`):n instanceof e?this.data=n.data:console.error(`SetDataValue: Invalid value`,n)}getSubData(e,t,n){if(t===null)return this;let r=this.typeInfo.name;if(e.getTypeInfo(`f32`),this.typeInfo instanceof D)this.typeInfo.format;else if(r.endsWith(`f`))e.getTypeInfo(`f32`);else if(r.endsWith(`i`))e.getTypeInfo(`i32`);else if(r.endsWith(`u`))e.getTypeInfo(`u32`);else{if(!r.endsWith(`h`))return console.error(`GetDataValue: Unknown type ${r}`),null;e.getTypeInfo(`f16`)}if(t instanceof nt){let i=t.index,a=-1;if(i instanceof R){if(!(i.value instanceof B))return console.error(`GetDataValue: Invalid array index ${i.value}`),null;a=i.value.value}else{let t=e.evalExpression(i,n);if(!(t instanceof B))return console.error(`GetDataValue: Unknown index type`,i),null;a=t.value}if(a<0||a>=this.data.length)return console.error(`GetDataValue: Index out of range`,a),null;let o=r.endsWith(`h`)?`h`:`f`,s;if(r===`mat2x2`||r===`mat2x2f`||r===`mat2x2h`||r===`mat3x2`||r===`mat3x2f`||r===`mat3x2h`||r===`mat4x2`||r===`mat4x2f`||r===`mat4x2h`)s=new V(new Float32Array(this.data.buffer,this.data.byteOffset+8*a,2),e.getTypeInfo(`vec2${o}`));else if(r===`mat2x3`||r===`mat2x3f`||r===`mat2x3h`||r===`mat3x3`||r===`mat3x3f`||r===`mat3x3h`||r===`mat4x3`||r===`mat4x3f`||r===`mat4x3h`)s=new V(new Float32Array(this.data.buffer,this.data.byteOffset+12*a,3),e.getTypeInfo(`vec3${o}`));else{if(r!==`mat2x4`&&r!==`mat2x4f`&&r!==`mat2x4h`&&r!==`mat3x4`&&r!==`mat3x4f`&&r!==`mat3x4h`&&r!==`mat4x4`&&r!==`mat4x4f`&&r!==`mat4x4h`)return console.error(`GetDataValue: Unknown type ${r}`),null;s=new V(new Float32Array(this.data.buffer,this.data.byteOffset+16*a,4),e.getTypeInfo(`vec4${o}`))}return t.postfix?s.getSubData(e,t.postfix,n):s}return console.error(`GetDataValue: Invalid postfix`,t),null}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}},U=class e extends pt{constructor(e,t,n=0,r=null){super(t,r),this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=n}clone(){let t=new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size));return new e(t.buffer,this.typeInfo,0,null)}setDataValue(e,t,n,r){if(t===null)return void console.log(`setDataValue: NULL data.`);let i=this.offset,a=this.typeInfo;for(;n;){if(n instanceof nt)if(a instanceof T){let t=n.index;if(t instanceof R){if(!(t.value instanceof B))return void console.error(`SetDataValue: Invalid index type ${t.value}`);i+=t.value.value*a.stride}else{let n=e.evalExpression(t,r);if(!(n instanceof B))return void console.error(`SetDataValue: Unknown index type`,t);i+=n.value*a.stride}a=a.format}else console.error(`SetDataValue: Type ${a.getTypeName()} is not an array`);else{if(!(n instanceof Xe))return void console.error(`SetDataValue: Unknown postfix type`,n);{let e=n.value;if(a instanceof w){let t=!1;for(let n of a.members)if(n.name===e){i+=n.offset,a=n.type,t=!0;break}if(!t)return void console.error(`SetDataValue: Member ${e} not found`)}else if(a instanceof S){let n=a.getTypeName(),r=0;if(e===`x`||e===`r`)r=0;else if(e===`y`||e===`g`)r=1;else if(e===`z`||e===`b`)r=2;else{if(e!==`w`&&e!==`a`)return void console.error(`SetDataValue: Unknown member ${e}`);r=3}if(!(t instanceof B))return void console.error(`SetDataValue: Invalid value`,t);let o=t.value;n===`vec2f`?new Float32Array(this.buffer,i,2)[r]=o:n===`vec3f`?new Float32Array(this.buffer,i,3)[r]=o:n===`vec4f`?new Float32Array(this.buffer,i,4)[r]=o:n===`vec2i`?new Int32Array(this.buffer,i,2)[r]=o:n===`vec3i`?new Int32Array(this.buffer,i,3)[r]=o:n===`vec4i`?new Int32Array(this.buffer,i,4)[r]=o:n===`vec2u`?new Uint32Array(this.buffer,i,2)[r]=o:n===`vec3u`?new Uint32Array(this.buffer,i,3)[r]=o:n===`vec4u`?new Uint32Array(this.buffer,i,4)[r]=o:console.error(`SetDataValue: Type ${n} is not a struct`);return}}}n=n.postfix}this.setData(e,t,a,i,r)}setData(t,n,r,i,a){let o=r.getTypeName();if(o!==`f32`&&o!==`f16`)if(o!==`i32`&&o!==`atomic<i32>`&&o!==`x32`)if(o!==`u32`&&o!==`atomic<u32>`)if(o!==`bool`){if(o===`vec2f`||o===`vec2h`){let e=new Float32Array(this.buffer,i,2);n instanceof V?(e[0]=n.data[0],e[1]=n.data[1]):(e[0]=n[0],e[1]=n[1]);return}if(o===`vec3f`||o===`vec3h`){let e=new Float32Array(this.buffer,i,3);n instanceof V?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2]):(e[0]=n[0],e[1]=n[1],e[2]=n[2]);return}if(o===`vec4f`||o===`vec4h`){let e=new Float32Array(this.buffer,i,4);n instanceof V?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3]);return}if(o===`vec2i`){let e=new Int32Array(this.buffer,i,2);n instanceof V?(e[0]=n.data[0],e[1]=n.data[1]):(e[0]=n[0],e[1]=n[1]);return}if(o===`vec3i`){let e=new Int32Array(this.buffer,i,3);n instanceof V?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2]):(e[0]=n[0],e[1]=n[1],e[2]=n[2]);return}if(o===`vec4i`){let e=new Int32Array(this.buffer,i,4);n instanceof V?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3]);return}if(o===`vec2u`){let e=new Uint32Array(this.buffer,i,2);n instanceof V?(e[0]=n.data[0],e[1]=n.data[1]):(e[0]=n[0],e[1]=n[1]);return}if(o===`vec3u`){let e=new Uint32Array(this.buffer,i,3);n instanceof V?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2]):(e[0]=n[0],e[1]=n[1],e[2]=n[2]);return}if(o===`vec4u`){let e=new Uint32Array(this.buffer,i,4);n instanceof V?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3]);return}if(o===`vec2b`){let e=new Uint32Array(this.buffer,i,2);n instanceof V?(e[0]=n.data[0],e[1]=n.data[1]):(e[0]=n[0],e[1]=n[1]);return}if(o===`vec3b`){let e=new Uint32Array(this.buffer,i,3);n instanceof V?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2]):(e[0]=n[0],e[1]=n[1],e[2]=n[2]);return}if(o===`vec4b`){let e=new Uint32Array(this.buffer,i,4);n instanceof V?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3]);return}if(o===`mat2x2f`||o===`mat2x2h`){let e=new Float32Array(this.buffer,i,4);n instanceof H?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3]);return}if(o===`mat2x3f`||o===`mat2x3h`){let e=new Float32Array(this.buffer,i,6);n instanceof H?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5]);return}if(o===`mat2x4f`||o===`mat2x4h`){let e=new Float32Array(this.buffer,i,8);n instanceof H?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5],e[6]=n.data[6],e[7]=n.data[7]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7]);return}if(o===`mat3x2f`||o===`mat3x2h`){let e=new Float32Array(this.buffer,i,6);n instanceof H?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5]);return}if(o===`mat3x3f`||o===`mat3x3h`){let e=new Float32Array(this.buffer,i,9);n instanceof H?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5],e[6]=n.data[6],e[7]=n.data[7],e[8]=n.data[8]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8]);return}if(o===`mat3x4f`||o===`mat3x4h`){let e=new Float32Array(this.buffer,i,12);n instanceof H?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5],e[6]=n.data[6],e[7]=n.data[7],e[8]=n.data[8],e[9]=n.data[9],e[10]=n.data[10],e[11]=n.data[11]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11]);return}if(o===`mat4x2f`||o===`mat4x2h`){let e=new Float32Array(this.buffer,i,8);n instanceof H?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5],e[6]=n.data[6],e[7]=n.data[7]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7]);return}if(o===`mat4x3f`||o===`mat4x3h`){let e=new Float32Array(this.buffer,i,12);n instanceof H?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5],e[6]=n.data[6],e[7]=n.data[7],e[8]=n.data[8],e[9]=n.data[9],e[10]=n.data[10],e[11]=n.data[11]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11]);return}if(o===`mat4x4f`||o===`mat4x4h`){let e=new Float32Array(this.buffer,i,16);n instanceof H?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5],e[6]=n.data[6],e[7]=n.data[7],e[8]=n.data[8],e[9]=n.data[9],e[10]=n.data[10],e[11]=n.data[11],e[12]=n.data[12],e[13]=n.data[13],e[14]=n.data[14],e[15]=n.data[15]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15]);return}if(n instanceof e){if(r===n.typeInfo)return void new Uint8Array(this.buffer,i,n.buffer.byteLength).set(new Uint8Array(n.buffer));console.error(`SetDataValue: Type mismatch`,o,n.typeInfo.getTypeName())}else console.error(`SetData: Unknown type ${o}`)}else n instanceof B&&(new Int32Array(this.buffer,i,1)[0]=n.value);else n instanceof B&&(new Uint32Array(this.buffer,i,1)[0]=n.value);else n instanceof B&&(new Int32Array(this.buffer,i,1)[0]=n.value);else n instanceof B&&(new Float32Array(this.buffer,i,1)[0]=n.value)}getSubData(t,n,r){if(n===null)return this;let i=this.offset,a=this.typeInfo;for(;n;){if(n instanceof nt){let e=n.index,o=e instanceof Ye?t.evalExpression(e,r):e,s=0;if(o instanceof B?s=o.value:typeof o==`number`?s=o:console.error(`GetDataValue: Invalid index type`,e),a instanceof T)i+=s*a.stride,a=a.format;else{let e=a.getTypeName();e===`mat4x4`||e===`mat4x4f`||e===`mat4x4h`?(i+=16*s,a=t.getTypeInfo(`vec4f`)):console.error(`getDataValue: Type ${a.getTypeName()} is not an array`)}}else{if(!(n instanceof Xe))return console.error(`GetDataValue: Unknown postfix type`,n),null;{let e=n.value;if(a instanceof w){let t=!1;for(let n of a.members)if(n.name===e){i+=n.offset,a=n.type,t=!0;break}if(!t)return console.error(`GetDataValue: Member ${e} not found`),null}else if(a instanceof S){let n=a.getTypeName();if(n===`vec2f`||n===`vec3f`||n===`vec4f`||n===`vec2i`||n===`vec3i`||n===`vec4i`||n===`vec2u`||n===`vec3u`||n===`vec4u`||n===`vec2b`||n===`vec3b`||n===`vec4b`||n===`vec2h`||n===`vec3h`||n===`vec4h`||n===`vec2`||n===`vec3`||n===`vec4`){if(e.length>0&&e.length<5){let r=`f`,o=[];for(let a=0;a<e.length;++a){let s=e[a].toLowerCase(),c=0;if(s===`x`||s===`r`)c=0;else if(s===`y`||s===`g`)c=1;else if(s===`z`||s===`b`)c=2;else{if(s!==`w`&&s!==`a`)return console.error(`Unknown member ${e}`),null;c=3}if(e.length===1){if(n.endsWith(`f`))return this.buffer.byteLength<i+4*c+4?(console.log(`Insufficient buffer data`),null):new B(new Float32Array(this.buffer,i+4*c,1),t.getTypeInfo(`f32`),this);if(n.endsWith(`h`))return new B(new Float32Array(this.buffer,i+4*c,1),t.getTypeInfo(`f16`),this);if(n.endsWith(`i`))return new B(new Int32Array(this.buffer,i+4*c,1),t.getTypeInfo(`i32`),this);if(n.endsWith(`b`))return new B(new Int32Array(this.buffer,i+4*c,1),t.getTypeInfo(`bool`),this);if(n.endsWith(`u`))return new B(new Uint32Array(this.buffer,i+4*c,1),t.getTypeInfo(`i32`),this)}if(n===`vec2f`)o.push(new Float32Array(this.buffer,i,2)[c]);else if(n===`vec3f`){if(i+12>=this.buffer.byteLength)return console.log(`Insufficient buffer data`),null;let e=new Float32Array(this.buffer,i,3);o.push(e[c])}else if(n===`vec4f`)o.push(new Float32Array(this.buffer,i,4)[c]);else if(n===`vec2i`)r=`i`,o.push(new Int32Array(this.buffer,i,2)[c]);else if(n===`vec3i`)r=`i`,o.push(new Int32Array(this.buffer,i,3)[c]);else if(n===`vec4i`)r=`i`,o.push(new Int32Array(this.buffer,i,4)[c]);else if(n===`vec2u`){r=`u`;let e=new Uint32Array(this.buffer,i,2);o.push(e[c])}else n===`vec3u`?(r=`u`,o.push(new Uint32Array(this.buffer,i,3)[c])):n===`vec4u`&&(r=`u`,o.push(new Uint32Array(this.buffer,i,4)[c]))}return o.length===2?a=t.getTypeInfo(`vec2${r}`):o.length===3?a=t.getTypeInfo(`vec3${r}`):o.length===4?a=t.getTypeInfo(`vec4${r}`):console.error(`GetDataValue: Invalid vector length ${o.length}`),new V(o,a,null)}return console.error(`GetDataValue: Unknown member ${e}`),null}return console.error(`GetDataValue: Type ${n} is not a struct`),null}}}n=n.postfix}let o=a.getTypeName();return o===`f32`?new B(new Float32Array(this.buffer,i,1),a,this):o===`i32`?new B(new Int32Array(this.buffer,i,1),a,this):o===`u32`?new B(new Uint32Array(this.buffer,i,1),a,this):o===`vec2f`?new V(new Float32Array(this.buffer,i,2),a,this):o===`vec3f`?new V(new Float32Array(this.buffer,i,3),a,this):o===`vec4f`?new V(new Float32Array(this.buffer,i,4),a,this):o===`vec2i`?new V(new Int32Array(this.buffer,i,2),a,this):o===`vec3i`?new V(new Int32Array(this.buffer,i,3),a,this):o===`vec4i`?new V(new Int32Array(this.buffer,i,4),a,this):o===`vec2u`?new V(new Uint32Array(this.buffer,i,2),a,this):o===`vec3u`?new V(new Uint32Array(this.buffer,i,3),a,this):o===`vec4u`?new V(new Uint32Array(this.buffer,i,4),a,this):a instanceof D&&a.name===`atomic`?a.format?.name===`u32`?new B(new Uint32Array(this.buffer,i,1)[0],a.format,this):a.format?.name===`i32`?new B(new Int32Array(this.buffer,i,1)[0],a.format,this):(console.error(`GetDataValue: Invalid atomic format ${a.format?.name}`),null):new e(this.buffer,a,i,this)}toString(){let e=``;if(this.typeInfo instanceof T)if(this.typeInfo.format.name===`f32`){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name===`i32`){let t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name===`u32`){let t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name===`vec2f`){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let n=1;n<t.length/2;++n)e+=`, [${t[2*n]}, ${t[2*n+1]}]`}else if(this.typeInfo.format.name===`vec3f`){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}]`}else if(this.typeInfo.format.name===`vec4f`){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}, ${t[n+3]}]`}else e=`[...]`;else this.typeInfo instanceof w?e+=`{...}`:e=`[...]`;return e}},_t=class e extends pt{constructor(e,t,n,r){super(t,null),this.data=e,this.descriptor=n,this.view=r}clone(){return new e(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var e;let t=this.descriptor.size;return t instanceof Array&&t.length>0?t[0]??0:t instanceof Object&&(e=t.width)!=null?e:0}get height(){var e;let t=this.descriptor.size;return t instanceof Array&&t.length>1?t[1]??0:t instanceof Object&&(e=t.height)!=null?e:0}get depthOrArrayLayers(){var e;let t=this.descriptor.size;return t instanceof Array&&t.length>2?t[2]??0:t instanceof Object&&(e=t.depthOrArrayLayers)!=null?e:0}get format(){var e;return this.descriptor&&(e=this.descriptor.format)!=null?e:`rgba8unorm`}get sampleCount(){var e;return this.descriptor&&(e=this.descriptor.sampleCount)!=null?e:1}get mipLevelCount(){var e;return this.descriptor&&(e=this.descriptor.mipLevelCount)!=null?e:1}get dimension(){var e;return this.descriptor&&(e=this.descriptor.dimension)!=null?e:`2d`}getMipLevelSize(e){if(e>=this.mipLevelCount)return[0,0,0];let t=[this.width,this.height,this.depthOrArrayLayers];for(let n=0;n<t.length;++n)t[n]=Math.max(1,t[n]>>e);return t}get texelByteSize(){let e=this.format,t=he[e];return t?t.isDepthStencil?4:t.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){let e=this.format,t=he[e];return!!t&&t.isDepthStencil}getGpuSize(){let e=this.format,t=he[e],n=this.width;if(!e||n<=0||!t)return-1;let r=this.height,i=this.depthOrArrayLayers,a=this.dimension;return n/t.blockWidth*(a===`1d`?1:r/t.blockHeight)*t.bytesPerBlock*i}getPixel(e,t,n=0,r=0){let i=this.texelByteSize,a=this.bytesPerRow,o=this.height,s=this.data[r];return((e,t,n,r,i,a,o,s)=>{let c=r*(o>>=i)*(a>>=i)+n*o+t*s;switch(this.format){case`r8unorm`:return[A(e,c,`8unorm`,1)[0]];case`r8snorm`:return[A(e,c,`8snorm`,1)[0]];case`r8uint`:return[A(e,c,`8uint`,1)[0]];case`r8sint`:return[A(e,c,`8sint`,1)[0]];case`rg8unorm`:{let t=A(e,c,`8unorm`,2);return[t[0],t[1]]}case`rg8snorm`:{let t=A(e,c,`8snorm`,2);return[t[0],t[1]]}case`rg8uint`:{let t=A(e,c,`8uint`,2);return[t[0],t[1]]}case`rg8sint`:{let t=A(e,c,`8sint`,2);return[t[0],t[1]]}case`rgba8unorm-srgb`:case`rgba8unorm`:{let t=A(e,c,`8unorm`,4);return[t[0],t[1],t[2],t[3]]}case`rgba8snorm`:{let t=A(e,c,`8snorm`,4);return[t[0],t[1],t[2],t[3]]}case`rgba8uint`:{let t=A(e,c,`8uint`,4);return[t[0],t[1],t[2],t[3]]}case`rgba8sint`:{let t=A(e,c,`8sint`,4);return[t[0],t[1],t[2],t[3]]}case`bgra8unorm-srgb`:case`bgra8unorm`:{let t=A(e,c,`8unorm`,4);return[t[2],t[1],t[0],t[3]]}case`r16uint`:return[A(e,c,`16uint`,1)[0]];case`r16sint`:return[A(e,c,`16sint`,1)[0]];case`r16float`:return[A(e,c,`16float`,1)[0]];case`rg16uint`:{let t=A(e,c,`16uint`,2);return[t[0],t[1]]}case`rg16sint`:{let t=A(e,c,`16sint`,2);return[t[0],t[1]]}case`rg16float`:{let t=A(e,c,`16float`,2);return[t[0],t[1]]}case`rgba16uint`:{let t=A(e,c,`16uint`,4);return[t[0],t[1],t[2],t[3]]}case`rgba16sint`:{let t=A(e,c,`16sint`,4);return[t[0],t[1],t[2],t[3]]}case`rgba16float`:{let t=A(e,c,`16float`,4);return[t[0],t[1],t[2],t[3]]}case`r32uint`:return[A(e,c,`32uint`,1)[0]];case`r32sint`:return[A(e,c,`32sint`,1)[0]];case`depth16unorm`:case`depth24plus`:case`depth24plus-stencil8`:case`depth32float`:case`depth32float-stencil8`:case`r32float`:return[A(e,c,`32float`,1)[0]];case`rg32uint`:{let t=A(e,c,`32uint`,2);return[t[0],t[1]]}case`rg32sint`:{let t=A(e,c,`32sint`,2);return[t[0],t[1]]}case`rg32float`:{let t=A(e,c,`32float`,2);return[t[0],t[1]]}case`rgba32uint`:{let t=A(e,c,`32uint`,4);return[t[0],t[1],t[2],t[3]]}case`rgba32sint`:{let t=A(e,c,`32sint`,4);return[t[0],t[1],t[2],t[3]]}case`rgba32float`:{let t=A(e,c,`32float`,4);return[t[0],t[1],t[2],t[3]]}case`rg11b10ufloat`:{let t=new Uint32Array(e.buffer,c,1)[0],n=(4192256&t)>>11,r=(4290772992&t)>>22;return[me(2047&t),me(n),(e=>(fe[0]=112+(e>>5&31)<<23|(31&e)<<18,pe[0]))(r),1]}}return null})(new Uint8Array(s),e,t,n,r,o,a,i)}setPixel(e,t,n,r,i){let a=this.texelByteSize,o=this.bytesPerRow,s=this.height,c=this.data[r];((e,t,n,r,i,a,o,s,c,l)=>{let u=r*(o>>=i)*(a>>=i)+n*o+t*s;switch(c){case`r8unorm`:j(e,u,`8unorm`,1,l);return;case`r8snorm`:j(e,u,`8snorm`,1,l);return;case`r8uint`:j(e,u,`8uint`,1,l);return;case`r8sint`:j(e,u,`8sint`,1,l);return;case`rg8unorm`:j(e,u,`8unorm`,2,l);return;case`rg8snorm`:j(e,u,`8snorm`,2,l);return;case`rg8uint`:j(e,u,`8uint`,2,l);return;case`rg8sint`:j(e,u,`8sint`,2,l);return;case`rgba8unorm-srgb`:case`rgba8unorm`:case`bgra8unorm-srgb`:case`bgra8unorm`:j(e,u,`8unorm`,4,l);return;case`rgba8snorm`:j(e,u,`8snorm`,4,l);return;case`rgba8uint`:j(e,u,`8uint`,4,l);return;case`rgba8sint`:j(e,u,`8sint`,4,l);return;case`r16uint`:j(e,u,`16uint`,1,l);return;case`r16sint`:j(e,u,`16sint`,1,l);return;case`r16float`:j(e,u,`16float`,1,l);return;case`rg16uint`:j(e,u,`16uint`,2,l);return;case`rg16sint`:j(e,u,`16sint`,2,l);return;case`rg16float`:j(e,u,`16float`,2,l);return;case`rgba16uint`:j(e,u,`16uint`,4,l);return;case`rgba16sint`:j(e,u,`16sint`,4,l);return;case`rgba16float`:j(e,u,`16float`,4,l);return;case`r32uint`:j(e,u,`32uint`,1,l);return;case`r32sint`:j(e,u,`32sint`,1,l);return;case`depth16unorm`:case`depth24plus`:case`depth24plus-stencil8`:case`depth32float`:case`depth32float-stencil8`:case`r32float`:j(e,u,`32float`,1,l);return;case`rg32uint`:j(e,u,`32uint`,2,l);return;case`rg32sint`:j(e,u,`32sint`,2,l);return;case`rg32float`:j(e,u,`32float`,2,l);return;case`rgba32uint`:j(e,u,`32uint`,4,l);return;case`rgba32sint`:j(e,u,`32sint`,4,l);return;case`rgba32float`:j(e,u,`32float`,4,l);return;case`rg11b10ufloat`:console.error(`TODO: rg11b10ufloat not supported for writing`)}})(new Uint8Array(c),e,t,n,r,s,o,a,this.format,i)}};(e=>{e[e.token=0]=`token`,e[e.keyword=1]=`keyword`,e[e.reserved=2]=`reserved`})(F||={});var W=class{constructor(e,t,n){this.name=e,this.type=t,this.rule=n}toString(){return this.name}},G=class{};P=G,G.none=new W(``,F.reserved,``),G.eof=new W(`EOF`,F.token,``),G.reserved={asm:new W(`asm`,F.reserved,`asm`),bf16:new W(`bf16`,F.reserved,`bf16`),do:new W(`do`,F.reserved,`do`),enum:new W(`enum`,F.reserved,`enum`),f16:new W(`f16`,F.reserved,`f16`),f64:new W(`f64`,F.reserved,`f64`),handle:new W(`handle`,F.reserved,`handle`),i8:new W(`i8`,F.reserved,`i8`),i16:new W(`i16`,F.reserved,`i16`),i64:new W(`i64`,F.reserved,`i64`),mat:new W(`mat`,F.reserved,`mat`),premerge:new W(`premerge`,F.reserved,`premerge`),regardless:new W(`regardless`,F.reserved,`regardless`),typedef:new W(`typedef`,F.reserved,`typedef`),u8:new W(`u8`,F.reserved,`u8`),u16:new W(`u16`,F.reserved,`u16`),u64:new W(`u64`,F.reserved,`u64`),unless:new W(`unless`,F.reserved,`unless`),using:new W(`using`,F.reserved,`using`),vec:new W(`vec`,F.reserved,`vec`),void:new W(`void`,F.reserved,`void`)},G.keywords={array:new W(`array`,F.keyword,`array`),atomic:new W(`atomic`,F.keyword,`atomic`),bool:new W(`bool`,F.keyword,`bool`),f32:new W(`f32`,F.keyword,`f32`),i32:new W(`i32`,F.keyword,`i32`),mat2x2:new W(`mat2x2`,F.keyword,`mat2x2`),mat2x3:new W(`mat2x3`,F.keyword,`mat2x3`),mat2x4:new W(`mat2x4`,F.keyword,`mat2x4`),mat3x2:new W(`mat3x2`,F.keyword,`mat3x2`),mat3x3:new W(`mat3x3`,F.keyword,`mat3x3`),mat3x4:new W(`mat3x4`,F.keyword,`mat3x4`),mat4x2:new W(`mat4x2`,F.keyword,`mat4x2`),mat4x3:new W(`mat4x3`,F.keyword,`mat4x3`),mat4x4:new W(`mat4x4`,F.keyword,`mat4x4`),ptr:new W(`ptr`,F.keyword,`ptr`),sampler:new W(`sampler`,F.keyword,`sampler`),sampler_comparison:new W(`sampler_comparison`,F.keyword,`sampler_comparison`),struct:new W(`struct`,F.keyword,`struct`),texture_1d:new W(`texture_1d`,F.keyword,`texture_1d`),texture_2d:new W(`texture_2d`,F.keyword,`texture_2d`),texture_2d_array:new W(`texture_2d_array`,F.keyword,`texture_2d_array`),texture_3d:new W(`texture_3d`,F.keyword,`texture_3d`),texture_cube:new W(`texture_cube`,F.keyword,`texture_cube`),texture_cube_array:new W(`texture_cube_array`,F.keyword,`texture_cube_array`),texture_multisampled_2d:new W(`texture_multisampled_2d`,F.keyword,`texture_multisampled_2d`),texture_storage_1d:new W(`texture_storage_1d`,F.keyword,`texture_storage_1d`),texture_storage_2d:new W(`texture_storage_2d`,F.keyword,`texture_storage_2d`),texture_storage_2d_array:new W(`texture_storage_2d_array`,F.keyword,`texture_storage_2d_array`),texture_storage_3d:new W(`texture_storage_3d`,F.keyword,`texture_storage_3d`),texture_depth_2d:new W(`texture_depth_2d`,F.keyword,`texture_depth_2d`),texture_depth_2d_array:new W(`texture_depth_2d_array`,F.keyword,`texture_depth_2d_array`),texture_depth_cube:new W(`texture_depth_cube`,F.keyword,`texture_depth_cube`),texture_depth_cube_array:new W(`texture_depth_cube_array`,F.keyword,`texture_depth_cube_array`),texture_depth_multisampled_2d:new W(`texture_depth_multisampled_2d`,F.keyword,`texture_depth_multisampled_2d`),texture_external:new W(`texture_external`,F.keyword,`texture_external`),u32:new W(`u32`,F.keyword,`u32`),vec2:new W(`vec2`,F.keyword,`vec2`),vec3:new W(`vec3`,F.keyword,`vec3`),vec4:new W(`vec4`,F.keyword,`vec4`),bitcast:new W(`bitcast`,F.keyword,`bitcast`),block:new W(`block`,F.keyword,`block`),break:new W(`break`,F.keyword,`break`),case:new W(`case`,F.keyword,`case`),continue:new W(`continue`,F.keyword,`continue`),continuing:new W(`continuing`,F.keyword,`continuing`),default:new W(`default`,F.keyword,`default`),diagnostic:new W(`diagnostic`,F.keyword,`diagnostic`),discard:new W(`discard`,F.keyword,`discard`),else:new W(`else`,F.keyword,`else`),enable:new W(`enable`,F.keyword,`enable`),fallthrough:new W(`fallthrough`,F.keyword,`fallthrough`),false:new W(`false`,F.keyword,`false`),fn:new W(`fn`,F.keyword,`fn`),for:new W(`for`,F.keyword,`for`),function:new W(`function`,F.keyword,`function`),if:new W(`if`,F.keyword,`if`),let:new W(`let`,F.keyword,`let`),const:new W(`const`,F.keyword,`const`),loop:new W(`loop`,F.keyword,`loop`),while:new W(`while`,F.keyword,`while`),private:new W(`private`,F.keyword,`private`),read:new W(`read`,F.keyword,`read`),read_write:new W(`read_write`,F.keyword,`read_write`),return:new W(`return`,F.keyword,`return`),requires:new W(`requires`,F.keyword,`requires`),storage:new W(`storage`,F.keyword,`storage`),switch:new W(`switch`,F.keyword,`switch`),true:new W(`true`,F.keyword,`true`),alias:new W(`alias`,F.keyword,`alias`),type:new W(`type`,F.keyword,`type`),uniform:new W(`uniform`,F.keyword,`uniform`),var:new W(`var`,F.keyword,`var`),override:new W(`override`,F.keyword,`override`),workgroup:new W(`workgroup`,F.keyword,`workgroup`),write:new W(`write`,F.keyword,`write`),r8unorm:new W(`r8unorm`,F.keyword,`r8unorm`),r8snorm:new W(`r8snorm`,F.keyword,`r8snorm`),r8uint:new W(`r8uint`,F.keyword,`r8uint`),r8sint:new W(`r8sint`,F.keyword,`r8sint`),r16uint:new W(`r16uint`,F.keyword,`r16uint`),r16sint:new W(`r16sint`,F.keyword,`r16sint`),r16float:new W(`r16float`,F.keyword,`r16float`),rg8unorm:new W(`rg8unorm`,F.keyword,`rg8unorm`),rg8snorm:new W(`rg8snorm`,F.keyword,`rg8snorm`),rg8uint:new W(`rg8uint`,F.keyword,`rg8uint`),rg8sint:new W(`rg8sint`,F.keyword,`rg8sint`),r32uint:new W(`r32uint`,F.keyword,`r32uint`),r32sint:new W(`r32sint`,F.keyword,`r32sint`),r32float:new W(`r32float`,F.keyword,`r32float`),rg16uint:new W(`rg16uint`,F.keyword,`rg16uint`),rg16sint:new W(`rg16sint`,F.keyword,`rg16sint`),rg16float:new W(`rg16float`,F.keyword,`rg16float`),rgba8unorm:new W(`rgba8unorm`,F.keyword,`rgba8unorm`),rgba8unorm_srgb:new W(`rgba8unorm_srgb`,F.keyword,`rgba8unorm_srgb`),rgba8snorm:new W(`rgba8snorm`,F.keyword,`rgba8snorm`),rgba8uint:new W(`rgba8uint`,F.keyword,`rgba8uint`),rgba8sint:new W(`rgba8sint`,F.keyword,`rgba8sint`),bgra8unorm:new W(`bgra8unorm`,F.keyword,`bgra8unorm`),bgra8unorm_srgb:new W(`bgra8unorm_srgb`,F.keyword,`bgra8unorm_srgb`),rgb10a2unorm:new W(`rgb10a2unorm`,F.keyword,`rgb10a2unorm`),rg11b10float:new W(`rg11b10float`,F.keyword,`rg11b10float`),rg32uint:new W(`rg32uint`,F.keyword,`rg32uint`),rg32sint:new W(`rg32sint`,F.keyword,`rg32sint`),rg32float:new W(`rg32float`,F.keyword,`rg32float`),rgba16uint:new W(`rgba16uint`,F.keyword,`rgba16uint`),rgba16sint:new W(`rgba16sint`,F.keyword,`rgba16sint`),rgba16float:new W(`rgba16float`,F.keyword,`rgba16float`),rgba32uint:new W(`rgba32uint`,F.keyword,`rgba32uint`),rgba32sint:new W(`rgba32sint`,F.keyword,`rgba32sint`),rgba32float:new W(`rgba32float`,F.keyword,`rgba32float`),static_assert:new W(`static_assert`,F.keyword,`static_assert`)},G.tokens={decimal_float_literal:new W(`decimal_float_literal`,F.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new W(`hex_float_literal`,F.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new W(`int_literal`,F.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new W(`uint_literal`,F.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new W(`name`,F.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new W(`ident`,F.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new W(`and`,F.token,`&`),and_and:new W(`and_and`,F.token,`&&`),arrow:new W(`arrow `,F.token,`->`),attr:new W(`attr`,F.token,`@`),forward_slash:new W(`forward_slash`,F.token,`/`),bang:new W(`bang`,F.token,`!`),bracket_left:new W(`bracket_left`,F.token,`[`),bracket_right:new W(`bracket_right`,F.token,`]`),brace_left:new W(`brace_left`,F.token,`{`),brace_right:new W(`brace_right`,F.token,`}`),colon:new W(`colon`,F.token,`:`),comma:new W(`comma`,F.token,`,`),equal:new W(`equal`,F.token,`=`),equal_equal:new W(`equal_equal`,F.token,`==`),not_equal:new W(`not_equal`,F.token,`!=`),greater_than:new W(`greater_than`,F.token,`>`),greater_than_equal:new W(`greater_than_equal`,F.token,`>=`),shift_right:new W(`shift_right`,F.token,`>>`),less_than:new W(`less_than`,F.token,`<`),less_than_equal:new W(`less_than_equal`,F.token,`<=`),shift_left:new W(`shift_left`,F.token,`<<`),modulo:new W(`modulo`,F.token,`%`),minus:new W(`minus`,F.token,`-`),minus_minus:new W(`minus_minus`,F.token,`--`),period:new W(`period`,F.token,`.`),plus:new W(`plus`,F.token,`+`),plus_plus:new W(`plus_plus`,F.token,`++`),or:new W(`or`,F.token,`|`),or_or:new W(`or_or`,F.token,`||`),paren_left:new W(`paren_left`,F.token,`(`),paren_right:new W(`paren_right`,F.token,`)`),semicolon:new W(`semicolon`,F.token,`;`),star:new W(`star`,F.token,`*`),tilde:new W(`tilde`,F.token,`~`),underscore:new W(`underscore`,F.token,`_`),xor:new W(`xor`,F.token,`^`),plus_equal:new W(`plus_equal`,F.token,`+=`),minus_equal:new W(`minus_equal`,F.token,`-=`),times_equal:new W(`times_equal`,F.token,`*=`),division_equal:new W(`division_equal`,F.token,`/=`),modulo_equal:new W(`modulo_equal`,F.token,`%=`),and_equal:new W(`and_equal`,F.token,`&=`),or_equal:new W(`or_equal`,F.token,`|=`),xor_equal:new W(`xor_equal`,F.token,`^=`),shift_right_equal:new W(`shift_right_equal`,F.token,`>>=`),shift_left_equal:new W(`shift_left_equal`,F.token,`<<=`)},G.simpleTokens={"@":P.tokens.attr,"{":P.tokens.brace_left,"}":P.tokens.brace_right,":":P.tokens.colon,",":P.tokens.comma,"(":P.tokens.paren_left,")":P.tokens.paren_right,";":P.tokens.semicolon},G.literalTokens={"&":P.tokens.and,"&&":P.tokens.and_and,"->":P.tokens.arrow,"/":P.tokens.forward_slash,"!":P.tokens.bang,"[":P.tokens.bracket_left,"]":P.tokens.bracket_right,"=":P.tokens.equal,"==":P.tokens.equal_equal,"!=":P.tokens.not_equal,">":P.tokens.greater_than,">=":P.tokens.greater_than_equal,">>":P.tokens.shift_right,"<":P.tokens.less_than,"<=":P.tokens.less_than_equal,"<<":P.tokens.shift_left,"%":P.tokens.modulo,"-":P.tokens.minus,"--":P.tokens.minus_minus,".":P.tokens.period,"+":P.tokens.plus,"++":P.tokens.plus_plus,"|":P.tokens.or,"||":P.tokens.or_or,"*":P.tokens.star,"~":P.tokens.tilde,_:P.tokens.underscore,"^":P.tokens.xor,"+=":P.tokens.plus_equal,"-=":P.tokens.minus_equal,"*=":P.tokens.times_equal,"/=":P.tokens.division_equal,"%=":P.tokens.modulo_equal,"&=":P.tokens.and_equal,"|=":P.tokens.or_equal,"^=":P.tokens.xor_equal,">>=":P.tokens.shift_right_equal,"<<=":P.tokens.shift_left_equal},G.regexTokens={decimal_float_literal:P.tokens.decimal_float_literal,hex_float_literal:P.tokens.hex_float_literal,int_literal:P.tokens.int_literal,uint_literal:P.tokens.uint_literal,ident:P.tokens.ident},G.storage_class=[P.keywords.function,P.keywords.private,P.keywords.workgroup,P.keywords.uniform,P.keywords.storage],G.access_mode=[P.keywords.read,P.keywords.write,P.keywords.read_write],G.sampler_type=[P.keywords.sampler,P.keywords.sampler_comparison],G.sampled_texture_type=[P.keywords.texture_1d,P.keywords.texture_2d,P.keywords.texture_2d_array,P.keywords.texture_3d,P.keywords.texture_cube,P.keywords.texture_cube_array],G.multisampled_texture_type=[P.keywords.texture_multisampled_2d],G.storage_texture_type=[P.keywords.texture_storage_1d,P.keywords.texture_storage_2d,P.keywords.texture_storage_2d_array,P.keywords.texture_storage_3d],G.depth_texture_type=[P.keywords.texture_depth_2d,P.keywords.texture_depth_2d_array,P.keywords.texture_depth_cube,P.keywords.texture_depth_cube_array,P.keywords.texture_depth_multisampled_2d],G.texture_external_type=[P.keywords.texture_external],G.any_texture_type=[...P.sampled_texture_type,...P.multisampled_texture_type,...P.storage_texture_type,...P.depth_texture_type,...P.texture_external_type],G.texel_format=[P.keywords.r8unorm,P.keywords.r8snorm,P.keywords.r8uint,P.keywords.r8sint,P.keywords.r16uint,P.keywords.r16sint,P.keywords.r16float,P.keywords.rg8unorm,P.keywords.rg8snorm,P.keywords.rg8uint,P.keywords.rg8sint,P.keywords.r32uint,P.keywords.r32sint,P.keywords.r32float,P.keywords.rg16uint,P.keywords.rg16sint,P.keywords.rg16float,P.keywords.rgba8unorm,P.keywords.rgba8unorm_srgb,P.keywords.rgba8snorm,P.keywords.rgba8uint,P.keywords.rgba8sint,P.keywords.bgra8unorm,P.keywords.bgra8unorm_srgb,P.keywords.rgb10a2unorm,P.keywords.rg11b10float,P.keywords.rg32uint,P.keywords.rg32sint,P.keywords.rg32float,P.keywords.rgba16uint,P.keywords.rgba16sint,P.keywords.rgba16float,P.keywords.rgba32uint,P.keywords.rgba32sint,P.keywords.rgba32float],G.const_literal=[P.tokens.int_literal,P.tokens.uint_literal,P.tokens.decimal_float_literal,P.tokens.hex_float_literal,P.keywords.true,P.keywords.false],G.literal_or_ident=[P.tokens.ident,P.tokens.int_literal,P.tokens.uint_literal,P.tokens.decimal_float_literal,P.tokens.hex_float_literal,P.tokens.name],G.element_count_expression=[P.tokens.int_literal,P.tokens.uint_literal,P.tokens.ident],G.template_types=[P.keywords.vec2,P.keywords.vec3,P.keywords.vec4,P.keywords.mat2x2,P.keywords.mat2x3,P.keywords.mat2x4,P.keywords.mat3x2,P.keywords.mat3x3,P.keywords.mat3x4,P.keywords.mat4x2,P.keywords.mat4x3,P.keywords.mat4x4,P.keywords.atomic,P.keywords.bitcast,...P.any_texture_type],G.attribute_name=[P.tokens.ident,P.keywords.block,P.keywords.diagnostic],G.assignment_operators=[P.tokens.equal,P.tokens.plus_equal,P.tokens.minus_equal,P.tokens.times_equal,P.tokens.division_equal,P.tokens.modulo_equal,P.tokens.and_equal,P.tokens.or_equal,P.tokens.xor_equal,P.tokens.shift_right_equal,P.tokens.shift_left_equal],G.increment_operators=[P.tokens.plus_plus,P.tokens.minus_minus];var vt=class{constructor(e,t,n,r,i){this.type=e,this.lexeme=t,this.line=n,this.start=r,this.end=i}toString(){return this.lexeme}isTemplateType(){return G.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==G.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}},yt=class{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??``}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new vt(G.eof,``,this._line,this._current,this._current)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e==`/`){if(this._peekAhead()==`/`){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if(this._peekAhead()==`*`){this._advance();let t=1;for(;t>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e==`*`){if(this._peekAhead()==`/`&&(this._advance(),t--,t==0))return!0}else e==`/`&&this._peekAhead()==`*`&&(this._advance(),t++)}return!0}}let t=G.simpleTokens[e];if(t)return this._addToken(t),!0;let n=G.none,r=this._isAlpha(e),i=e===`_`;if(this._isAlphaNumeric(e)){let t=this._peekAhead();for(;this._isAlphaNumeric(t);)e+=this._advance(),t=this._peekAhead()}if(r){let t=G.keywords[e];if(t)return this._addToken(t),!0}if(r||i)return this._addToken(G.tokens.ident),!0;for(;;){let t=this._findType(e),r=this._peekAhead();if(e==`-`&&this._tokens.length>0){if(r==`=`)return this._current++,e+=r,this._addToken(G.tokens.minus_equal),!0;if(r==`-`)return this._current++,e+=r,this._addToken(G.tokens.minus_minus),!0;let n=this._tokens.length-1;if((G.literal_or_ident.indexOf(this._tokens[n].type)!=-1||this._tokens[n].type==G.tokens.paren_right)&&r!=`>`)return this._addToken(t),!0}if(e==`>`&&(r==`>`||r==`=`)){let e=!1,n=this._tokens.length-1;for(let t=0;t<5&&n>=0&&G.assignment_operators.indexOf(this._tokens[n].type)===-1;++t,--n)if(this._tokens[n].type===G.tokens.less_than){n>0&&this._tokens[n-1].isArrayOrTemplateType()&&(e=!0);break}if(e)return this._addToken(t),!0}if(t===G.none){let r=e,i=0;for(let e=0;e<2;++e)if(r+=this._peekAhead(e),t=this._findType(r),t!==G.none){i=e;break}if(t===G.none)return n!==G.none&&(this._current--,this._addToken(n),!0);e=r,this._current+=i+1}if(n=t,this._isAtEnd())break;e+=this._advance()}return n!==G.none&&(this._addToken(n),!0)}_findType(e){for(let t in G.regexTokens){let n=G.regexTokens[t];if(this._match(e,n.rule))return n}return G.literalTokens[e]||G.none}_match(e,t){let n=t.exec(e);return n&&n.index==0&&n[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return!this._isNumeric(e)&&!this._isWhitespace(e)&&e!==`_`&&e!==`.`&&e!==`(`&&e!==`)`&&e!==`[`&&e!==`]`&&e!==`{`&&e!==`}`&&e!==`,`&&e!==`;`&&e!==`:`&&e!==`=`&&e!==`!`&&e!==`<`&&e!==`>`&&e!==`+`&&e!==`-`&&e!==`*`&&e!==`/`&&e!==`%`&&e!==`&`&&e!==`|`&&e!==`^`&&e!==`~`&&e!==`@`&&e!==`#`&&e!==`?`&&e!==`'`&&e!=="`"&&e!==`"`&&e!==`\\`&&e!==`
`&&e!==`\r`&&e!==`	`&&e!==`\0`}_isNumeric(e){return e>=`0`&&e<=`9`}_isAlphaNumeric(e){return this._isAlpha(e)||this._isNumeric(e)||e===`_`}_isWhitespace(e){return e==` `||e==`	`||e==`\r`}_advance(e=0){let t=this._source[this._current];return e||=0,e++,this._current+=e,t}_peekAhead(e=0){return e||=0,this._current+e>=this._source.length?`\0`:this._source[this._current+e]}_addToken(e){let t=this._source.substring(this._start,this._current);this._tokens.push(new vt(e,t,this._line,this._start,this._current))}};function K(e){return Array.isArray(e)||e?.buffer instanceof ArrayBuffer}var bt=new Float32Array(1),xt=new Uint32Array(bt.buffer),St=new Uint32Array(bt.buffer),Ct=new Int32Array(1),wt=new Float32Array(Ct.buffer),Tt=new Uint32Array(Ct.buffer),Et=new Uint32Array(1),Dt=new Float32Array(Et.buffer),Ot=new Int32Array(Et.buffer);function kt(e,t,n){if(t===n)return e;if(t===`f32`){if(n===`i32`||n===`x32`)return bt[0]=e,xt[0];if(n===`u32`)return bt[0]=e,St[0]}else if(t===`i32`||t===`x32`){if(n===`f32`)return Ct[0]=e,wt[0];if(n===`u32`)return Ct[0]=e,Tt[0]}else if(t===`u32`){if(n===`f32`)return Et[0]=e,Dt[0];if(n===`i32`||n===`x32`)return Et[0]=e,Ot[0]}return console.error(`Unsupported cast from ${t} to ${n}`),e}var At=class{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}},jt=class{constructor(e,t){this.align=e,this.size=t}},Mt=class e{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new se,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return e.name==`texture_storage_1d`||e.name==`texture_storage_2d`||e.name==`texture_storage_2d_array`||e.name==`texture_storage_3d`}updateAST(e){for(let t of e)t instanceof ye&&this._functions.set(t.name,new At(t));for(let t of e)if(t instanceof Ge){let e=this.getTypeInfo(t,null);e instanceof w&&this.structs.push(e)}for(let t of e)if(t instanceof Be)this.aliases.push(this._getAliasInfo(t));else{if(t instanceof Te){let e=t,n=this._getAttributeNum(e.attributes,`id`,0),r=e.type==null?null:this.getTypeInfo(e.type,e.attributes);this.overrides.push(new ie(e.name,r,e.attributes,n));continue}if(this._isUniformVar(t)){let e=t,n=this._getAttributeNum(e.attributes,`group`,0),r=this._getAttributeNum(e.attributes,`binding`,0),i=this.getTypeInfo(e.type,e.attributes),a=new ee(e.name,i,n,r,e.attributes,O.Uniform,e.access);a.access||=`read`,this.uniforms.push(a);continue}if(this._isStorageVar(t)){let e=t,n=this._getAttributeNum(e.attributes,`group`,0),r=this._getAttributeNum(e.attributes,`binding`,0),i=this.getTypeInfo(e.type,e.attributes),a=this._isStorageTexture(i),o=new ee(e.name,i,n,r,e.attributes,a?O.StorageTexture:O.Storage,e.access);o.access||=`read`,this.storage.push(o);continue}if(this._isTextureVar(t)){let e=t,n=this._getAttributeNum(e.attributes,`group`,0),r=this._getAttributeNum(e.attributes,`binding`,0),i=this.getTypeInfo(e.type,e.attributes),a=this._isStorageTexture(i),o=new ee(e.name,i,n,r,e.attributes,a?O.StorageTexture:O.Texture,e.access);o.access||=`read`,a?this.storage.push(o):this.textures.push(o);continue}if(this._isSamplerVar(t)){let e=t,n=this._getAttributeNum(e.attributes,`group`,0),r=this._getAttributeNum(e.attributes,`binding`,0),i=this.getTypeInfo(e.type,e.attributes),a=new ee(e.name,i,n,r,e.attributes,O.Sampler,e.access);this.samplers.push(a);continue}}for(let t of e)if(t instanceof ye){let e=this._getAttribute(t,`vertex`),n=this._getAttribute(t,`fragment`),r=this._getAttribute(t,`compute`),i=e||n||r,a=new oe(t.name,i?.name,t.attributes);a.attributes=t.attributes,a.startLine=t.startLine,a.endLine=t.endLine,this.functions.push(a),this._functions.get(t.name).info=a,i&&(this._functions.get(t.name).inUse=!0,a.inUse=!0,a.resources=this._findResources(t,!!i),a.inputs=this._getInputs(t.args),a.outputs=this._getOutputs(t.returnType),this.entry[i.name].push(a)),a.arguments=t.args.map(e=>new ae(e.name,this.getTypeInfo(e.type,e.attributes),e.attributes)),a.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null;continue}for(let e of this._functions.values())e.info&&(e.info.inUse=e.inUse,this._addCalls(e.node,e.info.calls));for(let e of this._functions.values())e.node.search(t=>{var n,r,i;if(t instanceof ft){if(t.value)if(K(t.value))for(let r of t.value)for(let t of this.overrides)r===t.name&&((n=e.info)==null||n.overrides.push(t));else for(let n of this.overrides)t.value===n.name&&((r=e.info)==null||r.overrides.push(n))}else if(t instanceof $e)for(let n of this.overrides)t.name===n.name&&((i=e.info)==null||i.overrides.push(n))});for(let e of this.uniforms)this._markStructsInUse(e.type);for(let e of this.storage)this._markStructsInUse(e.type)}getFunctionInfo(e){for(let t of this.functions)if(t.name==e)return t;return null}getStructInfo(e){for(let t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(let t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(let t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{let t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){for(let n of e.calls){let e=this._functions.get(n.name)?.info;e&&t.add(e)}}findResource(e,t,n){if(n){for(let r of this.entry.compute)if(r.name===n){for(let n of r.resources)if(n.group==e&&n.binding==t)return n}for(let r of this.entry.vertex)if(r.name===n){for(let n of r.resources)if(n.group==e&&n.binding==t)return n}for(let r of this.entry.fragment)if(r.name===n){for(let n of r.resources)if(n.group==e&&n.binding==t)return n}}for(let n of this.uniforms)if(n.group==e&&n.binding==t)return n;for(let n of this.storage)if(n.group==e&&n.binding==t)return n;for(let n of this.textures)if(n.group==e&&n.binding==t)return n;for(let n of this.samplers)if(n.group==e&&n.binding==t)return n;return null}_findResource(e){for(let t of this.uniforms)if(t.name==e)return t;for(let t of this.storage)if(t.name==e)return t;for(let t of this.textures)if(t.name==e)return t;for(let t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){let t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){let n=[],r=this,i=[];return e.search(a=>{if(a instanceof ge)i.push({});else if(a instanceof _e)i.pop();else if(a instanceof we){let e=a;t&&e.type!==null&&this._markStructsFromAST(e.type),i.length>0&&(i[i.length-1][e.name]=e)}else if(a instanceof Ze){let e=a;t&&e.type!==null&&this._markStructsFromAST(e.type)}else if(a instanceof Ee){let e=a;t&&e.type!==null&&this._markStructsFromAST(e.type),i.length>0&&(i[i.length-1][e.name]=e)}else if(a instanceof $e){let e=a;if(i.length>0&&i[i.length-1][e.name])return;let t=r._findResource(e.name);t&&n.push(t)}else if(a instanceof Qe){let i=a,o=r._functions.get(i.name);o&&(t&&(o.inUse=!0),e.calls.add(o.node),o.resources===null&&(o.resources=r._findResources(o.node,t)),n.push(...o.resources))}else if(a instanceof Me){let i=a,o=r._functions.get(i.name);o&&(t&&(o.inUse=!0),e.calls.add(o.node),o.resources===null&&(o.resources=r._findResources(o.node,t)),n.push(...o.resources))}}),[...new Map(n.map(e=>[e.name,e])).values()]}getBindGroups(){let e=[];function t(t,n){t>=e.length&&(e.length=t+1),e[t]===void 0&&(e[t]=[]),n>=e[t].length&&(e[t].length=n+1)}for(let n of this.uniforms)t(n.group,n.binding),e[n.group][n.binding]=n;for(let n of this.storage)t(n.group,n.binding),e[n.group][n.binding]=n;for(let n of this.textures)t(n.group,n.binding),e[n.group][n.binding]=n;for(let n of this.samplers)t(n.group,n.binding),e[n.group][n.binding]=n;return e}_getOutputs(e,t=void 0){if(t===void 0&&(t=[]),e instanceof Ge)this._getStructOutputs(e,t);else{let n=this._getOutputInfo(e);n!==null&&t.push(n)}return t}_getStructOutputs(e,t){for(let n of e.members)if(n.type instanceof Ge)this._getStructOutputs(n.type,t);else{let e=this._getAttribute(n,`location`)||this._getAttribute(n,`builtin`);if(e!==null){let r=this.getTypeInfo(n.type,n.type.attributes),i=this._parseInt(e.value),a=new re(n.name,r,e.name,i);t.push(a)}}}_getOutputInfo(e){let t=this._getAttribute(e,`location`)||this._getAttribute(e,`builtin`);if(t!==null){let n=this.getTypeInfo(e,e.attributes),r=this._parseInt(t.value);return new re(``,n,t.name,r)}return null}_getInputs(e,t=void 0){t===void 0&&(t=[]);for(let n of e)if(n.type instanceof Ge)this._getStructInputs(n.type,t);else{let e=this._getInputInfo(n);e!==null&&t.push(e)}return t}_getStructInputs(e,t){for(let n of e.members)if(n.type instanceof Ge)this._getStructInputs(n.type,t);else{let e=this._getInputInfo(n);e!==null&&t.push(e)}}_getInputInfo(e){let t=this._getAttribute(e,`location`)||this._getAttribute(e,`builtin`);if(t!==null){let n=this._getAttribute(e,`interpolation`),r=this.getTypeInfo(e.type,e.attributes),i=this._parseInt(t.value),a=new ne(e.name,r,t.name,i);return n!==null&&(a.interpolation=this._parseString(n.value)),a}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);let t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(let t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new te(e.name,this.getTypeInfo(e.type,null))}getTypeInfoByName(e){for(let t of this.structs)if(t.name==e)return t;for(let t of this.aliases)if(t.name==e)return t.type;return null}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof Ke){let n=e.type?this.getTypeInfo(e.type,e.attributes):null,r=new E(e.name,n,t);return this._types.set(e,r),this._updateTypeInfo(r),r}if(e instanceof qe){let n=e,r=n.format?this.getTypeInfo(n.format,n.attributes):null,i=new T(n.name,t);return i.format=r,i.count=n.count,this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof Ge){let n=e,r=new w(n.name,t);r.startLine=n.startLine,r.endLine=n.endLine;for(let e of n.members){let t=this.getTypeInfo(e.type,e.attributes);r.members.push(new C(e.name,t,e.attributes))}return this._types.set(e,r),this._updateTypeInfo(r),r}if(e instanceof Je){let n=e,r=n.format instanceof I,i=n.format?r?this.getTypeInfo(n.format,null):new S(n.format,null):null,a=new D(n.name,i,t,n.access);return this._types.set(e,a),this._updateTypeInfo(a),a}if(e instanceof L){let n=e,r=n.format?this.getTypeInfo(n.format,null):null,i=new D(n.name,r,t,n.access);return this._types.set(e,i),this._updateTypeInfo(i),i}let n=new S(e.name,t);return this._types.set(e,n),this._updateTypeInfo(n),n}_updateTypeInfo(e){if(e.size=this._getTypeSize(e)?.size??0,e instanceof T&&e.format){let t=this._getTypeSize(e.format);e.stride=Math.max(t?.size??0,t?.align??0),this._updateTypeInfo(e.format)}e instanceof E&&this._updateTypeInfo(e.format),e instanceof w&&this._updateStructInfo(e)}_updateStructInfo(e){let t=0,n=0,r=0,i=0;for(let a=0,o=e.members.length;a<o;++a){let o=e.members[a],s=this._getTypeSize(o);if(!s)continue;this._getAlias(o.type.name)??o.type;let c=s.align,l=s.size;t=this._roundUp(c,t+n),n=l,r=t,i=Math.max(i,c),o.offset=t,o.size=l,this._updateTypeInfo(o.type)}e.size=this._roundUp(i,r+n),e.align=i}_getTypeSize(t){if(t==null)return null;let n=this._getAttributeNum(t.attributes,`size`,0),r=this._getAttributeNum(t.attributes,`align`,0);if(t instanceof C&&(t=t.type),t instanceof S){let e=this._getAlias(t.name);e!==null&&(t=e)}{let i=e._typeInfo[t.name];if(i!==void 0){let e=t.format?.name===`f16`?2:1;return new jt(Math.max(r,i.align/e),Math.max(n,i.size/e))}}{let i=e._typeInfo[t.name.substring(0,t.name.length-1)];if(i){let e=t.name[t.name.length-1]===`h`?2:1;return new jt(Math.max(r,i.align/e),Math.max(n,i.size/e))}}if(t instanceof T){let e=t,i=8,a=8,o=this._getTypeSize(e.format);return o!==null&&(a=o.size,i=o.align),a=e.count*this._getAttributeNum(t?.attributes??null,`stride`,this._roundUp(i,a)),n&&(a=n),new jt(Math.max(r,i),Math.max(n,a))}if(t instanceof w){let e=0,i=0,a=0,o=0,s=0;for(let n of t.members){let t=this._getTypeSize(n.type);t!==null&&(e=Math.max(t.align,e),a=this._roundUp(t.align,a+o),o=t.size,s=a)}return i=this._roundUp(e,s+o),new jt(Math.max(r,e),Math.max(n,i))}return null}_isUniformVar(e){return e instanceof we&&e.storage==`uniform`}_isStorageVar(e){return e instanceof we&&e.storage==`storage`}_isTextureVar(t){return t instanceof we&&t.type!==null&&e._textureTypes.indexOf(t.type.name)!=-1}_isSamplerVar(t){return t instanceof we&&t.type!==null&&e._samplerTypes.indexOf(t.type.name)!=-1}_getAttribute(e,t){let n=e;if(!n||!n.attributes)return null;let r=n.attributes;for(let e of r)if(e.name==t)return e;return null}_getAttributeNum(e,t,n){if(e===null)return n;for(let r of e)if(r.name==t){let e=r!==null&&r.value!==null?r.value:n;return e instanceof Array&&(e=e[0]),typeof e==`number`?e:typeof e==`string`?parseInt(e):n}return n}_roundUp(e,t){return Math.ceil(t/e)*e}};Mt._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},Mt._textureTypes=G.any_texture_type.map(e=>e.name),Mt._samplerTypes=G.sampler_type.map(e=>e.name);var Nt=0,Pt=class e{constructor(e,t,n){this.id=Nt++,this.name=e,this.value=t,this.node=n}clone(){return new e(this.name,this.value,this.node)}},Ft=class e{constructor(e){this.id=Nt++,this.name=e.name,this.node=e}clone(){return new e(this.node)}},It=class e{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName=``,this.id=Nt++,e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){return this.variables.has(e)?this.variables.get(e)??null:this.parent?this.parent.getVariable(e):null}getFunction(e){return this.functions.has(e)?this.functions.get(e)??null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,n){this.variables.set(e,new Pt(e,t,n??null))}setVariable(e,t,n){let r=this.getVariable(e);r===null?this.createVariable(e,t,n):r.value=t}getVariableValue(e){return this.getVariable(e)?.value??null}clone(){return new e(this)}},Lt=class{evalExpression(e,t){return null}getTypeInfo(e){return null}getVariableName(e,t){return``}},Rt=class{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){let n=this.exec.evalExpression(e.args[0],t),r=!0;if(n instanceof V)return n.data.forEach(e=>{e||(r=!1)}),new B(r?1:0,this.getTypeInfo(`bool`));throw Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V){let e=n.data.some(e=>e);return new B(e?1:0,this.getTypeInfo(`bool`))}throw Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){let n=this.exec.evalExpression(e.args[2],t);if(!(n instanceof B))throw Error(`Select() expects a bool condition. Line ${e.line}`);return n.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let n=e.args[0];n instanceof z&&(n=n.right);let r=this.exec.evalExpression(n,t);if(r instanceof U&&r.typeInfo.size===0){let e=r.typeInfo,t=r.buffer.byteLength/e.stride;return new B(t,this.getTypeInfo(`u32`))}return new B(r.typeInfo.size,this.getTypeInfo(`u32`))}Abs(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.abs(e)),n.typeInfo);let r=n;return new B(Math.abs(r.value),r.typeInfo)}Acos(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.acos(e)),n.typeInfo);let r=n;return new B(Math.acos(r.value),n.typeInfo)}Acosh(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.acosh(e)),n.typeInfo);let r=n;return new B(Math.acosh(r.value),n.typeInfo)}Asin(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.asin(e)),n.typeInfo);let r=n;return new B(Math.asin(r.value),n.typeInfo)}Asinh(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.asinh(e)),n.typeInfo);let r=n;return new B(Math.asinh(r.value),n.typeInfo)}Atan(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.atan(e)),n.typeInfo);let r=n;return new B(Math.atan(r.value),n.typeInfo)}Atanh(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.atanh(e)),n.typeInfo);let r=n;return new B(Math.atanh(r.value),n.typeInfo)}Atan2(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof V&&r instanceof V)return new V(n.data.map((e,t)=>Math.atan2(e,r.data[t])),n.typeInfo);let i=n,a=r;return new B(Math.atan2(i.value,a.value),n.typeInfo)}Ceil(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.ceil(e)),n.typeInfo);let r=n;return new B(Math.ceil(r.value),n.typeInfo)}_clamp(e,t,n){return Math.min(Math.max(e,t),n)}Clamp(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof V&&r instanceof V&&i instanceof V)return new V(n.data.map((e,t)=>this._clamp(e,r.data[t],i.data[t])),n.typeInfo);let a=n,o=r,s=i;return new B(this._clamp(a.value,o.value,s.value),n.typeInfo)}Cos(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.cos(e)),n.typeInfo);let r=n;return new B(Math.cos(r.value),n.typeInfo)}Cosh(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.cosh(e)),n.typeInfo);let r=n;return new B(Math.cos(r.value),n.typeInfo)}CountLeadingZeros(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.clz32(e)),n.typeInfo);let r=n;return new B(Math.clz32(r.value),n.typeInfo)}_countOneBits(e){let t=0;for(;e!==0;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>this._countOneBits(e)),n.typeInfo);let r=n;return new B(this._countOneBits(r.value),n.typeInfo)}_countTrailingZeros(e){if(e===0)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>this._countTrailingZeros(e)),n.typeInfo);let r=n;return new B(this._countTrailingZeros(r.value),n.typeInfo)}Cross(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof V&&r instanceof V){if(n.data.length!==3||r.data.length!==3)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;let t=n.data,i=r.data;return new V([t[1]*i[2]-i[1]*t[2],t[2]*i[0]-i[2]*t[0],t[0]*i[1]-i[0]*t[1]],n.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){let n=this.exec.evalExpression(e.args[0],t),r=180/Math.PI;return n instanceof V?new V(n.data.map(e=>e*r),n.typeInfo):new B(n.value*r,this.getTypeInfo(`f32`))}Determinant(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof H){let e=n.data,t=n.typeInfo.getTypeName(),r=t.endsWith(`h`)?this.getTypeInfo(`f16`):this.getTypeInfo(`f32`);if(t===`mat2x2`||t===`mat2x2f`||t===`mat2x2h`)return new B(e[0]*e[3]-e[1]*e[2],r);if(t===`mat2x3`||t===`mat2x3f`||t===`mat2x3h`)return new B(e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]),r);if(t===`mat2x4`||t===`mat2x4f`||t===`mat2x4h`)console.error(`TODO: Determinant for ${t}`);else if(t===`mat3x2`||t===`mat3x2f`||t===`mat3x2h`)console.error(`TODO: Determinant for ${t}`);else{if(t===`mat3x3`||t===`mat3x3f`||t===`mat3x3h`)return new B(e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]),r);t===`mat3x4`||t===`mat3x4f`||t===`mat3x4h`||t===`mat4x2`||t===`mat4x2f`||t===`mat4x2h`||t===`mat4x3`||t===`mat4x3f`||t===`mat4x3h`?console.error(`TODO: Determinant for ${t}`):t!==`mat4x4`&&t!==`mat4x4f`&&t!==`mat4x4h`||console.error(`TODO: Determinant for ${t}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof V&&r instanceof V){let e=0;for(let t=0;t<n.data.length;++t)e+=(n.data[t]-r.data[t])*(n.data[t]-r.data[t]);return new B(Math.sqrt(e),this.getTypeInfo(`f32`))}let i=n,a=r;return new B(Math.abs(i.value-a.value),n.typeInfo)}_dot(e,t){let n=0;for(let r=0;r<e.length;++r)n+=t[r]*e[r];return n}Dot(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return n instanceof V&&r instanceof V?new B(this._dot(n.data,r.data),this.getTypeInfo(`f32`)):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.exp(e)),n.typeInfo);let r=n;return new B(Math.exp(r.value),n.typeInfo)}Exp2(e,t){let n=this.exec.evalExpression(e.args[0],t);return n instanceof V?new V(n.data.map(e=>2**e),n.typeInfo):new B(2**n.value,n.typeInfo)}ExtractBits(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(r.typeInfo.name!==`u32`&&r.typeInfo.name!==`x32`)return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if(i.typeInfo.name!==`u32`&&i.typeInfo.name!==`x32`)return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;let a=r.value,o=i.value;if(n instanceof V)return new V(n.data.map(e=>e>>a&(1<<o)-1),n.typeInfo);if(n.typeInfo.name!==`i32`&&n.typeInfo.name!==`x32`)return console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null;let s=n.value;return new B(s>>a&(1<<o)-1,this.getTypeInfo(`i32`))}FaceForward(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof V&&r instanceof V&&i instanceof V){let e=this._dot(r.data,i.data);return new V(e<0?Array.from(n.data):n.data.map(e=>-e),n.typeInfo)}return console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null}_firstLeadingBit(e){return e===0?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>this._firstLeadingBit(e)),n.typeInfo);let r=n;return new B(this._firstLeadingBit(r.value),n.typeInfo)}_firstTrailingBit(e){return e===0?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>this._firstTrailingBit(e)),n.typeInfo);let r=n;return new B(this._firstTrailingBit(r.value),n.typeInfo)}Floor(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.floor(e)),n.typeInfo);let r=n;return new B(Math.floor(r.value),n.typeInfo)}Fma(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof V&&r instanceof V&&i instanceof V)return n.data.length!==r.data.length||n.data.length!==i.data.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new V(n.data.map((e,t)=>e*r.data[t]+i.data[t]),n.typeInfo);let a=n,o=r,s=i;return new B(a.value*o.value+s.value,a.typeInfo)}Fract(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>e-Math.floor(e)),n.typeInfo);let r=n;return new B(r.value-Math.floor(r.value),n.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t),a=this.exec.evalExpression(e.args[3],t);if(i.typeInfo.name!==`u32`&&i.typeInfo.name!==`x32`)return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;let o=i.value,s=(1<<a.value)-1<<o,c=~s;if(n instanceof V&&r instanceof V)return new V(n.data.map((e,t)=>e&c|r.data[t]<<o&s),n.typeInfo);let l=n.value,u=r.value;return new B(l&c|u<<o&s,n.typeInfo)}InverseSqrt(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>1/Math.sqrt(e)),n.typeInfo);let r=n;return new B(1/Math.sqrt(r.value),n.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V){let e=0;return n.data.forEach(t=>{e+=t*t}),new B(Math.sqrt(e),this.getTypeInfo(`f32`))}let r=n;return new B(Math.abs(r.value),n.typeInfo)}Log(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.log(e)),n.typeInfo);let r=n;return new B(Math.log(r.value),n.typeInfo)}Log2(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.log2(e)),n.typeInfo);let r=n;return new B(Math.log2(r.value),n.typeInfo)}Max(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof V&&r instanceof V)return new V(n.data.map((e,t)=>Math.max(e,r.data[t])),n.typeInfo);let i=n,a=r;return new B(Math.max(i.value,a.value),n.typeInfo)}Min(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof V&&r instanceof V)return new V(n.data.map((e,t)=>Math.min(e,r.data[t])),n.typeInfo);let i=n,a=r;return new B(Math.min(i.value,a.value),n.typeInfo)}Mix(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof V&&r instanceof V&&i instanceof V)return new V(n.data.map((e,t)=>n.data[t]*(1-i.data[t])+r.data[t]*i.data[t]),n.typeInfo);let a=r,o=i;return new B(n.value*(1-o.value)+a.value*o.value,n.typeInfo)}Modf(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof V&&r instanceof V)return new V(n.data.map((e,t)=>e%r.data[t]),n.typeInfo);let i=r;return new B(n.value%i.value,n.typeInfo)}Normalize(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V){let r=this.Length(e,t).value;return new V(n.data.map(e=>e/r),n.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof V&&r instanceof V)return new V(n.data.map((e,t)=>e**+r.data[t]),n.typeInfo);let i=n,a=r;return new B(i.value**+a.value,n.typeInfo)}QuantizeToF16(e,t){let n=this.exec.evalExpression(e.args[0],t);return n instanceof V?new V(n.data.map(e=>e),n.typeInfo):new B(n.value,n.typeInfo)}Radians(e,t){let n=this.exec.evalExpression(e.args[0],t);return n instanceof V?new V(n.data.map(e=>e*Math.PI/180),n.typeInfo):new B(n.value*Math.PI/180,this.getTypeInfo(`f32`))}Reflect(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof V&&r instanceof V){let e=this._dot(n.data,r.data);return new V(n.data.map((t,n)=>t-2*e*r.data[n]),n.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof V&&r instanceof V&&i instanceof B){let e=this._dot(r.data,n.data);return new V(n.data.map((t,n)=>{let a=1-i.value*i.value*(1-e*e);if(a<0)return 0;let o=Math.sqrt(a);return i.value*t-(i.value*e+o)*r.data[n]}),n.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.round(e)),n.typeInfo);let r=n;return new B(Math.round(r.value),n.typeInfo)}Saturate(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.min(Math.max(e,0),1)),n.typeInfo);let r=n;return new B(Math.min(Math.max(r.value,0),1),n.typeInfo)}Sign(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.sign(e)),n.typeInfo);let r=n;return new B(Math.sign(r.value),n.typeInfo)}Sin(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.sin(e)),n.typeInfo);let r=n;return new B(Math.sin(r.value),n.typeInfo)}Sinh(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.sinh(e)),n.typeInfo);let r=n;return new B(Math.sinh(r.value),n.typeInfo)}_smoothstep(e,t,n){let r=Math.min(Math.max((n-e)/(t-e),0),1);return r*r*(3-2*r)}SmoothStep(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(i instanceof V&&n instanceof V&&r instanceof V)return new V(i.data.map((e,t)=>this._smoothstep(n.data[t],r.data[t],e)),i.typeInfo);let a=n,o=r,s=i;return new B(this._smoothstep(a.value,o.value,s.value),i.typeInfo)}Sqrt(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.sqrt(e)),n.typeInfo);let r=n;return new B(Math.sqrt(r.value),n.typeInfo)}Step(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(r instanceof V&&n instanceof V)return new V(r.data.map((e,t)=>e<n.data[t]?0:1),r.typeInfo);let i=n;return new B(r.value<i.value?0:1,i.typeInfo)}Tan(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.tan(e)),n.typeInfo);let r=n;return new B(Math.tan(r.value),n.typeInfo)}Tanh(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.tanh(e)),n.typeInfo);let r=n;return new B(Math.tanh(r.value),n.typeInfo)}_getTransposeType(e){let t=e.getTypeName();return t===`mat2x2f`||t===`mat2x2h`?e:t===`mat2x3f`?this.getTypeInfo(`mat3x2f`):t===`mat2x3h`?this.getTypeInfo(`mat3x2h`):t===`mat2x4f`?this.getTypeInfo(`mat4x2f`):t===`mat2x4h`?this.getTypeInfo(`mat4x2h`):t===`mat3x2f`?this.getTypeInfo(`mat2x3f`):t===`mat3x2h`?this.getTypeInfo(`mat2x3h`):t===`mat3x3f`||t===`mat3x3h`?e:t===`mat3x4f`?this.getTypeInfo(`mat4x3f`):t===`mat3x4h`?this.getTypeInfo(`mat4x3h`):t===`mat4x2f`?this.getTypeInfo(`mat2x4f`):t===`mat4x2h`?this.getTypeInfo(`mat2x4h`):t===`mat4x3f`?this.getTypeInfo(`mat3x4f`):t===`mat4x3h`?this.getTypeInfo(`mat3x4h`):(t===`mat4x4f`||t===`mat4x4h`||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){let n=this.exec.evalExpression(e.args[0],t);if(!(n instanceof H))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;let r=this._getTransposeType(n.typeInfo);if(n.typeInfo.name===`mat2x2`||n.typeInfo.name===`mat2x2f`||n.typeInfo.name===`mat2x2h`){let e=n.data;return new H([e[0],e[2],e[1],e[3]],r)}if(n.typeInfo.name===`mat2x3`||n.typeInfo.name===`mat2x3f`||n.typeInfo.name===`mat2x3h`){let e=n.data;return new H([e[0],e[3],e[6],e[1],e[4],e[7]],r)}if(n.typeInfo.name===`mat2x4`||n.typeInfo.name===`mat2x4f`||n.typeInfo.name===`mat2x4h`){let e=n.data;return new H([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13]],r)}if(n.typeInfo.name===`mat3x2`||n.typeInfo.name===`mat3x2f`||n.typeInfo.name===`mat3x2h`){let e=n.data;return new H([e[0],e[3],e[1],e[4],e[2],e[5]],r)}if(n.typeInfo.name===`mat3x3`||n.typeInfo.name===`mat3x3f`||n.typeInfo.name===`mat3x3h`){let e=n.data;return new H([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]],r)}if(n.typeInfo.name===`mat3x4`||n.typeInfo.name===`mat3x4f`||n.typeInfo.name===`mat3x4h`){let e=n.data;return new H([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14]],r)}if(n.typeInfo.name===`mat4x2`||n.typeInfo.name===`mat4x2f`||n.typeInfo.name===`mat4x2h`){let e=n.data;return new H([e[0],e[4],e[1],e[5],e[2],e[6]],r)}if(n.typeInfo.name===`mat4x3`||n.typeInfo.name===`mat4x3f`||n.typeInfo.name===`mat4x3h`){let e=n.data;return new H([e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]],r)}if(n.typeInfo.name===`mat4x4`||n.typeInfo.name===`mat4x4f`||n.typeInfo.name===`mat4x4h`){let e=n.data;return new H([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]],r)}return console.error(`Invalid matrix type ${n.typeInfo.name}`),null}Trunc(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof V)return new V(n.data.map(e=>Math.trunc(e)),n.typeInfo);let r=n;return new B(Math.trunc(r.value),n.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error(`TODO: dpdxFine`),null}Dpdy(e,t){return console.error(`TODO: dpdy`),null}DpdyCoarse(e,t){return console.error(`TODO: dpdyCoarse`),null}DpdyFine(e,t){return console.error(`TODO: dpdyFine`),null}Fwidth(e,t){return console.error(`TODO: fwidth`),null}FwidthCoarse(e,t){return console.error(`TODO: fwidthCoarse`),null}FwidthFine(e,t){return console.error(`TODO: fwidthFine`),null}TextureDimensions(e,t){let n=e.args[0],r=e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0;if(n instanceof $e){let i=n.name,a=t.getVariableValue(i);if(a instanceof _t){if(r<0||r>=a.mipLevelCount)return console.error(`Invalid mip level for textureDimensions. Line ${e.line}`),null;let t=a.getMipLevelSize(r),n=a.dimension;return n===`1d`?new B(t[0],this.getTypeInfo(`u32`)):n===`3d`?new V(t,this.getTypeInfo(`vec3u`)):n===`2d`?new V(t.slice(0,2),this.getTypeInfo(`vec2u`)):(console.error(`Invalid texture dimension ${n} not found. Line ${e.line}`),null)}return console.error(`Texture ${i} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error(`TODO: textureGather`),null}TextureGatherCompare(e,t){return console.error(`TODO: textureGatherCompare`),null}TextureLoad(e,t){let n=e.args[0],r=this.exec.evalExpression(e.args[1],t),i=e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0;if(!(r instanceof V)||r.data.length!==2)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(n instanceof $e){let a=n.name,o=t.getVariableValue(a);if(o instanceof _t){let t=Math.floor(r.data[0]),n=Math.floor(r.data[1]);if(t<0||t>=o.width||n<0||n>=o.height)return console.error(`Texture ${a} out of bounds. Line ${e.line}`),null;let s=o.getPixel(t,n,0,i);return s===null?(console.error(`Invalid texture format for textureLoad. Line ${e.line}`),null):new V(s,this.getTypeInfo(`vec4f`))}return console.error(`Texture ${a} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){let n=e.args[0];if(n instanceof $e){let r=n.name,i=t.getVariableValue(r);return i instanceof _t?new B(i.depthOrArrayLayers,this.getTypeInfo(`u32`)):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLayers. Line ${e.line}`),null}TextureNumLevels(e,t){let n=e.args[0];if(n instanceof $e){let r=n.name,i=t.getVariableValue(r);return i instanceof _t?new B(i.mipLevelCount,this.getTypeInfo(`u32`)):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLevels. Line ${e.line}`),null}TextureNumSamples(e,t){let n=e.args[0];if(n instanceof $e){let r=n.name,i=t.getVariableValue(r);return i instanceof _t?new B(i.sampleCount,this.getTypeInfo(`u32`)):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumSamples. Line ${e.line}`),null}TextureSample(e,t){return console.error(`TODO: textureSample`),null}TextureSampleBias(e,t){return console.error(`TODO: textureSampleBias`),null}TextureSampleCompare(e,t){return console.error(`TODO: textureSampleCompare`),null}TextureSampleCompareLevel(e,t){return console.error(`TODO: textureSampleCompareLevel`),null}TextureSampleGrad(e,t){return console.error(`TODO: textureSampleGrad`),null}TextureSampleLevel(e,t){return console.error(`TODO: textureSampleLevel`),null}TextureSampleBaseClampToEdge(e,t){return console.error(`TODO: textureSampleBaseClampToEdge`),null}TextureStore(e,t){let n=e.args[0],r=this.exec.evalExpression(e.args[1],t),i=e.args.length===4?this.exec.evalExpression(e.args[2],t).value:0,a=e.args.length===4?this.exec.evalExpression(e.args[3],t).data:this.exec.evalExpression(e.args[2],t).data;if(a.length!==4)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(r instanceof V)||r.data.length!==2)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(n instanceof $e){let o=n.name,s=t.getVariableValue(o);if(s instanceof _t){let t=s.getMipLevelSize(0),n=Math.floor(r.data[0]),c=Math.floor(r.data[1]);return n<0||n>=t[0]||c<0||c>=t[1]?(console.error(`Texture ${o} out of bounds. Line ${e.line}`),null):(s.setPixel(n,c,0,i,Array.from(a)),null)}return console.error(`Texture ${o} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let n=e.args[0];n instanceof z&&(n=n.right);let r=this.exec.getVariableName(n,t);return t.getVariable(r).value.getSubData(this.exec,n.postfix,t)}AtomicStore(e,t){let n=e.args[0];n instanceof z&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t);return s instanceof B&&o instanceof B&&(s.value=o.value),i.value instanceof U&&i.value.setDataValue(this.exec,s,n.postfix,t),null}AtomicAdd(e,t){let n=e.args[0];n instanceof z&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new B(s.value,s.typeInfo);return s instanceof B&&o instanceof B&&(s.value+=o.value),i.value instanceof U&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicSub(e,t){let n=e.args[0];n instanceof z&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new B(s.value,s.typeInfo);return s instanceof B&&o instanceof B&&(s.value-=o.value),i.value instanceof U&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicMax(e,t){let n=e.args[0];n instanceof z&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new B(s.value,s.typeInfo);return s instanceof B&&o instanceof B&&(s.value=Math.max(s.value,o.value)),i.value instanceof U&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicMin(e,t){let n=e.args[0];n instanceof z&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new B(s.value,s.typeInfo);return s instanceof B&&o instanceof B&&(s.value=Math.min(s.value,o.value)),i.value instanceof U&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicAnd(e,t){let n=e.args[0];n instanceof z&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new B(s.value,s.typeInfo);return s instanceof B&&o instanceof B&&(s.value&=o.value),i.value instanceof U&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicOr(e,t){let n=e.args[0];n instanceof z&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new B(s.value,s.typeInfo);return s instanceof B&&o instanceof B&&(s.value|=o.value),i.value instanceof U&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicXor(e,t){let n=e.args[0];n instanceof z&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new B(s.value,s.typeInfo);return s instanceof B&&o instanceof B&&(s.value^=o.value),i.value instanceof U&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicExchange(e,t){let n=e.args[0];n instanceof z&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new B(s.value,s.typeInfo);return s instanceof B&&o instanceof B&&(s.value=o.value),i.value instanceof U&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicCompareExchangeWeak(e,t){return console.error(`TODO: atomicCompareExchangeWeak`),null}Pack4x8snorm(e,t){return console.error(`TODO: pack4x8snorm`),null}Pack4x8unorm(e,t){return console.error(`TODO: pack4x8unorm`),null}Pack4xI8(e,t){return console.error(`TODO: pack4xI8`),null}Pack4xU8(e,t){return console.error(`TODO: pack4xU8`),null}Pack4x8Clamp(e,t){return console.error(`TODO: pack4x8Clamp`),null}Pack4xU8Clamp(e,t){return console.error(`TODO: pack4xU8Clamp`),null}Pack2x16snorm(e,t){return console.error(`TODO: pack2x16snorm`),null}Pack2x16unorm(e,t){return console.error(`TODO: pack2x16unorm`),null}Pack2x16float(e,t){return console.error(`TODO: pack2x16float`),null}Unpack4x8snorm(e,t){return console.error(`TODO: unpack4x8snorm`),null}Unpack4x8unorm(e,t){return console.error(`TODO: unpack4x8unorm`),null}Unpack4xI8(e,t){return console.error(`TODO: unpack4xI8`),null}Unpack4xU8(e,t){return console.error(`TODO: unpack4xU8`),null}Unpack2x16snorm(e,t){return console.error(`TODO: unpack2x16snorm`),null}Unpack2x16unorm(e,t){return console.error(`TODO: unpack2x16unorm`),null}Unpack2x16float(e,t){return console.error(`TODO: unpack2x16float`),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error(`TODO: subgroupAdd`),null}SubgroupExclusiveAdd(e,t){return console.error(`TODO: subgroupExclusiveAdd`),null}SubgroupInclusiveAdd(e,t){return console.error(`TODO: subgroupInclusiveAdd`),null}SubgroupAll(e,t){return console.error(`TODO: subgroupAll`),null}SubgroupAnd(e,t){return console.error(`TODO: subgroupAnd`),null}SubgroupAny(e,t){return console.error(`TODO: subgroupAny`),null}SubgroupBallot(e,t){return console.error(`TODO: subgroupBallot`),null}SubgroupBroadcast(e,t){return console.error(`TODO: subgroupBroadcast`),null}SubgroupBroadcastFirst(e,t){return console.error(`TODO: subgroupBroadcastFirst`),null}SubgroupElect(e,t){return console.error(`TODO: subgroupElect`),null}SubgroupMax(e,t){return console.error(`TODO: subgroupMax`),null}SubgroupMin(e,t){return console.error(`TODO: subgroupMin`),null}SubgroupMul(e,t){return console.error(`TODO: subgroupMul`),null}SubgroupExclusiveMul(e,t){return console.error(`TODO: subgroupExclusiveMul`),null}SubgroupInclusiveMul(e,t){return console.error(`TODO: subgroupInclusiveMul`),null}SubgroupOr(e,t){return console.error(`TODO: subgroupOr`),null}SubgroupShuffle(e,t){return console.error(`TODO: subgroupShuffle`),null}SubgroupShuffleDown(e,t){return console.error(`TODO: subgroupShuffleDown`),null}SubgroupShuffleUp(e,t){return console.error(`TODO: subgroupShuffleUp`),null}SubgroupShuffleXor(e,t){return console.error(`TODO: subgroupShuffleXor`),null}SubgroupXor(e,t){return console.error(`TODO: subgroupXor`),null}QuadBroadcast(e,t){return console.error(`TODO: quadBroadcast`),null}QuadSwapDiagonal(e,t){return console.error(`TODO: quadSwapDiagonal`),null}QuadSwapX(e,t){return console.error(`TODO: quadSwapX`),null}QuadSwapY(e,t){return console.error(`TODO: quadSwapY`),null}},zt={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},Bt={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]},Vt=class e extends Lt{constructor(e,t){super(),this.ast=e??[],this.reflection=new Mt,this.reflection.updateAST(this.ast),this.context=t?.clone()??new It,this.builtins=new Rt(this),this.typeInfo={bool:this.getTypeInfo(I.bool),i32:this.getTypeInfo(I.i32),u32:this.getTypeInfo(I.u32),f32:this.getTypeInfo(I.f32),f16:this.getTypeInfo(I.f16),vec2f:this.getTypeInfo(L.vec2f),vec2u:this.getTypeInfo(L.vec2u),vec2i:this.getTypeInfo(L.vec2i),vec2h:this.getTypeInfo(L.vec2h),vec3f:this.getTypeInfo(L.vec3f),vec3u:this.getTypeInfo(L.vec3u),vec3i:this.getTypeInfo(L.vec3i),vec3h:this.getTypeInfo(L.vec3h),vec4f:this.getTypeInfo(L.vec4f),vec4u:this.getTypeInfo(L.vec4u),vec4i:this.getTypeInfo(L.vec4i),vec4h:this.getTypeInfo(L.vec4h),mat2x2f:this.getTypeInfo(L.mat2x2f),mat2x3f:this.getTypeInfo(L.mat2x3f),mat2x4f:this.getTypeInfo(L.mat2x4f),mat3x2f:this.getTypeInfo(L.mat3x2f),mat3x3f:this.getTypeInfo(L.mat3x3f),mat3x4f:this.getTypeInfo(L.mat3x4f),mat4x2f:this.getTypeInfo(L.mat4x2f),mat4x3f:this.getTypeInfo(L.mat4x3f),mat4x4f:this.getTypeInfo(L.mat4x4f)}}getVariableValue(e){let t=this.context.getVariable(e)?.value??null;if(t===null)return null;if(t instanceof B)return t.value;if(t instanceof V||t instanceof H)return Array.from(t.data);if(t instanceof U&&t.typeInfo instanceof T){if(t.typeInfo.format.name===`u32`)return Array.from(new Uint32Array(t.buffer,t.offset,t.typeInfo.count));if(t.typeInfo.format.name===`i32`)return Array.from(new Int32Array(t.buffer,t.offset,t.typeInfo.count));if(t.typeInfo.format.name===`f32`)return Array.from(new Float32Array(t.buffer,t.offset,t.typeInfo.count))}return console.error(`Unsupported return variable type ${t.typeInfo.name}`),null}execute(e){(e??={}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,n,r){let i=this.context.clone();(r??={}).constants&&this._setOverrides(r.constants,i),this._execStatements(this.ast,i);let a=i.getFunction(e);if(!a)return void console.error(`Function ${e} not found`);if(typeof t==`number`)t=[t,1,1];else{if(t.length===0)return void console.error(`Invalid dispatch count`);t.length===1?t=[t[0],1,1]:t.length===2?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}let o=t[0],s=t[1],c=t[2],l=this.getTypeInfo(`vec3u`);i.setVariable(`@num_workgroups`,new V(t,l));let u=this.reflection.getFunctionInfo(e);for(let t in u===null&&console.error(`Function ${e} not found in reflection data`),n)for(let e in n[t]){let r=n[t][e];i.variables.forEach(n=>{let i=n.node;if(i?.attributes){let a=null,o=null;for(let e of i.attributes)e.name===`binding`?a=e.value:e.name===`group`&&(o=e.value);if(e==a&&t==o){let a=!1;for(let r of u.resources)if(r.name===n.name&&r.group===parseInt(t)&&r.binding===parseInt(e)){a=!0;break}a&&(r.texture!==void 0&&r.descriptor!==void 0?n.value=new _t(r.texture,this.getTypeInfo(i.type),r.descriptor,r.texture.view??null):r.uniform===void 0?n.value=new U(r,this.getTypeInfo(i.type)):n.value=new U(r.uniform,this.getTypeInfo(i.type)))}}})}for(let e=0;e<c;++e)for(let t=0;t<s;++t)for(let n=0;n<o;++n)i.setVariable(`@workgroup_id`,new V([n,t,e],this.getTypeInfo(`vec3u`))),this._dispatchWorkgroup(a,[n,t,e],i)}execStatement(t,n){if(t instanceof Ie)return this.evalExpression(t.value,n);if(t instanceof He){if(t.condition){let e=this.evalExpression(t.condition,n);if(!(e instanceof B))throw Error(`Invalid break-if condition`);if(!e.value)return null}return e._breakObj}if(t instanceof Ue)return e._continueObj;if(t instanceof Ee)this._let(t,n);else if(t instanceof we)this._var(t,n);else if(t instanceof De)this._const(t,n);else if(t instanceof ye)this._function(t,n);else{if(t instanceof Fe)return this._if(t,n);if(t instanceof Pe)return this._switch(t,n);if(t instanceof Ce)return this._for(t,n);if(t instanceof xe)return this._while(t,n);if(t instanceof Ne)return this._loop(t,n);if(t instanceof Se){let e=n.clone();return e.currentFunctionName=n.currentFunctionName,this._execStatements(t.body,e)}if(t instanceof je)this._assign(t,n);else if(t instanceof Ae)this._increment(t,n);else{if(t instanceof Ge)return null;if(t instanceof Te){let e=t.name;n.getVariable(e)===null&&n.setVariable(e,new B(0,this.getTypeInfo(`u32`)))}else if(t instanceof Me)this._call(t,n);else{if(t instanceof ze||t instanceof Be)return null;console.error(`Invalid statement type.`,t,`Line ${t.line}`)}}}return null}evalExpression(e,t){return e instanceof it?this._evalBinaryOp(e,t):e instanceof R?this._evalLiteral(e,t):e instanceof $e?this._evalVariable(e,t):e instanceof Qe?this._evalCall(e,t):e instanceof Ze?this._evalCreate(e,t):e instanceof et?this._evalConst(e,t):e instanceof tt?this._evalBitcast(e,t):e instanceof z?this._evalUnaryOp(e,t):(console.error(`Invalid expression type`,e,`Line ${e.line}`),null)}getTypeInfo(e){if(e instanceof I){let t=this.reflection.getTypeInfo(e);if(t!==null)return t}let t=this.typeInfo[e]??null;return t!==null||(t=this.reflection.getTypeInfoByName(e)),t}_setOverrides(e,t){for(let n in e){let r=e[n],i=this.reflection.getOverrideInfo(n);i===null?console.error(`Override ${n} does not exist in the shader.`):(i.type===null&&(i.type=this.getTypeInfo(`u32`)),i.type.name===`u32`||i.type.name===`i32`||i.type.name===`f32`||i.type.name===`f16`?t.setVariable(n,new B(r,i.type)):i.type.name===`bool`?t.setVariable(n,new B(r?1:0,i.type)):i.type.name===`vec2`||i.type.name===`vec3`||i.type.name===`vec4`||i.type.name===`vec2f`||i.type.name===`vec3f`||i.type.name===`vec4f`||i.type.name===`vec2i`||i.type.name===`vec3i`||i.type.name===`vec4i`||i.type.name===`vec2u`||i.type.name===`vec3u`||i.type.name===`vec4u`||i.type.name===`vec2h`||i.type.name===`vec3h`||i.type.name===`vec4h`?t.setVariable(n,new V(r,i.type)):console.error(`Invalid constant type for ${n}`))}}_dispatchWorkgroup(e,t,n){let r=[1,1,1];for(let t of e.node.attributes)if(t.name===`workgroup_size`){if(t.value.length>0){let e=n.getVariableValue(t.value[0]);r[0]=e instanceof B?e.value:parseInt(t.value[0])}if(t.value.length>1){let e=n.getVariableValue(t.value[1]);r[1]=e instanceof B?e.value:parseInt(t.value[1])}if(t.value.length>2){let e=n.getVariableValue(t.value[2]);r[2]=e instanceof B?e.value:parseInt(t.value[2])}}let i=this.getTypeInfo(`vec3u`),a=this.getTypeInfo(`u32`);n.setVariable(`@workgroup_size`,new V(r,i));let o=r[0],s=r[1],c=r[2];for(let l=0,u=0;l<c;++l)for(let c=0;c<s;++c)for(let s=0;s<o;++s,++u){let o=[s,c,l],d=[s+t[0]*r[0],c+t[1]*r[1],l+t[2]*r[2]];n.setVariable(`@local_invocation_id`,new V(o,i)),n.setVariable(`@global_invocation_id`,new V(d,i)),n.setVariable(`@local_invocation_index`,new B(u,a)),this._dispatchExec(e,n)}}_dispatchExec(e,t){for(let n of e.node.args)for(let e of n.attributes)if(e.name===`builtin`){let r=`@${e.value}`,i=t.getVariable(r);i!==void 0&&t.variables.set(n.name,i)}this._execStatements(e.node.body,t)}getVariableName(e,t){for(;e instanceof z;)e=e.right;return e instanceof $e?e.name:(console.error(`Unknown variable type`,e,`Line`,e.line),null)}_execStatements(e,t){for(let n of e){if(n instanceof Array){let e=t.clone(),r=this._execStatements(n,e);if(r)return r;continue}let e=this.execStatement(n,t);if(e)return e}return null}_call(e,t){let n=t.clone();n.currentFunctionName=e.name;let r=t.getFunction(e.name);if(r){for(let t=0;t<r.node.args.length;++t){let i=r.node.args[t],a=this.evalExpression(e.args[t],n);n.setVariable(i.name,a,i)}this._execStatements(r.node.body,n)}else e.isBuiltin?this._callBuiltinFunction(e,n):this.getTypeInfo(e.name)&&this._evalCreate(e,t)}_increment(e,t){let n=this.getVariableName(e.variable,t),r=t.getVariable(n);r?e.operator===`++`?r.value instanceof B?r.value.value++:console.error(`Variable ${n} is not a scalar. Line ${e.line}`):e.operator===`--`?r.value instanceof B?r.value.value--:console.error(`Variable ${n} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${n} not found. Line ${e.line}`)}_getVariableData(e,t){if(e instanceof $e){let n=this.getVariableName(e,t),r=t.getVariable(n);return r===null?(console.error(`Variable ${n} not found. Line ${e.line}`),null):r.value.getSubData(this,e.postfix,t)}if(e instanceof z){if(e.operator===`*`){let n=this._getVariableData(e.right,t);return n instanceof ht?n.reference.getSubData(this,e.postfix,t):(console.error(`Variable ${e.right} is not a pointer. Line ${e.line}`),null)}if(e.operator===`&`){let n=this._getVariableData(e.right,t);return new ht(n)}}return null}_assign(e,t){let n=null,r=`<var>`,i=null;if(e.variable instanceof z){let n=this._getVariableData(e.variable,t),r=this.evalExpression(e.value,t),i=e.operator;if(i===`=`){if(n instanceof B||n instanceof V||n instanceof H){if(r instanceof B||r instanceof V||r instanceof H&&n.data.length===r.data.length)return void n.data.set(r.data);console.error(`Invalid assignment. Line ${e.line}`)}else if(n instanceof U&&r instanceof U&&n.buffer.byteLength-n.offset>=r.buffer.byteLength-r.offset)return void(n.buffer.byteLength%4==0?new Uint32Array(n.buffer,n.offset,n.typeInfo.size/4).set(new Uint32Array(r.buffer,r.offset,r.typeInfo.size/4)):new Uint8Array(n.buffer,n.offset,n.typeInfo.size).set(new Uint8Array(r.buffer,r.offset,r.typeInfo.size)));return console.error(`Invalid assignment. Line ${e.line}`),null}if(i===`+=`)return n instanceof B||n instanceof V||n instanceof H?r instanceof B||r instanceof V||r instanceof H?void n.data.set(r.data.map((e,t)=>n.data[t]+e)):void console.error(`Invalid assignment . Line ${e.line}`):void console.error(`Invalid assignment. Line ${e.line}`);if(i===`-=`)return(n instanceof B||n instanceof V||n instanceof H)&&(r instanceof B||r instanceof V||r instanceof H)?void n.data.set(r.data.map((e,t)=>n.data[t]-e)):void console.error(`Invalid assignment. Line ${e.line}`)}if(e.variable instanceof z){if(e.variable.operator===`*`){r=this.getVariableName(e.variable.right,t);let i=t.getVariable(r);if(!(i&&i.value instanceof ht))return void console.error(`Variable ${r} is not a pointer. Line ${e.line}`);n=i.value.reference;let a=e.variable.postfix;if(!a){let t=e.variable.right;for(;t instanceof z;){if(t.postfix){a=t.postfix;break}t=t.right}}a&&(n=n.getSubData(this,a,t))}}else{i=e.variable.postfix,r=this.getVariableName(e.variable,t);let a=t.getVariable(r);if(a===null)return void console.error(`Variable ${r} not found. Line ${e.line}`);n=a.value}if(n instanceof ht&&(n=n.reference),n===null)return void console.error(`Variable ${r} not found. Line ${e.line}`);let a=this.evalExpression(e.value,t),o=e.operator;if(o!==`=`){let r=n.getSubData(this,i,t);if(r instanceof V&&a instanceof B){let t=r.data,n=a.value;if(o===`+=`)for(let e=0;e<t.length;++e)t[e]+=n;else if(o===`-=`)for(let e=0;e<t.length;++e)t[e]-=n;else if(o===`*=`)for(let e=0;e<t.length;++e)t[e]*=n;else if(o===`/=`)for(let e=0;e<t.length;++e)t[e]/=n;else if(o===`%=`)for(let e=0;e<t.length;++e)t[e]%=n;else if(o===`&=`)for(let e=0;e<t.length;++e)t[e]&=n;else if(o===`|=`)for(let e=0;e<t.length;++e)t[e]|=n;else if(o===`^=`)for(let e=0;e<t.length;++e)t[e]^=n;else if(o===`<<=`)for(let e=0;e<t.length;++e)t[e]<<=n;else if(o===`>>=`)for(let e=0;e<t.length;++e)t[e]>>=n;else console.error(`Invalid operator ${o}. Line ${e.line}`)}else if(r instanceof V&&a instanceof V){let t=r.data,n=a.data;if(t.length!==n.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if(o===`+=`)for(let e=0;e<t.length;++e)t[e]+=n[e];else if(o===`-=`)for(let e=0;e<t.length;++e)t[e]-=n[e];else if(o===`*=`)for(let e=0;e<t.length;++e)t[e]*=n[e];else if(o===`/=`)for(let e=0;e<t.length;++e)t[e]/=n[e];else if(o===`%=`)for(let e=0;e<t.length;++e)t[e]%=n[e];else if(o===`&=`)for(let e=0;e<t.length;++e)t[e]&=n[e];else if(o===`|=`)for(let e=0;e<t.length;++e)t[e]|=n[e];else if(o===`^=`)for(let e=0;e<t.length;++e)t[e]^=n[e];else if(o===`<<=`)for(let e=0;e<t.length;++e)t[e]<<=n[e];else if(o===`>>=`)for(let e=0;e<t.length;++e)t[e]>>=n[e];else console.error(`Invalid operator ${o}. Line ${e.line}`)}else{if(!(r instanceof B&&a instanceof B))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);o===`+=`?r.value+=a.value:o===`-=`?r.value-=a.value:o===`*=`?r.value*=a.value:o===`/=`?r.value/=a.value:o===`%=`?r.value%=a.value:o===`&=`?r.value&=a.value:o===`|=`?r.value|=a.value:o===`^=`?r.value^=a.value:o===`<<=`?r.value<<=a.value:o===`>>=`?r.value>>=a.value:console.error(`Invalid operator ${o}. Line ${e.line}`)}n instanceof U&&n.setDataValue(this,r,i,t);return}if(n instanceof U)n.setDataValue(this,a,i,t);else if(i){if(!(n instanceof V||n instanceof H))return void console.error(`Variable ${r} is not a vector or matrix. Line ${e.line}`);if(i instanceof nt){let o=this.evalExpression(i.index,t).value;if(n instanceof V){if(!(a instanceof B))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[o]=a.value}else{if(!(n instanceof H))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);{let o=this.evalExpression(i.index,t).value;if(o<0||!(a instanceof V))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);{let t=n.typeInfo.getTypeName();if(t===`mat2x2`||t===`mat2x2f`||t===`mat2x2h`){if(!(o<2&&a.data.length===2))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[2*o]=a.data[0],n.data[2*o+1]=a.data[1]}else if(t===`mat2x3`||t===`mat2x3f`||t===`mat2x3h`){if(!(o<2&&a.data.length===3))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[3*o]=a.data[0],n.data[3*o+1]=a.data[1],n.data[3*o+2]=a.data[2]}else if(t===`mat2x4`||t===`mat2x4f`||t===`mat2x4h`){if(!(o<2&&a.data.length===4))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[4*o]=a.data[0],n.data[4*o+1]=a.data[1],n.data[4*o+2]=a.data[2],n.data[4*o+3]=a.data[3]}else if(t===`mat3x2`||t===`mat3x2f`||t===`mat3x2h`){if(!(o<3&&a.data.length===2))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[2*o]=a.data[0],n.data[2*o+1]=a.data[1]}else if(t===`mat3x3`||t===`mat3x3f`||t===`mat3x3h`){if(!(o<3&&a.data.length===3))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[3*o]=a.data[0],n.data[3*o+1]=a.data[1],n.data[3*o+2]=a.data[2]}else if(t===`mat3x4`||t===`mat3x4f`||t===`mat3x4h`){if(!(o<3&&a.data.length===4))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[4*o]=a.data[0],n.data[4*o+1]=a.data[1],n.data[4*o+2]=a.data[2],n.data[4*o+3]=a.data[3]}else if(t===`mat4x2`||t===`mat4x2f`||t===`mat4x2h`){if(!(o<4&&a.data.length===2))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[2*o]=a.data[0],n.data[2*o+1]=a.data[1]}else if(t===`mat4x3`||t===`mat4x3f`||t===`mat4x3h`){if(!(o<4&&a.data.length===3))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[3*o]=a.data[0],n.data[3*o+1]=a.data[1],n.data[3*o+2]=a.data[2]}else{if(t!==`mat4x4`&&t!==`mat4x4f`&&t!==`mat4x4h`||!(o<4&&a.data.length===4))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[4*o]=a.data[0],n.data[4*o+1]=a.data[1],n.data[4*o+2]=a.data[2],n.data[4*o+3]=a.data[3]}}}}}else if(i instanceof Xe){let t=i.value;if(!(n instanceof V))return void console.error(`Invalid assignment to ${t}. Variable ${r} is not a vector. Line ${e.line}`);if(a instanceof B){if(t.length>1)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);if(t===`x`)n.data[0]=a.value;else if(t===`y`){if(n.data.length<2)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);n.data[1]=a.value}else if(t===`z`){if(n.data.length<3)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);n.data[2]=a.value}else if(t===`w`){if(n.data.length<4)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);n.data[3]=a.value}}else{if(!(a instanceof V))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);if(t.length!==a.data.length)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);for(let i=0;i<t.length;++i){let o=t[i];if(o===`x`||o===`r`)n.data[0]=a.data[i];else if(o===`y`||o===`g`){if(a.data.length<2)return void console.error(`Invalid assignment to ${o} for variable ${r}. Line ${e.line}`);n.data[1]=a.data[i]}else if(o===`z`||o===`b`){if(a.data.length<3)return void console.error(`Invalid assignment to ${o} for variable ${r}. Line ${e.line}`);n.data[2]=a.data[i]}else{if(o!==`w`&&o!==`a`||a.data.length<4)return void console.error(`Invalid assignment to ${o} for variable ${r}. Line ${e.line}`);n.data[3]=a.data[i]}}}}}else n instanceof B&&a instanceof B?n.value=a.value:n instanceof V&&a instanceof V||n instanceof H&&a instanceof H?n.data.set(a.data):console.error(`Invalid assignment to ${r}. Line ${e.line}`)}_function(e,t){let n=new Ft(e);t.functions.set(e.name,n)}_const(e,t){let n=null;e.value!==null&&(n=this.evalExpression(e.value,t)),t.createVariable(e.name,n,e)}_let(e,t){let n=null;if(e.value!==null){if(n=this.evalExpression(e.value,t),n===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof z||(n=n.clone())}else{let r=e.type.name;if(r===`f32`||r===`i32`||r===`u32`||r===`bool`||r===`f16`||r===`vec2`||r===`vec3`||r===`vec4`||r===`vec2f`||r===`vec3f`||r===`vec4f`||r===`vec2i`||r===`vec3i`||r===`vec4i`||r===`vec2u`||r===`vec3u`||r===`vec4u`||r===`vec2h`||r===`vec3h`||r===`vec4h`||r===`vec2b`||r===`vec3b`||r===`vec4b`||r===`mat2x2`||r===`mat2x3`||r===`mat2x4`||r===`mat3x2`||r===`mat3x3`||r===`mat3x4`||r===`mat4x2`||r===`mat4x3`||r===`mat4x4`||r===`mat2x2f`||r===`mat2x3f`||r===`mat2x4f`||r===`mat3x2f`||r===`mat3x3f`||r===`mat3x4f`||r===`mat4x2f`||r===`mat4x3f`||r===`mat4x4f`||r===`mat2x2h`||r===`mat2x3h`||r===`mat2x4h`||r===`mat3x2h`||r===`mat3x3h`||r===`mat3x4h`||r===`mat4x2h`||r===`mat4x3h`||r===`mat4x4h`||r===`array`){let r=new Ze(e.type,[]);n=this._evalCreate(r,t)}}t.createVariable(e.name,n,e)}_var(e,t){let n=null;if(e.value!==null){if(n=this.evalExpression(e.value,t),n===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof z||(n=n.clone())}else{if(e.type===null)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);let r=e.type.name;if(r===`f32`||r===`i32`||r===`u32`||r===`bool`||r===`f16`||r===`vec2`||r===`vec3`||r===`vec4`||r===`vec2f`||r===`vec3f`||r===`vec4f`||r===`vec2i`||r===`vec3i`||r===`vec4i`||r===`vec2u`||r===`vec3u`||r===`vec4u`||r===`vec2h`||r===`vec3h`||r===`vec4h`||r===`vec2b`||r===`vec3b`||r===`vec4b`||r===`mat2x2`||r===`mat2x3`||r===`mat2x4`||r===`mat3x2`||r===`mat3x3`||r===`mat3x4`||r===`mat4x2`||r===`mat4x3`||r===`mat4x4`||r===`mat2x2f`||r===`mat2x3f`||r===`mat2x4f`||r===`mat3x2f`||r===`mat3x3f`||r===`mat3x4f`||r===`mat4x2f`||r===`mat4x3f`||r===`mat4x4f`||r===`mat2x2h`||r===`mat2x3h`||r===`mat2x4h`||r===`mat3x2h`||r===`mat3x3h`||r===`mat3x4h`||r===`mat4x2h`||r===`mat4x3h`||r===`mat4x4h`||e.type instanceof qe||e.type instanceof Ge||e.type instanceof L){let r=new Ze(e.type,[]);n=this._evalCreate(r,t)}}t.createVariable(e.name,n,e)}_switch(e,t){t=t.clone();let n=this.evalExpression(e.condition,t);if(!(n instanceof B))return console.error(`Invalid if condition. Line ${e.line}`),null;let r=null;for(let i of e.cases)if(i instanceof st)for(let a of i.selectors){if(a instanceof ot){r=i;continue}let o=this.evalExpression(a,t);if(!(o instanceof B))return console.error(`Invalid case selector. Line ${e.line}`),null;if(o.value===n.value)return this._execStatements(i.body,t)}else i instanceof ct&&(r=i);return r?this._execStatements(r.body,t):null}_if(e,t){t=t.clone();let n=this.evalExpression(e.condition,t);if(!(n instanceof B))return console.error(`Invalid if condition. Line ${e.line}`),null;if(n.value)return this._execStatements(e.body,t);for(let n of e.elseif){let r=this.evalExpression(n.condition,t);if(!(r instanceof B))return console.error(`Invalid if condition. Line ${e.line}`),null;if(r.value)return this._execStatements(n.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof B?e.value:(console.error(`Expected scalar value.`,e),0)}_for(t,n){for(n=n.clone(),this.execStatement(t.init,n);this._getScalarValue(this.evalExpression(t.condition,n));){let r=this._execStatements(t.body,n);if(r===e._breakObj)break;if(r!==null&&r!==e._continueObj)return r;this.execStatement(t.increment,n)}return null}_loop(t,n){for(n=n.clone();;){let r=this._execStatements(t.body,n);if(r===e._breakObj)break;if(r===e._continueObj){if(t.continuing&&this._execStatements(t.continuing.body,n)===e._breakObj)break}else if(r!==null)return r}return null}_while(t,n){for(n=n.clone();this._getScalarValue(this.evalExpression(t.condition,n));){let r=this._execStatements(t.body,n);if(r===e._breakObj)break;if(r!==e._continueObj&&r!==null)return r}return null}_evalBitcast(e,t){let n=this.evalExpression(e.value,t),r=e.type;if(n instanceof B){let e=kt(n.value,n.typeInfo.name,r.name);return new B(e,this.getTypeInfo(r))}if(n instanceof V){let t=n.typeInfo.getTypeName(),i=``;if(t.endsWith(`f`))i=`f32`;else if(t.endsWith(`i`))i=`i32`;else if(t.endsWith(`u`))i=`u32`;else if(t.endsWith(`b`))i=`bool`;else{if(!t.endsWith(`h`))return console.error(`Unknown vector type ${t}. Line ${e.line}`),null;i=`f16`}let a=r.getTypeName(),o=``;if(a.endsWith(`f`))o=`f32`;else if(a.endsWith(`i`))o=`i32`;else if(a.endsWith(`u`))o=`u32`;else if(a.endsWith(`b`))o=`bool`;else{if(!a.endsWith(`h`))return console.error(`Unknown vector type ${o}. Line ${e.line}`),null;o=`f16`}let s=((e,t,n)=>{if(t===n)return e;let r=Array(e.length);for(let i=0;i<e.length;i++)r[i]=kt(e[i],t,n);return r})(Array.from(n.data),i,o);return new V(s,this.getTypeInfo(r))}return console.error(`TODO: bitcast for ${n.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){return t.getVariableValue(e.name).clone().getSubData(this,e.postfix,t)}_evalCreate(e,t){if(e instanceof Ze){if(e.type===null)return mt.void;switch(e.type.getTypeName()){case`bool`:case`i32`:case`u32`:case`f32`:case`f16`:return this._callConstructorValue(e,t);case`vec2`:case`vec3`:case`vec4`:case`vec2f`:case`vec3f`:case`vec4f`:case`vec2h`:case`vec3h`:case`vec4h`:case`vec2i`:case`vec3i`:case`vec4i`:case`vec2u`:case`vec3u`:case`vec4u`:case`vec2b`:case`vec3b`:case`vec4b`:return this._callConstructorVec(e,t);case`mat2x2`:case`mat2x2f`:case`mat2x2h`:case`mat2x3`:case`mat2x3f`:case`mat2x3h`:case`mat2x4`:case`mat2x4f`:case`mat2x4h`:case`mat3x2`:case`mat3x2f`:case`mat3x2h`:case`mat3x3`:case`mat3x3f`:case`mat3x3h`:case`mat3x4`:case`mat3x4f`:case`mat3x4h`:case`mat4x2`:case`mat4x2f`:case`mat4x2h`:case`mat4x3`:case`mat4x3f`:case`mat4x3h`:case`mat4x4`:case`mat4x4f`:case`mat4x4h`:return this._callConstructorMatrix(e,t)}}let n=e instanceof Ze?e.type.name:e.name,r=e instanceof Ze?this.getTypeInfo(e.type):this.getTypeInfo(e.name);if(r===null)return console.error(`Unknown type ${n}. Line ${e.line}`),null;if(r.size===0)return null;let i=new U(new ArrayBuffer(r.size),r,0);if(r instanceof w){if(e.args)for(let n=0;n<e.args.length;++n){let a=r.members[n],o=e.args[n],s=this.evalExpression(o,t);i.setData(this,s,a.type,a.offset,t)}}else if(r instanceof T){let n=0;if(e.args)for(let a=0;a<e.args.length;++a){let o=e.args[a],s=this.evalExpression(o,t);r.format===null&&(s.typeInfo?.name===`x32`?r.format=this.getTypeInfo(`i32`):r.format=s.typeInfo),i.setData(this,s,r.format,n,t),n+=r.stride}}else console.error(`Unknown type "${n}". Line ${e.line}`);return e instanceof Ze?i.getSubData(this,e.postfix,t):i}_evalLiteral(e,t){let n=this.getTypeInfo(e.type),r=n.name;return r===`x32`||r===`u32`||r===`f32`||r===`f16`||r===`i32`||r===`bool`?new B(e.scalarValue,n):r===`vec2`||r===`vec3`||r===`vec4`||r===`vec2f`||r===`vec3f`||r===`vec4f`||r===`vec2h`||r===`vec3h`||r===`vec4h`||r===`vec2i`||r===`vec3i`||r===`vec4i`||r===`vec2u`||r===`vec3u`||r===`vec4u`?this._callConstructorVec(e,t):r===`mat2x2`||r===`mat2x3`||r===`mat2x4`||r===`mat3x2`||r===`mat3x3`||r===`mat3x4`||r===`mat4x2`||r===`mat4x3`||r===`mat4x4`||r===`mat2x2f`||r===`mat2x3f`||r===`mat2x4f`||r===`mat3x2f`||r===`mat3x3f`||r===`mat3x4f`||r===`mat4x2f`||r===`mat4x3f`||r===`mat4x4f`||r===`mat2x2h`||r===`mat2x3h`||r===`mat2x4h`||r===`mat3x2h`||r===`mat3x3h`||r===`mat3x4h`||r===`mat4x2h`||r===`mat4x3h`||r===`mat4x4h`?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){let n=t.getVariableValue(e.name);return n===null?n:n.getSubData(this,e.postfix,t)}_maxFormatTypeInfo(t){let n=t[0];if(n.name===`f32`)return n;for(let r=1;r<t.length;++r){let i=e._priority.get(n.name);e._priority.get(t[r].name)<i&&(n=t[r])}return n.name===`x32`?this.getTypeInfo(`i32`):n}_evalUnaryOp(e,t){let n=this.evalExpression(e.right,t);if(e.operator===`&`)return new ht(n);if(e.operator===`*`)return n instanceof ht?n.reference.getSubData(this,e.postfix,t):(console.error(`Invalid dereference. Line ${e.line}`),null);let r=n instanceof B?n.value:n instanceof V?Array.from(n.data):null;switch(e.operator){case`+`:{if(K(r)){let e=r.map((e,t)=>+e);return new V(e,n.typeInfo)}let e=r,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new B(+e,t)}case`-`:{if(K(r)){let e=r.map((e,t)=>-e);return new V(e,n.typeInfo)}let e=r,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new B(-e,t)}case`!`:{if(K(r)){let e=r.map((e,t)=>e?0:1);return new V(e,n.typeInfo)}let e=r,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new B(e?0:1,t)}case`~`:{if(K(r)){let e=r.map((e,t)=>~e);return new V(e,n.typeInfo)}let e=r,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new B(~e,t)}}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){let n=this.evalExpression(e.left,t),r=this.evalExpression(e.right,t),i=n instanceof B?n.value:n instanceof V||n instanceof H?Array.from(n.data):null,a=r instanceof B?r.value:r instanceof V||r instanceof H?Array.from(r.data):null;switch(e.operator){case`+`:{if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e+r[t]);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t+e);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e+t);return new V(t,r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new B(t+o,s)}case`-`:{if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e-r[t]);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t-e);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e-t);return new V(t,r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new B(t-o,s)}case`*`:{if(K(i)&&K(a)){let t=i,o=a;if(n instanceof H&&r instanceof H){let i=((e,t,n,r)=>{if(Bt[t.name]===void 0||Bt[r.name]===void 0)return null;let i=Bt[t.name][0],a=Bt[t.name][1],o=Bt[r.name][0];if(i!==Bt[r.name][1])return null;let s=Array(o*a);for(let t=0;t<a;t++)for(let r=0;r<o;r++){let c=0;for(let o=0;o<i;o++)c+=e[o*a+t]*n[r*i+o];s[t*o+r]=c}return s})(t,n.typeInfo,o,r.typeInfo);if(i===null)return console.error(`Matrix multiplication failed. Line ${e.line}.`),null;let a=Bt[r.typeInfo.name][0],s=Bt[n.typeInfo.name][1],c=this.getTypeInfo(`mat${a}x${s}f`);return new H(i,c)}if(n instanceof H&&r instanceof V){let i=((e,t,n,r)=>{if(Bt[t.name]===void 0||zt[r.name]===void 0)return null;let i=Bt[t.name][0],a=Bt[t.name][1];if(i!==n.length)return null;let o=Array(a);for(let t=0;t<a;t++){let r=0;for(let o=0;o<i;o++)r+=e[o*a+t]*n[o];o[t]=r}return o})(t,n.typeInfo,o,r.typeInfo);return i===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new V(i,r.typeInfo)}if(n instanceof V&&r instanceof H){let i=((e,t,n,r)=>{if(zt[t.name]===void 0||Bt[r.name]===void 0)return null;let i=Bt[r.name][0],a=Bt[r.name][1];if(a!==e.length)return null;let o=[];for(let t=0;t<i;t++){let r=0;for(let o=0;o<a;o++)r+=e[o]*n[o*i+t];o[t]=r}return o})(t,n.typeInfo,o,r.typeInfo);return i===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new V(i,n.typeInfo)}{if(t.length!==o.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let r=t.map((e,t)=>e*o[t]);return new V(r,n.typeInfo)}}if(K(i)){let e=a,t=i.map((t,n)=>t*e);return n instanceof H?new H(t,n.typeInfo):new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e*t);return r instanceof H?new H(t,r.typeInfo):new V(t,r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new B(t*o,s)}case`%`:{if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e%r[t]);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t%e);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e%t);return new V(t,r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new B(t%o,s)}case`/`:{if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e/r[t]);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t/e);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e/t);return new V(t,r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new B(t/o,s)}case`&`:{if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e&r[t]);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t&e);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e&t);return new V(t,r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new B(t&o,s)}case`|`:{if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e|r[t]);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t|e);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e|t);return new V(t,r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new B(t|o,s)}case`^`:{if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e^r[t]);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t^e);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e^t);return new V(t,r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new B(t^o,s)}case`<<`:{if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e<<r[t]);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t<<e);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e<<t);return new V(t,r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new B(t<<o,s)}case`>>`:{if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e>>r[t]);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t>>e);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e>>t);return new V(t,r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new B(t>>o,s)}case`>`:if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e>r[t]?1:0);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t>e?1:0);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e>t?1:0);return new V(t,r.typeInfo)}return new B(i>a?1:0,this.getTypeInfo(`bool`));case`<`:if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e<r[t]?1:0);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t<e?1:0);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e<t?1:0);return new V(t,r.typeInfo)}return new B(i<a?1:0,this.getTypeInfo(`bool`));case`==`:if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e===r[t]?1:0);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t==e?1:0);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e==t?1:0);return new V(t,r.typeInfo)}return new B(i===a?1:0,this.getTypeInfo(`bool`));case`!=`:if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e===r[t]?0:1);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t===e?0:1);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e===t?0:1);return new V(t,r.typeInfo)}return new B(i===a?0:1,this.getTypeInfo(`bool`));case`>=`:if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e>=r[t]?1:0);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t>=e?1:0);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e>=t?1:0);return new V(t,r.typeInfo)}return new B(i>=a?1:0,this.getTypeInfo(`bool`));case`<=`:if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e<=r[t]?1:0);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t<=e?1:0);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e<=t?1:0);return new V(t,r.typeInfo)}return new B(i<=a?1:0,this.getTypeInfo(`bool`));case`&&`:if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e&&r[t]?1:0);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t&&e?1:0);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e&&t?1:0);return new V(t,r.typeInfo)}return new B(i&&a?1:0,this.getTypeInfo(`bool`));case`||`:if(K(i)&&K(a)){let t=i,r=a;if(t.length!==r.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;let o=t.map((e,t)=>e||r[t]?1:0);return new V(o,n.typeInfo)}if(K(i)){let e=a,t=i.map((t,n)=>t||e?1:0);return new V(t,n.typeInfo)}if(K(a)){let e=i,t=a.map((t,n)=>e||t?1:0);return new V(t,r.typeInfo)}return new B(i||a?1:0,this.getTypeInfo(`bool`))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(e.cachedReturnValue!==null)return e.cachedReturnValue;let n=t.clone();n.currentFunctionName=e.name;let r=t.getFunction(e.name);if(!r)return e.isBuiltin?this._callBuiltinFunction(e,n):this.getTypeInfo(e.name)?this._evalCreate(e,t):(console.error(`Unknown function "${e.name}". Line ${e.line}`),null);for(let t=0;t<r.node.args.length;++t){let i=r.node.args[t],a=this.evalExpression(e.args[t],n);n.createVariable(i.name,a,i)}return this._execStatements(r.node.body,n)}_callBuiltinFunction(e,t){switch(e.name){case`all`:return this.builtins.All(e,t);case`any`:return this.builtins.Any(e,t);case`select`:return this.builtins.Select(e,t);case`arrayLength`:return this.builtins.ArrayLength(e,t);case`abs`:return this.builtins.Abs(e,t);case`acos`:return this.builtins.Acos(e,t);case`acosh`:return this.builtins.Acosh(e,t);case`asin`:return this.builtins.Asin(e,t);case`asinh`:return this.builtins.Asinh(e,t);case`atan`:return this.builtins.Atan(e,t);case`atanh`:return this.builtins.Atanh(e,t);case`atan2`:return this.builtins.Atan2(e,t);case`ceil`:return this.builtins.Ceil(e,t);case`clamp`:return this.builtins.Clamp(e,t);case`cos`:return this.builtins.Cos(e,t);case`cosh`:return this.builtins.Cosh(e,t);case`countLeadingZeros`:return this.builtins.CountLeadingZeros(e,t);case`countOneBits`:return this.builtins.CountOneBits(e,t);case`countTrailingZeros`:return this.builtins.CountTrailingZeros(e,t);case`cross`:return this.builtins.Cross(e,t);case`degrees`:return this.builtins.Degrees(e,t);case`determinant`:return this.builtins.Determinant(e,t);case`distance`:return this.builtins.Distance(e,t);case`dot`:return this.builtins.Dot(e,t);case`dot4U8Packed`:return this.builtins.Dot4U8Packed(e,t);case`dot4I8Packed`:return this.builtins.Dot4I8Packed(e,t);case`exp`:return this.builtins.Exp(e,t);case`exp2`:return this.builtins.Exp2(e,t);case`extractBits`:return this.builtins.ExtractBits(e,t);case`faceForward`:return this.builtins.FaceForward(e,t);case`firstLeadingBit`:return this.builtins.FirstLeadingBit(e,t);case`firstTrailingBit`:return this.builtins.FirstTrailingBit(e,t);case`floor`:return this.builtins.Floor(e,t);case`fma`:return this.builtins.Fma(e,t);case`fract`:return this.builtins.Fract(e,t);case`frexp`:return this.builtins.Frexp(e,t);case`insertBits`:return this.builtins.InsertBits(e,t);case`inverseSqrt`:return this.builtins.InverseSqrt(e,t);case`ldexp`:return this.builtins.Ldexp(e,t);case`length`:return this.builtins.Length(e,t);case`log`:return this.builtins.Log(e,t);case`log2`:return this.builtins.Log2(e,t);case`max`:return this.builtins.Max(e,t);case`min`:return this.builtins.Min(e,t);case`mix`:return this.builtins.Mix(e,t);case`modf`:return this.builtins.Modf(e,t);case`normalize`:return this.builtins.Normalize(e,t);case`pow`:return this.builtins.Pow(e,t);case`quantizeToF16`:return this.builtins.QuantizeToF16(e,t);case`radians`:return this.builtins.Radians(e,t);case`reflect`:return this.builtins.Reflect(e,t);case`refract`:return this.builtins.Refract(e,t);case`reverseBits`:return this.builtins.ReverseBits(e,t);case`round`:return this.builtins.Round(e,t);case`saturate`:return this.builtins.Saturate(e,t);case`sign`:return this.builtins.Sign(e,t);case`sin`:return this.builtins.Sin(e,t);case`sinh`:return this.builtins.Sinh(e,t);case`smoothstep`:return this.builtins.SmoothStep(e,t);case`sqrt`:return this.builtins.Sqrt(e,t);case`step`:return this.builtins.Step(e,t);case`tan`:return this.builtins.Tan(e,t);case`tanh`:return this.builtins.Tanh(e,t);case`transpose`:return this.builtins.Transpose(e,t);case`trunc`:return this.builtins.Trunc(e,t);case`dpdx`:return this.builtins.Dpdx(e,t);case`dpdxCoarse`:return this.builtins.DpdxCoarse(e,t);case`dpdxFine`:return this.builtins.DpdxFine(e,t);case`dpdy`:return this.builtins.Dpdy(e,t);case`dpdyCoarse`:return this.builtins.DpdyCoarse(e,t);case`dpdyFine`:return this.builtins.DpdyFine(e,t);case`fwidth`:return this.builtins.Fwidth(e,t);case`fwidthCoarse`:return this.builtins.FwidthCoarse(e,t);case`fwidthFine`:return this.builtins.FwidthFine(e,t);case`textureDimensions`:return this.builtins.TextureDimensions(e,t);case`textureGather`:return this.builtins.TextureGather(e,t);case`textureGatherCompare`:return this.builtins.TextureGatherCompare(e,t);case`textureLoad`:return this.builtins.TextureLoad(e,t);case`textureNumLayers`:return this.builtins.TextureNumLayers(e,t);case`textureNumLevels`:return this.builtins.TextureNumLevels(e,t);case`textureNumSamples`:return this.builtins.TextureNumSamples(e,t);case`textureSample`:return this.builtins.TextureSample(e,t);case`textureSampleBias`:return this.builtins.TextureSampleBias(e,t);case`textureSampleCompare`:return this.builtins.TextureSampleCompare(e,t);case`textureSampleCompareLevel`:return this.builtins.TextureSampleCompareLevel(e,t);case`textureSampleGrad`:return this.builtins.TextureSampleGrad(e,t);case`textureSampleLevel`:return this.builtins.TextureSampleLevel(e,t);case`textureSampleBaseClampToEdge`:return this.builtins.TextureSampleBaseClampToEdge(e,t);case`textureStore`:return this.builtins.TextureStore(e,t);case`atomicLoad`:return this.builtins.AtomicLoad(e,t);case`atomicStore`:return this.builtins.AtomicStore(e,t);case`atomicAdd`:return this.builtins.AtomicAdd(e,t);case`atomicSub`:return this.builtins.AtomicSub(e,t);case`atomicMax`:return this.builtins.AtomicMax(e,t);case`atomicMin`:return this.builtins.AtomicMin(e,t);case`atomicAnd`:return this.builtins.AtomicAnd(e,t);case`atomicOr`:return this.builtins.AtomicOr(e,t);case`atomicXor`:return this.builtins.AtomicXor(e,t);case`atomicExchange`:return this.builtins.AtomicExchange(e,t);case`atomicCompareExchangeWeak`:return this.builtins.AtomicCompareExchangeWeak(e,t);case`pack4x8snorm`:return this.builtins.Pack4x8snorm(e,t);case`pack4x8unorm`:return this.builtins.Pack4x8unorm(e,t);case`pack4xI8`:return this.builtins.Pack4xI8(e,t);case`pack4xU8`:return this.builtins.Pack4xU8(e,t);case`pack4x8Clamp`:return this.builtins.Pack4x8Clamp(e,t);case`pack4xU8Clamp`:return this.builtins.Pack4xU8Clamp(e,t);case`pack2x16snorm`:return this.builtins.Pack2x16snorm(e,t);case`pack2x16unorm`:return this.builtins.Pack2x16unorm(e,t);case`pack2x16float`:return this.builtins.Pack2x16float(e,t);case`unpack4x8snorm`:return this.builtins.Unpack4x8snorm(e,t);case`unpack4x8unorm`:return this.builtins.Unpack4x8unorm(e,t);case`unpack4xI8`:return this.builtins.Unpack4xI8(e,t);case`unpack4xU8`:return this.builtins.Unpack4xU8(e,t);case`unpack2x16snorm`:return this.builtins.Unpack2x16snorm(e,t);case`unpack2x16unorm`:return this.builtins.Unpack2x16unorm(e,t);case`unpack2x16float`:return this.builtins.Unpack2x16float(e,t);case`storageBarrier`:return this.builtins.StorageBarrier(e,t);case`textureBarrier`:return this.builtins.TextureBarrier(e,t);case`workgroupBarrier`:return this.builtins.WorkgroupBarrier(e,t);case`workgroupUniformLoad`:return this.builtins.WorkgroupUniformLoad(e,t);case`subgroupAdd`:return this.builtins.SubgroupAdd(e,t);case`subgroupExclusiveAdd`:return this.builtins.SubgroupExclusiveAdd(e,t);case`subgroupInclusiveAdd`:return this.builtins.SubgroupInclusiveAdd(e,t);case`subgroupAll`:return this.builtins.SubgroupAll(e,t);case`subgroupAnd`:return this.builtins.SubgroupAnd(e,t);case`subgroupAny`:return this.builtins.SubgroupAny(e,t);case`subgroupBallot`:return this.builtins.SubgroupBallot(e,t);case`subgroupBroadcast`:return this.builtins.SubgroupBroadcast(e,t);case`subgroupBroadcastFirst`:return this.builtins.SubgroupBroadcastFirst(e,t);case`subgroupElect`:return this.builtins.SubgroupElect(e,t);case`subgroupMax`:return this.builtins.SubgroupMax(e,t);case`subgroupMin`:return this.builtins.SubgroupMin(e,t);case`subgroupMul`:return this.builtins.SubgroupMul(e,t);case`subgroupExclusiveMul`:return this.builtins.SubgroupExclusiveMul(e,t);case`subgroupInclusiveMul`:return this.builtins.SubgroupInclusiveMul(e,t);case`subgroupOr`:return this.builtins.SubgroupOr(e,t);case`subgroupShuffle`:return this.builtins.SubgroupShuffle(e,t);case`subgroupShuffleDown`:return this.builtins.SubgroupShuffleDown(e,t);case`subgroupShuffleUp`:return this.builtins.SubgroupShuffleUp(e,t);case`subgroupShuffleXor`:return this.builtins.SubgroupShuffleXor(e,t);case`subgroupXor`:return this.builtins.SubgroupXor(e,t);case`quadBroadcast`:return this.builtins.QuadBroadcast(e,t);case`quadSwapDiagonal`:return this.builtins.QuadSwapDiagonal(e,t);case`quadSwapX`:return this.builtins.QuadSwapX(e,t);case`quadSwapY`:return this.builtins.QuadSwapY(e,t)}let n=t.getFunction(e.name);if(n){let r=t.clone();for(let t=0;t<n.node.args.length;++t){let i=n.node.args[t],a=this.evalExpression(e.args[t],r);r.setVariable(i.name,a,i)}return this._execStatements(n.node.body,r)}return null}_callConstructorValue(e,t){if(!e.args||e.args.length===0)return new B(0,this.getTypeInfo(e.type));let n=this.evalExpression(e.args[0],t);return n.typeInfo=this.getTypeInfo(e.type),n.getSubData(this,e.postfix,t).clone()}_callConstructorVec(e,t){let n=this.getTypeInfo(e.type),r=e.type.getTypeName(),i=zt[r];if(i===void 0)return console.error(`Invalid vec constructor ${r}. Line ${e.line}`),null;let a=[];if(e instanceof R)if(e.isVector){let t=e.vectorValue;for(let e of t)a.push(e)}else a.push(e.scalarValue);else if(e.args)for(let n of e.args){let e=this.evalExpression(n,t);if(e instanceof V){let t=e.data;for(let e=0;e<t.length;++e){let n=t[e];a.push(n)}}else if(e instanceof B){let t=e.value;a.push(t)}}if(e.type instanceof L&&e.type.format===null&&(e.type.format=L.f32),a.length===0){let r=Array(i).fill(0);return new V(r,n).getSubData(this,e.postfix,t)}if(a.length===1)for(;a.length<i;)a.push(a[0]);return a.length<i?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new V(a.length>i?a.slice(0,i):a,n).getSubData(this,e.postfix,t)}_callConstructorMatrix(e,t){let n=this.getTypeInfo(e.type),r=e.type.getTypeName(),i=Bt[r];if(i===void 0)return console.error(`Invalid matrix constructor ${r}. Line ${e.line}`),null;let a=[];if(e instanceof R)if(e.isVector){let t=e.vectorValue;for(let e of t)a.push(e)}else a.push(e.scalarValue);else if(e.args)for(let n of e.args){let e=this.evalExpression(n,t);e instanceof V?a.push(...e.data):e instanceof B?a.push(e.value):e instanceof H&&a.push(...e.data)}if(n instanceof D&&n.format===null&&(n.format=this.getTypeInfo(`f32`)),a.length===0){let r=Array(i[2]).fill(0);return new H(r,n).getSubData(this,e.postfix,t)}return a.length===i[2]?new H(a,n).getSubData(this,e.postfix,t):(console.error(`Invalid matrix constructor. Line ${e.line}`),null)}};Vt._breakObj=new pt(new S(`BREAK`,null),null),Vt._continueObj=new pt(new S(`CONTINUE`,null),null),Vt._priority=new Map([[`f32`,0],[`f16`,1],[`u32`,2],[`i32`,3],[`x32`,3]]);var Ht=class{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}},Ut=class{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new Ht,this._exec=new Vt,this._forwardTypeCount=0}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;let t=[];for(;!this._isAtEnd();){let e=this._global_decl_or_directive();if(!e)break;t.push(e)}if(this._deferArrayCountEval.length>0){for(let e of this._deferArrayCountEval){let t=e.arrayType,n=e.countNode;if(n instanceof $e){let e=n.name,r=this._context.constants.get(e);if(r)try{t.count=r.constEvaluate(this._exec)}catch{}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(let e of t)e.search(e=>{e instanceof dt||e instanceof Ke?e.type=this._forwardType(e.type):e instanceof qe?e.format=this._forwardType(e.format):e instanceof we||e instanceof Ee||e instanceof De?e.type=this._forwardType(e.type):e instanceof ye?e.returnType=this._forwardType(e.returnType):e instanceof lt&&(e.type=this._forwardType(e.type))});return t}_forwardType(e){if(e instanceof We){let t=this._getType(e.name);if(t)return t}else e instanceof Ke?e.type=this._forwardType(e.type):e instanceof qe&&(e.format=this._forwardType(e.format));return e}_initialize(e){e?typeof e==`string`?this._tokens=new yt(e).scanTokens():this._tokens=e:this._tokens=[],this._current=0}_updateNode(e,t){return e.line=t??this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==G.eof}_match(e){if(e instanceof W)return!!this._check(e)&&(this._advance(),!0);for(let t=0,n=e.length;t<n;++t){let n=e[t];if(this._check(n))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;let t=this._peek();if(e instanceof Array){let n=t.type,r=!1;for(let t of e){if(n===t)return!0;t===G.tokens.name&&(r=!0)}if(r){let e=G.tokens.name.rule.exec(t.lexeme);if(e&&e.index==0&&e[0]==t.lexeme)return!0}return!1}if(t.type===e)return!0;if(e===G.tokens.name){let e=G.tokens.name.rule.exec(t.lexeme);return e&&e.index==0&&e[0]==t.lexeme}return!1}_advance(){return this._currentLine=this._peek()?.line??-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(G.tokens.semicolon)&&!this._isAtEnd(););if(this._match(G.keywords.alias)){let e=this._type_alias();return this._consume(G.tokens.semicolon,`Expected ';'`),this._exec.reflection.updateAST([e]),e}if(this._match(G.keywords.diagnostic)){let e=this._diagnostic();return this._consume(G.tokens.semicolon,`Expected ';'`),this._exec.reflection.updateAST([e]),e}if(this._match(G.keywords.requires)){let e=this._requires_directive();return this._consume(G.tokens.semicolon,`Expected ';'`),this._exec.reflection.updateAST([e]),e}if(this._match(G.keywords.enable)){let e=this._enable_directive();return this._consume(G.tokens.semicolon,`Expected ';'`),this._exec.reflection.updateAST([e]),e}let e=this._attribute();if(this._check(G.keywords.var)){let t=this._global_variable_decl();return t!=null&&(t.attributes=e),this._consume(G.tokens.semicolon,`Expected ';'.`),this._exec.reflection.updateAST([t]),t}if(this._check(G.keywords.override)){let t=this._override_variable_decl();return t!=null&&(t.attributes=e),this._consume(G.tokens.semicolon,`Expected ';'.`),this._exec.reflection.updateAST([t]),t}if(this._check(G.keywords.let)){let t=this._global_let_decl();return t!=null&&(t.attributes=e),this._consume(G.tokens.semicolon,`Expected ';'.`),this._exec.reflection.updateAST([t]),t}if(this._check(G.keywords.const)){let t=this._global_const_decl();return t!=null&&(t.attributes=e),this._consume(G.tokens.semicolon,`Expected ';'.`),this._exec.reflection.updateAST([t]),t}if(this._check(G.keywords.struct)){let t=this._struct_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(G.keywords.fn)){let t=this._function_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(G.keywords.fn))return null;let e=this._currentLine,t=this._consume(G.tokens.ident,`Expected function name.`).toString();this._consume(G.tokens.paren_left,`Expected '(' for function arguments.`);let n=[];if(!this._check(G.tokens.paren_right))do{if(this._check(G.tokens.paren_right))break;let e=this._attribute(),t=this._consume(G.tokens.name,`Expected argument name.`).toString();this._consume(G.tokens.colon,`Expected ':' for argument type.`);let r=this._attribute(),i=this._type_decl();i!=null&&(i.attributes=r,n.push(this._updateNode(new lt(t,i,e))))}while(this._match(G.tokens.comma));this._consume(G.tokens.paren_right,`Expected ')' after function arguments.`);let r=null;if(this._match(G.tokens.arrow)){let e=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=e)}let i=this._compound_statement(),a=this._currentLine;return this._updateNode(new ye(t,n,r,i,e,a),e)}_compound_statement(){let e=[];for(this._consume(G.tokens.brace_left,`Expected '{' for block.`);!this._check(G.tokens.brace_right);){let t=this._statement();t!==null&&e.push(t)}return this._consume(G.tokens.brace_right,`Expected '}' for block.`),e}_statement(){for(;this._match(G.tokens.semicolon)&&!this._isAtEnd(););if(this._check(G.tokens.attr)&&this._attribute(),this._check(G.keywords.if))return this._if_statement();if(this._check(G.keywords.switch))return this._switch_statement();if(this._check(G.keywords.loop))return this._loop_statement();if(this._check(G.keywords.for))return this._for_statement();if(this._check(G.keywords.while))return this._while_statement();if(this._check(G.keywords.continuing))return this._continuing_statement();if(this._check(G.keywords.static_assert))return this._static_assert_statement();if(this._check(G.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(G.keywords.return))e=this._return_statement();else if(this._check([G.keywords.var,G.keywords.let,G.keywords.const]))e=this._variable_statement();else if(this._match(G.keywords.discard))e=this._updateNode(new Ve);else if(this._match(G.keywords.break)){let t=this._updateNode(new He);this._currentLoop.length>0&&(t.loopId=this._currentLoop[this._currentLoop.length-1].id),e=t,this._check(G.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression())}else if(this._match(G.keywords.continue)){let t=this._updateNode(new Ue);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${t.line}`);t.loopId=this._currentLoop[this._currentLoop.length-1].id,e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return e!=null&&this._consume(G.tokens.semicolon,`Expected ';' after statement.`),e}_static_assert_statement(){if(!this._match(G.keywords.static_assert))return null;let e=this._currentLine,t=this._optional_paren_expression();return this._updateNode(new be(t),e)}_while_statement(){if(!this._match(G.keywords.while))return null;let e=this._updateNode(new xe(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(G.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){let e=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(G.keywords.continuing))return null;let t=this._currentLine,n=this._compound_statement();return this._updateNode(new Se(n,e),t)}_for_statement(){if(!this._match(G.keywords.for))return null;this._consume(G.tokens.paren_left,`Expected '('.`);let e=this._updateNode(new Ce(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(G.tokens.semicolon)?null:this._for_init(),this._consume(G.tokens.semicolon,`Expected ';'.`),e.condition=this._check(G.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(G.tokens.semicolon,`Expected ';'.`),e.increment=this._check(G.tokens.paren_right)?null:this._for_increment(),this._consume(G.tokens.paren_right,`Expected ')'.`),this._check(G.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(G.keywords.var)){let e=this._variable_decl();if(e===null)throw this._error(this._peek(),`Variable declaration expected.`);let t=null;return this._match(G.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new we(e.name,e.type,e.storage,e.access,t),e.line)}if(this._match(G.keywords.let)){let e=this._currentLine,t=this._consume(G.tokens.name,`Expected name for let.`).toString(),n=null;if(this._match(G.tokens.colon)){let e=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=e)}this._consume(G.tokens.equal,`Expected '=' for let.`);let r=this._short_circuit_or_expression();return this._updateNode(new Ee(t,n,null,null,r),e)}if(this._match(G.keywords.const)){let e=this._currentLine,t=this._consume(G.tokens.name,`Expected name for const.`).toString(),n=null;if(this._match(G.tokens.colon)){let e=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=e)}this._consume(G.tokens.equal,`Expected '=' for const.`);let r=this._short_circuit_or_expression();return n===null&&r instanceof R&&(n=r.type),this._updateNode(new De(t,n,null,null,r),e)}return null}_increment_decrement_statement(){let e=this._current,t=this._unary_expression();if(t==null)return null;if(!this._check(G.increment_operators))return this._current=e,null;let n=this._consume(G.increment_operators,`Expected increment operator`);return this._updateNode(new Ae(n.type===G.tokens.plus_plus?Oe.increment:Oe.decrement,t))}_assignment_statement(){let e=null,t=this._currentLine;if(this._check(G.tokens.brace_right))return null;let n=this._match(G.tokens.underscore);if(n||(e=this._unary_expression()),!n&&e==null)return null;let r=this._consume(G.assignment_operators,`Expected assignment operator.`),i=this._short_circuit_or_expression();return this._updateNode(new je(ke.parse(r.lexeme),e,i),t)}_func_call_statement(){if(!this._check(G.tokens.ident))return null;let e=this._currentLine,t=this._current,n=this._consume(G.tokens.ident,`Expected function name.`),r=this._argument_expression_list();return r===null?(this._current=t,null):this._updateNode(new Me(n.lexeme,r),e)}_loop_statement(){if(!this._match(G.keywords.loop))return null;this._check(G.tokens.attr)&&this._attribute(),this._consume(G.tokens.brace_left,`Expected '{' for loop.`);let e=this._updateNode(new Ne([],null));this._currentLoop.push(e);let t=this._statement();for(;t!==null;){if(Array.isArray(t))for(let n of t)e.body.push(n);else e.body.push(t);if(t instanceof Se){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(G.tokens.brace_right,`Expected '}' for loop.`),e}_switch_statement(){if(!this._match(G.keywords.switch))return null;let e=this._updateNode(new Pe(null,[]));if(this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(G.tokens.attr)&&this._attribute(),this._consume(G.tokens.brace_left,`Expected '{' for switch.`),e.cases=this._switch_body(),e.cases==null||e.cases.length==0)throw this._error(this._previous(),`Expected 'case' or 'default'.`);return this._consume(G.tokens.brace_right,`Expected '}' for switch.`),this._currentLoop.pop(),e}_switch_body(){let e=[],t=!1;for(;this._check([G.keywords.default,G.keywords.case]);){if(this._match(G.keywords.case)){let n=this._case_selectors();for(let e of n)if(e instanceof ot){if(t)throw this._error(this._previous(),`Multiple default cases in switch statement.`);t=!0;break}this._match(G.tokens.colon),this._check(G.tokens.attr)&&this._attribute(),this._consume(G.tokens.brace_left,`Exected '{' for switch case.`);let r=this._case_body();this._consume(G.tokens.brace_right,`Exected '}' for switch case.`),e.push(this._updateNode(new st(n,r)))}if(this._match(G.keywords.default)){if(t)throw this._error(this._previous(),`Multiple default cases in switch statement.`);this._match(G.tokens.colon),this._check(G.tokens.attr)&&this._attribute(),this._consume(G.tokens.brace_left,`Exected '{' for switch default.`);let n=this._case_body();this._consume(G.tokens.brace_right,`Exected '}' for switch default.`),e.push(this._updateNode(new ct(n)))}}return e}_case_selectors(){let e=[];for(this._match(G.keywords.default)?e.push(this._updateNode(new ot)):e.push(this._shift_expression());this._match(G.tokens.comma);)this._match(G.keywords.default)?e.push(this._updateNode(new ot)):e.push(this._shift_expression());return e}_case_body(){if(this._match(G.keywords.fallthrough))return this._consume(G.tokens.semicolon,`Expected ';'`),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);let t=this._case_body();return t.length==0?e:[...e,t[0]]}_if_statement(){if(!this._match(G.keywords.if))return null;let e=this._currentLine,t=this._optional_paren_expression();this._check(G.tokens.attr)&&this._attribute();let n=this._compound_statement(),r=[];this._match_elseif()&&(this._check(G.tokens.attr)&&this._attribute(),r=this._elseif_statement(r));let i=null;return this._match(G.keywords.else)&&(this._check(G.tokens.attr)&&this._attribute(),i=this._compound_statement()),this._updateNode(new Fe(t,n,r,i),e)}_match_elseif(){return this._tokens[this._current].type===G.keywords.else&&this._tokens[this._current+1].type===G.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){let t=this._optional_paren_expression(),n=this._compound_statement();return e.push(this._updateNode(new ut(t,n))),this._match_elseif()&&(this._check(G.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(G.keywords.return))return null;let e=this._short_circuit_or_expression();return this._updateNode(new Ie(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(G.tokens.or_or);)e=this._updateNode(new it(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(G.tokens.and_and);)e=this._updateNode(new it(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(G.tokens.or);)e=this._updateNode(new it(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(G.tokens.xor);)e=this._updateNode(new it(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(G.tokens.and);)e=this._updateNode(new it(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){let e=this._relational_expression();return this._match([G.tokens.equal_equal,G.tokens.not_equal])?this._updateNode(new it(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([G.tokens.less_than,G.tokens.greater_than,G.tokens.less_than_equal,G.tokens.greater_than_equal]);)e=this._updateNode(new it(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([G.tokens.shift_left,G.tokens.shift_right]);)e=this._updateNode(new it(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([G.tokens.plus,G.tokens.minus]);)e=this._updateNode(new it(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([G.tokens.star,G.tokens.forward_slash,G.tokens.modulo]);)e=this._updateNode(new it(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([G.tokens.minus,G.tokens.bang,G.tokens.tilde,G.tokens.star,G.tokens.and])?this._updateNode(new z(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){let e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(G.tokens.bracket_left)){let e=this._short_circuit_or_expression();this._consume(G.tokens.bracket_right,`Expected ']'.`);let t=this._updateNode(new nt(e)),n=this._postfix_expression();return n&&(t.postfix=n),t}if(this._match(G.tokens.period)){let e=this._consume(G.tokens.name,`Expected member name.`),t=this._postfix_expression(),n=this._updateNode(new Xe(e.lexeme));return t&&(n.postfix=t),n}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_getType(e){let t=this._getStruct(e);if(t!==null)return t;switch(e){case`void`:return I.void;case`bool`:return I.bool;case`i32`:return I.i32;case`u32`:return I.u32;case`f32`:return I.f32;case`f16`:return I.f16;case`vec2f`:return L.vec2f;case`vec3f`:return L.vec3f;case`vec4f`:return L.vec4f;case`vec2i`:return L.vec2i;case`vec3i`:return L.vec3i;case`vec4i`:return L.vec4i;case`vec2u`:return L.vec2u;case`vec3u`:return L.vec3u;case`vec4u`:return L.vec4u;case`vec2h`:return L.vec2h;case`vec3h`:return L.vec3h;case`vec4h`:return L.vec4h;case`mat2x2f`:return L.mat2x2f;case`mat2x3f`:return L.mat2x3f;case`mat2x4f`:return L.mat2x4f;case`mat3x2f`:return L.mat3x2f;case`mat3x3f`:return L.mat3x3f;case`mat3x4f`:return L.mat3x4f;case`mat4x2f`:return L.mat4x2f;case`mat4x3f`:return L.mat4x3f;case`mat4x4f`:return L.mat4x4f;case`mat2x2h`:return L.mat2x2h;case`mat2x3h`:return L.mat2x3h;case`mat2x4h`:return L.mat2x4h;case`mat3x2h`:return L.mat3x2h;case`mat3x3h`:return L.mat3x3h;case`mat3x4h`:return L.mat3x4h;case`mat4x2h`:return L.mat4x2h;case`mat4x3h`:return L.mat4x3h;case`mat4x4h`:return L.mat4x4h;case`mat2x2i`:return L.mat2x2i;case`mat2x3i`:return L.mat2x3i;case`mat2x4i`:return L.mat2x4i;case`mat3x2i`:return L.mat3x2i;case`mat3x3i`:return L.mat3x3i;case`mat3x4i`:return L.mat3x4i;case`mat4x2i`:return L.mat4x2i;case`mat4x3i`:return L.mat4x3i;case`mat4x4i`:return L.mat4x4i;case`mat2x2u`:return L.mat2x2u;case`mat2x3u`:return L.mat2x3u;case`mat2x4u`:return L.mat2x4u;case`mat3x2u`:return L.mat3x2u;case`mat3x3u`:return L.mat3x3u;case`mat3x4u`:return L.mat3x4u;case`mat4x2u`:return L.mat4x2u;case`mat4x3u`:return L.mat4x3u;case`mat4x4u`:return L.mat4x4u}return null}_validateTypeRange(e,t){if(t.name===`i32`){if(e<-2147483648||e>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if(t.name===`u32`&&(e<0||e>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(G.tokens.ident)){let e=this._previous().toString();if(this._check(G.tokens.paren_left)){let t=this._argument_expression_list(),n=this._getType(e);return n===null?this._updateNode(new Qe(e,t)):this._updateNode(new Ze(n,t))}if(this._context.constants.has(e)){let t=this._context.constants.get(e);return this._updateNode(new et(e,t.value))}return this._updateNode(new $e(e))}if(this._match(G.tokens.int_literal)){let e=this._previous().toString(),t=e.endsWith(`i`)||e.endsWith(`i`)?I.i32:e.endsWith(`u`)||e.endsWith(`U`)?I.u32:I.x32,n=parseInt(e);return this._validateTypeRange(n,t),this._updateNode(new R(new B(n,this._exec.getTypeInfo(t)),t))}if(this._match(G.tokens.uint_literal)){let e=parseInt(this._previous().toString());return this._validateTypeRange(e,I.u32),this._updateNode(new R(new B(e,this._exec.getTypeInfo(I.u32)),I.u32))}if(this._match([G.tokens.decimal_float_literal,G.tokens.hex_float_literal])){let e=this._previous().toString(),t=e.endsWith(`h`);t&&(e=e.substring(0,e.length-1));let n=parseFloat(e);this._validateTypeRange(n,t?I.f16:I.f32);let r=t?I.f16:I.f32;return this._updateNode(new R(new B(n,this._exec.getTypeInfo(r)),r))}if(this._match([G.keywords.true,G.keywords.false])){let e=this._previous().toString()===G.keywords.true.rule;return this._updateNode(new R(new B(e?1:0,this._exec.getTypeInfo(I.bool)),I.bool))}if(this._check(G.tokens.paren_left))return this._paren_expression();if(this._match(G.keywords.bitcast)){this._consume(G.tokens.less_than,`Expected '<'.`);let e=this._type_decl();this._consume(G.tokens.greater_than,`Expected '>'.`);let t=this._paren_expression();return this._updateNode(new tt(e,t))}let e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new Ze(e,t))}_argument_expression_list(){if(!this._match(G.tokens.paren_left))return null;let e=[];do{if(this._check(G.tokens.paren_right))break;let t=this._short_circuit_or_expression();e.push(t)}while(this._match(G.tokens.comma));return this._consume(G.tokens.paren_right,`Expected ')' for agument list`),e}_optional_paren_expression(){this._match(G.tokens.paren_left);let e=this._short_circuit_or_expression();return this._match(G.tokens.paren_right),e}_paren_expression(){this._consume(G.tokens.paren_left,`Expected '('.`);let e=this._short_circuit_or_expression();return this._consume(G.tokens.paren_right,`Expected ')'.`),e}_struct_decl(){if(!this._match(G.keywords.struct))return null;let e=this._currentLine,t=this._consume(G.tokens.ident,`Expected name for struct.`).toString();this._consume(G.tokens.brace_left,`Expected '{' for struct body.`);let n=[];for(;!this._check(G.tokens.brace_right);){let e=this._attribute(),t=this._consume(G.tokens.name,`Expected variable name.`).toString();this._consume(G.tokens.colon,`Expected ':' for struct member type.`);let r=this._attribute(),i=this._type_decl();i!=null&&(i.attributes=r),this._check(G.tokens.brace_right)?this._match(G.tokens.comma):this._consume(G.tokens.comma,`Expected ',' for struct member.`),n.push(this._updateNode(new dt(t,i,e)))}this._consume(G.tokens.brace_right,`Expected '}' after struct body.`);let r=this._currentLine,i=this._updateNode(new Ge(t,n,e,r),e);return this._context.structs.set(t,i),i}_global_variable_decl(){let e=this._variable_decl();if(!e)return null;if(this._match(G.tokens.equal)&&(e.value=this._const_expression()),e.type!==null&&e.value instanceof R){if(e.value.type.name!==`x32`&&e.type.getTypeName()!==e.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else e.type===null&&e.value instanceof R&&(e.type=e.value.type.name===`x32`?I.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){let e=this._override_decl();return e&&this._match(G.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){if(!this._match(G.keywords.const))return null;let e=this._consume(G.tokens.name,`Expected variable name`),t=this._currentLine,n=null;if(this._match(G.tokens.colon)){let e=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=e)}let r=null;this._consume(G.tokens.equal,`const declarations require an assignment`);let i=this._short_circuit_or_expression();try{let t=[I.f32],n=i.constEvaluate(this._exec,t);n instanceof B&&this._validateTypeRange(n.value,t[0]),t[0]instanceof L&&t[0].format===null&&n.typeInfo instanceof D&&n.typeInfo.format!==null&&(n.typeInfo.format.name===`f16`?t[0].format=I.f16:n.typeInfo.format.name===`f32`?t[0].format=I.f32:n.typeInfo.format.name===`i32`?t[0].format=I.i32:n.typeInfo.format.name===`u32`?t[0].format=I.u32:n.typeInfo.format.name===`bool`?t[0].format=I.bool:console.error(`TODO: impelement template format type ${n.typeInfo.format.name}`)),r=this._updateNode(new R(n,t[0])),this._exec.context.setVariable(e.toString(),n)}catch{r=i}if(n!==null&&r instanceof R){if(r.type.name!==`x32`&&n.getTypeName()!==r.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${r.type.name} to ${n.name}. Line:${this._currentLine}`);r.type=n,r.isScalar&&this._validateTypeRange(r.scalarValue,r.type)}else n===null&&r instanceof R&&(n=r?.type??I.f32,n===I.x32&&(n=I.i32));let a=this._updateNode(new De(e.toString(),n,``,``,r),t);return this._context.constants.set(a.name,a),a}_global_let_decl(){if(!this._match(G.keywords.let))return null;let e=this._currentLine,t=this._consume(G.tokens.name,`Expected variable name`),n=null;if(this._match(G.tokens.colon)){let e=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=e)}let r=null;if(this._match(G.tokens.equal)&&(r=this._const_expression()),n!==null&&r instanceof R){if(r.type.name!==`x32`&&n.getTypeName()!==r.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${r.type.name} to ${n.name}. Line:${this._currentLine}`);r.type=n}else n===null&&r instanceof R&&(n=r.type.name===`x32`?I.i32:r.type);return r instanceof R&&r.isScalar&&this._validateTypeRange(r.scalarValue,n),this._updateNode(new Ee(t.toString(),n,``,``,r),e)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(G.keywords.var))return null;let e=this._currentLine,t=``,n=``;this._match(G.tokens.less_than)&&(t=this._consume(G.storage_class,`Expected storage_class.`).toString(),this._match(G.tokens.comma)&&(n=this._consume(G.access_mode,`Expected access_mode.`).toString()),this._consume(G.tokens.greater_than,`Expected '>'.`));let r=this._consume(G.tokens.name,`Expected variable name`),i=null;if(this._match(G.tokens.colon)){let e=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=e)}return this._updateNode(new we(r.toString(),i,t,n,null),e)}_override_decl(){if(!this._match(G.keywords.override))return null;let e=this._consume(G.tokens.name,`Expected variable name`),t=null;if(this._match(G.tokens.colon)){let e=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=e)}return this._updateNode(new Te(e.toString(),t,null))}_diagnostic(){this._consume(G.tokens.paren_left,`Expected '('`);let e=this._consume(G.tokens.ident,`Expected severity control name.`);this._consume(G.tokens.comma,`Expected ','`);let t=this._consume(G.tokens.ident,`Expected diagnostic rule name.`).toString();return this._match(G.tokens.period)&&(t+=`.${this._consume(G.tokens.ident,`Expected diagnostic message.`).toString()}`),this._consume(G.tokens.paren_right,`Expected ')'`),this._updateNode(new ze(e.toString(),t))}_enable_directive(){let e=this._consume(G.tokens.ident,`identity expected.`);return this._updateNode(new Le(e.toString()))}_requires_directive(){let e=[this._consume(G.tokens.ident,`identity expected.`).toString()];for(;this._match(G.tokens.comma);){let t=this._consume(G.tokens.ident,`identity expected.`);e.push(t.toString())}return this._updateNode(new Re(e))}_type_alias(){let e=this._consume(G.tokens.ident,`identity expected.`);this._consume(G.tokens.equal,`Expected '=' for type alias.`);let t=this._type_decl();if(t===null)throw this._error(this._peek(),`Expected Type for Alias.`);this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);let n=this._updateNode(new Be(e.toString(),t));return this._context.aliases.set(n.name,n),n}_type_decl(){if(this._check([G.tokens.ident,...G.texel_format,G.keywords.bool,G.keywords.f32,G.keywords.i32,G.keywords.u32])){let e=this._advance().toString();if(this._context.structs.has(e))return this._context.structs.get(e);if(this._context.aliases.has(e))return this._context.aliases.get(e).type;if(!this._getType(e)){let t=this._updateNode(new We(e));return this._forwardTypeCount++,t}return this._updateNode(new I(e))}let e=this._texture_sampler_types();if(e)return e;if(this._check(G.template_types)){let e=this._advance().toString(),t=null,n=null;return this._match(G.tokens.less_than)&&(t=this._type_decl(),n=null,this._match(G.tokens.comma)&&(n=this._consume(G.access_mode,`Expected access_mode for pointer`).toString()),this._consume(G.tokens.greater_than,`Expected '>' for type.`)),this._updateNode(new L(e,t,n))}if(this._match(G.keywords.ptr)){let e=this._previous().toString();this._consume(G.tokens.less_than,`Expected '<' for pointer.`);let t=this._consume(G.storage_class,`Expected storage_class for pointer`);this._consume(G.tokens.comma,`Expected ',' for pointer.`);let n=this._type_decl(),r=null;return this._match(G.tokens.comma)&&(r=this._consume(G.access_mode,`Expected access_mode for pointer`).toString()),this._consume(G.tokens.greater_than,`Expected '>' for pointer.`),this._updateNode(new Ke(e,t.toString(),n,r))}let t=this._attribute();if(this._match(G.keywords.array)){let e=null,n=-1,r=this._previous(),i=null;if(this._match(G.tokens.less_than)){e=this._type_decl(),this._context.aliases.has(e.name)&&(e=this._context.aliases.get(e.name).type);let t=``;if(this._match(G.tokens.comma)){i=this._shift_expression();try{t=i.constEvaluate(this._exec).toString(),i=null}catch{t=`1`}}this._consume(G.tokens.greater_than,`Expected '>' for array.`),n=t?parseInt(t):0}let a=this._updateNode(new qe(r.toString(),t,e,n));return i&&this._deferArrayCountEval.push({arrayType:a,countNode:i}),a}return null}_texture_sampler_types(){if(this._match(G.sampler_type)||this._match(G.depth_texture_type))return this._updateNode(new Je(this._previous().toString(),null,null));if(this._match(G.sampled_texture_type)||this._match(G.multisampled_texture_type)){let e=this._previous();this._consume(G.tokens.less_than,`Expected '<' for sampler type.`);let t=this._type_decl();return this._consume(G.tokens.greater_than,`Expected '>' for sampler type.`),this._updateNode(new Je(e.toString(),t,null))}if(this._match(G.storage_texture_type)){let e=this._previous();this._consume(G.tokens.less_than,`Expected '<' for sampler type.`);let t=this._consume(G.texel_format,`Invalid texel format.`).toString();this._consume(G.tokens.comma,`Expected ',' after texel format.`);let n=this._consume(G.access_mode,`Expected access mode for storage texture type.`).toString();return this._consume(G.tokens.greater_than,`Expected '>' for sampler type.`),this._updateNode(new Je(e.toString(),t,n))}return null}_attribute(){let e=[];for(;this._match(G.tokens.attr);){let t=this._consume(G.attribute_name,`Expected attribute name`),n=this._updateNode(new ft(t.toString(),null));if(this._match(G.tokens.paren_left)){if(n.value=this._consume(G.literal_or_ident,`Expected attribute value`).toString(),this._check(G.tokens.comma)){this._advance();do{let e=this._consume(G.literal_or_ident,`Expected attribute value`).toString();n.value instanceof Array||(n.value=[n.value]),n.value.push(e)}while(this._match(G.tokens.comma))}this._consume(G.tokens.paren_right,`Expected ')'`)}e.push(n)}return e.length==0?null:e}},Wt=class extends Mt{constructor(e){super(),e&&this.update(e)}update(e){let t=new Ut().parse(e);this.updateAST(t)}},Gt=class{#n;Active;Index=0;#e;Device;BindGroups=[];Reflect;GPUPipeline;constructor(e,t,n){this.#n=n,this.#e=t,this.Active=!0,this.Device=e}CreatePipelineLabel(e){return this.#n&&e&&`${this.#n} ${e}`||``}CreatePipelineLayout(e,t){return t??=this.CreatePipelineLabel(`${this.#e} Pipeline Layout`),e=Q(e),this.Device.createPipelineLayout({label:t,bindGroupLayouts:e})}CreateShaderModule(t,n,i,a){t||(t=p,r(e.SHADER_CODE_NOT_FOUND)),n??=this.CreatePipelineLabel(`Shader Module`);let o=Array.isArray(t)&&t.join(`

`)||t;return this.Reflect=new Wt(o),this.Device.createShaderModule({label:n,code:o,sourceMap:i,compilationHints:a})}#t(e,t,n=0,r=[]){let{format:i}=e.type,a=e.type.members??i?.members,o=n+(e.offset??0);if(!a){let n=(e=>e===`f16`||e.includes(`h`)?`f16`:e.includes(`f`)?`f32`:e.includes(`u`)?`u32`:`i32`)((i??e.type).name),r=e.size/(e=>e.slice(1)/8)(n);return new((e=>e===`f16`?Float16Array:e===`f32`?Float32Array:e===`u32`?Uint32Array:Int32Array)(n))(t,o,r)}for(let n=0,s={},c=i?.isStruct&&e.count||1;n<c;++n)a.forEach(e=>s[e.name]=this.#t(e,t,o)),i?.isStruct&&(o+=e.stride),r.push(s);return r.length===1&&r[0]||r}CreateBuffer(e){let t=e.label??this.CreatePipelineLabel(`Buffer`);return Tn(this.Device,{label:t,...e})}CreateReadableBuffer(e){let t=typeof e==`number`,n=On.READABLE|(!t&&e.usage||0),r=t&&e;r||=e.size;let i=e?.label??`Readable Buffer`;return this.CreateBuffer({label:i,size:r,...e,usage:n})}CreateWritableBuffer(e){let t=typeof e==`number`,n=On.WRITABLE|(!t&&e.usage||0),r=t&&e;r||=e.size;let i=e?.label??`Writable Buffer`;return this.CreateBuffer({label:i,size:r,...e,usage:n})}CreateUniformBuffer(t,n){!this.Reflect&&i(e.SHADER_MODULE_NOT_FOUND,`\`${this.#e}Pipeline.CreateUniformBuffer\`.
            Use \`${this.#e}Pipeline.CreateShaderModule\` before creating a uniform buffer.`);let a=this.Reflect.uniforms.find(({name:e})=>t===e);!a&&i(e.UNIFORM_NOT_FOUND,`\`${t}\` in shader uniforms.`),t===`resolution`&&r(e.INVALID_UNIFORM_NAME,`\`${t}\`.`);let o=n?.label??`${t} Uniform Buffer`,s=new ArrayBuffer(a.size),c=On.UNIFORM|n?.usage;return{buffer:this.CreateBuffer({label:o,size:s.byteLength,...n,usage:c}),[t]:this.#t(a,s)}}CreateStorageBuffer(t,n=1){!this.Reflect&&i(e.SHADER_MODULE_NOT_FOUND,`\`${this.#e}Pipeline.CreateStorageBuffer\`.
            Use \`${this.#e}Pipeline.CreateShaderModule\` before creating a storage buffer.`);let r=this.Reflect.storage.find(({name:e})=>t===e);!r&&i(e.STORAGE_NOT_FOUND,`\`${t}\` in shader bindings.`);let a=typeof n==`number`,o=a&&n||n.length,s=On.STORAGE|(!a&&n.usage||0),c=!a&&n.label||`${t} Storage Buffer`,l=n.size??r.format.size*o,u=new ArrayBuffer(l),d=e=>(Object.keys(e).forEach(t=>{if(e[t].buffer instanceof ArrayBuffer){let n=e[t].constructor,r=l/n.BYTES_PER_ELEMENT;e[t]=new n(u,0,r)}else d(e[t])}),e),f=this.#t(r,u);return{buffer:this.CreateBuffer({label:c,size:l,...n,usage:s}),[t]:f.buffer instanceof ArrayBuffer?new f.constructor(u,0,o):d(f)}}WriteBuffer(e,t,n=0,r,i){En(this.Device.queue,...arguments)}GetBufferMinBindingSize(t){return!this.Reflect&&i(e.SHADER_MODULE_NOT_FOUND,`\`${this.#e}Pipeline.GetBufferMinBindingSize\`.
            Use \`${this.#e}Pipeline.CreateShaderModule\` before requesting buffer's min binding size.`),this.Reflect.getBindGroups().flat().find(({name:e})=>t===e)?.size??i(e.BINDING_NOT_FOUND,`\`${t}\` in shader bind groups.`)}SetBindGroupFromResources(e,t=0,n=0,r,i){return this.SetBindGroups(this.CreateBindGroup(this.CreateBindGroupEntries(e,t),n,r),i)}AddBindGroupFromResources(e,t=0,n=0,r,i){return this.AddBindGroups(this.CreateBindGroup(this.CreateBindGroupEntries(e,t),n,r),i)}CreateBindGroupEntries(e,t=0){return Array.isArray(e)&&e.map((e,n)=>({binding:t?.[n]??n,resource:e}))||[{binding:t,resource:e}]}CreateBindGroupLayout(e,t){return t??=this.CreatePipelineLabel(`Bind Group Layout`),e=Array.isArray(e)&&e.map((e,t)=>({...e,binding:e.binding??t}))||[{...e,binding:e.binding??0}],this.Device.createBindGroupLayout({entries:e,label:t})}CreateBindGroup(t,n=0,r){return r??=this.CreatePipelineLabel(`Bind Group`),typeof n==`number`&&(n=this.GPUPipeline?this.GPUPipeline.getBindGroupLayout(n):i(e.PIPELINE_NOT_FOUND,`${this.#e}Pipeline.
                    Use \`${this.#e}Stage.AddPipeline\` before creating a bind group.`)),this.Device.createBindGroup({entries:t,label:r,layout:n})}SetBindGroups(e,t){let n=Array.isArray(e),r=Array.isArray(t);return t=(t=n&&r?t.map(e=>Q(e)):r&&t||t&&[t])&&t||[],this.BindGroups=n&&e.map((e,n)=>({bindGroup:e,dynamicOffsets:t,active:!0}))||[{bindGroup:e,dynamicOffsets:t,active:!0}]}AddBindGroups(e,t){let n=Array.isArray(e),r=Array.isArray(t);return t=(t=n&&r?t.map(e=>Q(e)):r&&t||t&&[t])&&t||[],this.BindGroups.push(...n&&e.map(e=>({bindGroup:e,dynamicOffsets:t,active:!0}))||[{bindGroup:e,dynamicOffsets:t,active:!0}]),this.BindGroups}SetActiveBindGroups(e){e=Q(e);for(let t=this.BindGroups.length;t--;)this.BindGroups[t].active=e.includes(t)}UseBindGroups(e){for(let t=0,n=0,r=this.BindGroups.length;t<r;++t){let{bindGroup:r,dynamicOffsets:i,active:a}=this.BindGroups[t];a&&e.setBindGroup(n++,r,i)}}GetBindGroupsInfo(){!this.Reflect&&i(e.SHADER_MODULE_NOT_FOUND,`\`${this.#e}Pipeline.GetBindGroupsInfo\`.
            Use \`${this.#e}Pipeline.CreateShaderModule\` before requesting bind groups information.`);let t=this.BindGroups.length,n=Array(t),r=this.Reflect.getBindGroups();for(let e=0;e<t;++e){let{bindGroup:{label:t},dynamicOffsets:i,active:a}=this.BindGroups[e];n[e]={label:t,active:a,dynamicOffsets:i,bindings:r[e]}}return n}ClearBindGroups(){this.BindGroups.splice(0)}Destroy(){this.ClearBindGroups()}},Kt=class extends Gt{ColorAttachment=0;UseTextureView=!0;UseRenderBundles=!1;DestroyPassEncoder=!1;#n=[];#e=[0,0,0,0];TextureView;#t;VertexBuffers=[];IndexBuffer;DrawParams=[0,void 0,void 0,void 0,void 0];constructor(e,t,n){super(e,`Render`,n),this.#t=t}async Init(t={},n=0){Error().stack?.split(`
`)[2]?.trim().split(` `)[1].split(`.`)[1]!==`AddPipeline`&&r(e.INVALID_CALL,"method: `RenderPipeline.Init`."),this.Index=n;let i=wn(t),{vertex:a,fragment:o}=t;!i&&!a&&(i=this.CreateShaderModule()),i&&(a??=this.CreateVertexState(i),o??=this.CreateFragmentState(i));let s=t.label??this.CreatePipelineLabel(`Render Pipeline`),c=t.layout??`auto`;return this.GPUPipeline=await this.Device.createRenderPipelineAsync({label:s,layout:c,vertex:a,fragment:o,...t})}CreatePrimitiveState(e=`triangle-list`,t=`back`,n,r,i){return{topology:e,stripIndexFormat:n,frontFace:r,cullMode:t,unclippedDepth:i}}CreateBlendComponent(e=`one`,t=`zero`,n=`add`){return{operation:n,srcFactor:e,dstFactor:t}}CreateColorTargetState(e,t,n=this.#t){return e&&={color:e.color??{},alpha:e.alpha??{}},{format:n,blend:e,writeMask:t}}CreateMultisampleState(e=4,t,n){return{count:e,mask:t,alphaToCoverageEnabled:n}}CreateStencilFaceState(e,t,n,r){return{compare:e,failOp:t,depthFailOp:n,passOp:r}}CreateDepthStencilState(e=`depth24plus`,t=!0,n=`less`,r,i,a,o,s,c,l){return{format:e,depthWriteEnabled:t,depthCompare:n,stencilFront:r,stencilBack:i,stencilReadMask:a,stencilWriteMask:o,depthBias:s,depthBiasSlopeScale:c,depthBiasClamp:l}}CreateVertexState(e,t,n,r=`vertex`){return{module:e,entryPoint:r,buffers:t=Q(t),constants:n}}CreateFragmentState(e,t,n,r=`fragment`){return t??=this.CreateColorTargetState(),{module:e,entryPoint:r,targets:t=Q(t),constants:n}}#r(e,t=0,n=0){return{format:e,shaderLocation:t,offset:n}}CreateVertexBufferLayout(t,n=`vertex`,a=`vertex`){!this.Reflect&&i(e.SHADER_MODULE_NOT_FOUND,"`RenderPipeline.CreateVertexBufferLayout`.\n            Call `RenderPipeline.CreateShaderModule` before creating a vertex layout or vertex buffer.");let{entry:{vertex:o}}=this.Reflect,s=o.find(({name:e})=>a===e);!s&&i(e.VERTEX_ENTRY_NOT_FOUND,`\`${a}\` in vertex shader entries.`);let c=[],l=0;for(let n=0,i=(t=Q(t)).length;n<i;++n){let i=t[n],a=typeof i==`string`,o=a?i:i.name,u=s.inputs.find(({name:e})=>o===e);if(u){let e=a?bn(u.type.size):i.format;c.push(this.#r(e,+u.location,l)),l+=xn(e);continue}r(e.VERTEX_ATTRIBUTE_NOT_FOUND,`\`${o}\` in vertex shader inputs.`)}return{arrayStride:l,stepMode:n,attributes:c}}CreateVertexBuffer(e,t=1,n=`vertex`,r=`vertex`){let i=typeof t==`number`,a=!i&&t.label||`Vertex Buffer`,o=On.VERTEX|(!i&&t.usage||0);if(e instanceof Float32Array)return this.CreateBuffer({label:a,size:e.byteLength,...t,usage:o});let s=this.CreateVertexBufferLayout(e,n,r),c=(i&&t||(t.count??1))*s.arrayStride;return{buffer:this.CreateBuffer({label:a,size:c,...t,usage:o}),layout:s}}SetVertexBuffers(e,t,n){return n=Q(n),t=Q(t),this.VertexBuffers=Array.isArray(e)&&e.map((e,r)=>({buffer:e,offset:t[r],size:n[r]}))||[{buffer:e,offset:t[0],size:n[0]}]}AddVertexBuffers(e,t,n){return n=Q(n),t=Q(t),this.VertexBuffers.push(...Array.isArray(e)&&e.map((e,r)=>({buffer:e,offset:t[r],size:n[r]}))||[{buffer:e,offset:t[0],size:n[0]}]),this.VertexBuffers}CreateIndexBuffer(e,t){let n=On.INDEX|t?.usage,r=t?.label??`Index Buffer`;return e=Array.isArray(e)&&new Uint32Array(e)||e,this.CreateBuffer({label:r,size:e.byteLength,...t,usage:n})}SetIndexBuffer(e,t=`uint32`,n,r){return this.IndexBuffer=e&&{buffer:e,format:t,offset:n,size:r}}UseRenderBuffers(e){for(let t=0,n=this.VertexBuffers.length;t<n;++t){let{buffer:n,offset:r,size:i}=this.VertexBuffers[t];e.setVertexBuffer(t,n,r,i)}this.IndexBuffer&&e.setIndexBuffer(this.IndexBuffer.buffer,this.IndexBuffer.format,this.IndexBuffer.offset,this.IndexBuffer.size)}SetDrawParams(e,t,n,r,i){return Dn(this.DrawParams,...arguments)}EncodeRenderBundle(e){e.setPipeline(this.GPUPipeline);for(let t=0,n=this.VertexBuffers.length;t<n;++t){let{buffer:n,offset:r,size:i}=this.VertexBuffers[t];e.setVertexBuffer(t,n,r,i)}this.IndexBuffer&&e.setIndexBuffer(this.IndexBuffer.buffer,this.IndexBuffer.format,this.IndexBuffer.offset,this.IndexBuffer.size);for(let t=0,n=0,r=this.BindGroups.length;t<r;++t){let{bindGroup:r,dynamicOffsets:i,active:a}=this.BindGroups[t];a&&e.setBindGroup(n++,r,i)}e[this.DrawMethod](...this.DrawParams),this.#n.push(e.finish()),this.UseRenderBundles=!0}SetRenderBundle(e,t,n,r,i,a){this.#n.splice(0),this.AddRenderBundle(e,t,n,r,i,a)}AddRenderBundle(e,t,n,r,i,a){if(e.setPipeline(this.GPUPipeline),r)for(let t=0,n=(r=Q(r)).length;t<n;++t){let{buffer:n,offset:i,size:a}=r[t];e.setVertexBuffer(t,n,i,a)}if(i&&e.setIndexBuffer(i.buffer,i.format,i.offset,i.size),a)for(let t=0,n=0,r=(a=Q(a)).length;t<r;++t){let{bindGroup:r,dynamicOffsets:i,active:o}=a[t];o&&e.setBindGroup(n++,r,i)}e[t](...n),this.#n.push(e.finish()),this.UseRenderBundles=!0}ExecuteRenderBundles(e){e.executeBundles(this.#n)}ClearRenderBundles(){this.UseRenderBundles=!1,this.#n.splice(0)}set BlendConstant(e){this.#e=typeof e==`number`&&Cn(e)||Sn(e)}get BlendConstant(){return this.#e}get DrawMethod(){return this.IndexBuffer?`drawIndexed`:`draw`}Destroy(){super.Destroy(),this.ColorAttachment=0,this.TextureView=void 0,this.DestroyPassEncoder=!1,this.#e=[0,0,0,0],this.VertexBuffers.forEach(({buffer:e})=>e.destroy()),this.IndexBuffer?.buffer.destroy(),this.VertexBuffers.splice(0),this.ClearRenderBundles()}},qt=class extends Gt{constructor(e,t){super(e,`Compute`,t)}async Init(t={},n=0){Error().stack?.split(`
`)[2]?.trim().split(` `)[1].split(`.`)[1]!==`AddPipeline`&&r(e.INVALID_CALL,"method: `ComputePipeline.Init`.");let{label:i,layout:a}=t;this.Index=n,i??=this.CreatePipelineLabel(`Compute Pipeline`),a??=`auto`;let o=wn(t)??this.CreateShaderModule();return this.GPUPipeline=await this.Device.createComputePipelineAsync({label:i,layout:a,compute:{module:o,...t}})}},Jt=class extends a{#n=new Float32Array(3);UseDepthStencilAttachment=!1;#e;#t;#r;#i;#a=void 0;#s;#o;#u;#c;#l;#f=new Map;#d=[];#m=new Map;#p=[];#h={Pipeline:void 0,Index:-1,Geometry:``,Material:``};constructor(t,n,r,a){super(t,`Render`,n),!r&&i(e.CANVAS_NOT_FOUND);let o=r.getContext(`webgpu`);!o&&i(e.CONTEXT_NOT_FOUND),o.configure({device:t,...a}),this.#r=Tn(this.Device,{size:this.#n.length*Float32Array.BYTES_PER_ELEMENT,label:`Render Pipeline Resolution Buffer`,usage:On.UNIFORM}),this.#e=r,this.#t=o,this.#x(),this.#u=a.format,this.CreatePassDescriptor(this.CreateColorAttachment())}ConfigureContext(e){let t=e.format??this.#u;this.#t.configure({device:this.Device,format:t,...e})}CreateColorAttachment(e,t,n=`clear`,r=`store`,i,a){return{view:t,loadOp:n,storeOp:r,clearValue:e&&Sn(e),resolveTarget:i,depthSlice:a}}CreateStencilAttachment(e=0,t=`clear`,n=`store`,r){return{stencilClearValue:e,stencilLoadOp:t,stencilStoreOp:n,stencilReadOnly:r}}CreateDepthStencilAttachment(e,t=1,n=`clear`,r=`store`,i,a){return this.UseDepthStencilAttachment=!0,this.#i=new x(this.Device),{view:e,depthClearValue:t,depthLoadOp:n,depthStoreOp:r,depthReadOnly:i,...a}}#b(){let e=this.CurrentTexture,{width:t,height:n}=e;this.#o&&this.#o.width===t&&this.#o.height===n||(this.#o?.destroy(),this.#o=this.#i.CreateTextureFromSource(e,{sampleCount:this.#c?.sampleCount??1,usage:GPUTextureUsage.RENDER_ATTACHMENT,label:`Depth Texture`,format:`depth24plus`,mipmaps:!1})),this.#s.depthStencilAttachment.view=this.#o.createView()}CreateRenderBundleEncoder(e=this.#u,t=`depth24plus`,n,r,i,a){return e=Q(e),n??=this.CreateStageLabel(`Render Bundle Encoder`),this.Device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,label:n,sampleCount:r,depthReadOnly:i,stencilReadOnly:a})}CreatePassDescriptor(e,t,n,r,i,a){return e=Q(e),n??=this.CreateStageLabel(`Render Pass`),this.#s={depthStencilAttachment:t,occlusionQuerySet:r,colorAttachments:e,timestampWrites:i,maxDrawCount:a,label:n}}CreateStorageTextureBindingLayout(e=this.#u,t,n,r,i){return{binding:i,visibility:GPUShaderStage.FRAGMENT,storageTexture:{access:t,format:e,viewDimension:n}}}#x(){this.#n.set([this.#e.width,this.#e.height,this.DevicePixelRatio]),En(this.Device.queue,this.#r,this.#n)}SetCanvasSize(t,n,r=!0){!this.Device&&i(e.DEVICE_NOT_FOUND),!this.#e&&i(e.CANVAS_NOT_FOUND);let a=this.DevicePixelRatio*t|0,o=this.DevicePixelRatio*n|0,s=this.Device.limits.maxTextureDimension2D;a=Math.max(1,Math.min(a,s)),o=Math.max(1,Math.min(o,s)),this.#e.width===a&&this.#e.height===o||(this.#e.height=o,this.#e.width=a,this.#x(),r&&(this.#e.style.width=`${t}px`,this.#e.style.height=`${n}px`))}async CreatePipeline(e,t){let n=Array.isArray(e)||typeof e==`string`,r=n||`shader`in e,i=new this.Pipeline(e.pipelineName);return e=wn(e)??(r&&i.CreateShaderModule(...Object.values(n&&[e]||e))||e),await this.AddPipeline(i,e,t)}async AddPipeline(t,n,i){let a=await t.Init(n,this.Pipelines.length);return i&&(this.#l?this.#l.setPipeline(a):r(e.RENDER_PASS_NOT_FOUND)),this.Pipelines.push(t),t}#g(e,t,n,r=!0,i=!0){if(n||=!this.#l,r||=n,i||=n,!this.#l){let t=`view`,n=this.#s.colorAttachments[e.ColorAttachment];this.#c&&(t=`resolveTarget`,n.view=this.#c.createView()),e.UseTextureView&&(n[t]=e.TextureView??this.CurrentTextureView),this.#l=this.GetCommandEncoder().beginRenderPass(this.#s)}i&&this.#l.setBlendConstant(e.BlendConstant),e.UseRenderBundles?e.ExecuteRenderBundles(this.#l):(n&&this.#l.setPipeline(e.GPUPipeline),r&&e.UseRenderBuffers(this.#l),e.UseBindGroups(this.#l),this.#l[e.DrawMethod](...e.DrawParams)),e.DestroyPassEncoder&&!t&&this.DestroyRenderPass()}#y({Geometry:e,Material:t,Meshes:n},r,i){let a=e.ID!==this.#h.Geometry,o=t?.ID!==this.#h.Material;for(let s=0,c=n.length;s<c;++s,a=o=!1,this.#h.Index=this.#h.Pipeline.Index){let c=n[s],l=c.Pipeline,u=l.Index!==this.#h.Index;if(a||u){let{VertexBuffers:t,IndexBuffer:n,DrawParams:r}=e;l.SetDrawParams.apply(l,r),this.#h.Geometry=e.ID,l.VertexBuffers=t,l.IndexBuffer=n}(o||u)&&(o=!!t?.SetBlendConstant(this.#h.Pipeline),this.#h.Material=t?.ID),c.UpdateProjectionMatrix(r),c.SetBindGroups(),this.#g(this.#h.Pipeline=l,i,u,a,o)}}#_(e,t){for(let n,r=0,i=t.length;r<i;n=void 0,++r){let i=t[r],{Geometry:a,Material:o}=i,s=a.ID+`${(o&&`-${o.ID}`)??``}`;(n=e.get(s))||(n={Geometry:a,Material:o,Meshes:[]},e.set(s,n)),n.Meshes.push(i)}}#v(e,t=!0){e.UpdateWorldMatrix();let{Frustum:n,ProjectionMatrix:r,ViewProjectionMatrix:i}=e.MainCamera,a=i||r;if(e.Traverse(t=>e!==t&&(!t.Visible||void(t.Material?.Transparent&&this.#p||this.#d).push(t))),!this.#d.length&&!this.#p.length)return~this.DestroyRenderPass()&&(this.CommandEncoder=void 0);this.#_(this.#f,this.#d),this.#_(this.#m,this.#p),this.#f.forEach(e=>this.#y(e,a,t)),this.#m.forEach(e=>this.#y(e,a,t)),t&&this.Submit(),this.#f.clear(),this.#d.splice(0),this.#m.clear(),this.#p.splice(0)}Render(e=!0,t=!0){if(this.UseDepthStencilAttachment&&this.#b(),typeof e!=`boolean`)return this.#v(e,t);t=e;let n=this.Pipelines.length;if(n-1||!this.Pipelines[0].Active)for(let e=0;e<n;++e){let n=this.Pipelines[e];n.Active&&this.#g(n,t,!0)}else this.#g(this.Pipelines[0],t,!1);t&&this.Submit()}DestroyRenderPass(){this.#l?.end(),this.#l=void 0}Submit(){this.DestroyRenderPass(),this.SubmitCommandBuffer(),this.CommandEncoder=void 0}get Canvas(){return this.#e}get Context(){return this.#t}get RenderPass(){return this.#l}get DepthTexture(){return this.#o}get CurrentTexture(){return this.#t.getCurrentTexture()}get CurrentTextureView(){return this.CurrentTexture.createView()}set MultisampleTexture(e){this.#c=e}get RenderPassDescriptor(){return this.#s}get MultisampleTexture(){return this.#c}set DevicePixelRatio(e){this.#a=e}get DevicePixelRatio(){return this.#a??globalThis.devicePixelRatio??1}get ResolutionBuffer(){return this.#r}get BaseCanvasSize(){let{width:e,height:t}=this.#e,n=this.DevicePixelRatio;return[e/n,t/n]}get CanvasSize(){return[this.#e.width,this.#e.height]}get AspectRatio(){return!this.#e&&i(e.CANVAS_NOT_FOUND),this.#e.width/this.#e.height}get Pipeline(){let{Name:e,Device:t}=this,n=this.#u;return class extends Kt{constructor(r=e){super(t,n,r)}}}Destroy(){super.Destroy(),this.DestroyRenderPass(),this.#r.destroy(),this.#o=this.#o?.destroy(),this.#i=this.#i?.Destroy(),this.#t.unconfigure()}},Yt=class extends a{#n=[1];#e;constructor(e,t){super(e,`Compute`,t),this.CreatePassDescriptor()}CreatePassDescriptor(e,t){return e??=this.CreateStageLabel(`Compute Pass`),this.#e={label:e,timestampWrites:t}}GetMaxEvenWorkgroupDimension(e=1){let{maxComputeInvocationsPerWorkgroup:t}=this.Device.limits;return 0|(e===3?Math.cbrt(t):e===2?Math.sqrt(t):t)}async CreatePipeline(e){let t=Array.isArray(e)||typeof e==`string`,n=t||`shader`in e,r=new this.Pipeline(e.pipelineName);return e=wn(e)??(n&&r.CreateShaderModule(...Object.values(t&&[e]||e))||e),await this.AddPipeline(r,e)}async AddPipeline(e,t){return await e.Init(t,this.Pipelines.length),this.Pipelines.push(e),e}#t(e,t){t.setPipeline(e.GPUPipeline),e.UseBindGroups(t),t.dispatchWorkgroups(...this.#n),t.end()}Compute(e=!0){let t=this.Pipelines.length,n=this.GetCommandEncoder().beginComputePass(this.#e);if(t-1||!this.Pipelines[0].Active)for(let e=0;e<t;++e){let t=this.Pipelines[e];t.Active&&this.#t(t,n)}else this.#t(this.Pipelines[0],n);e&&this.Submit()}Submit(){this.SubmitCommandBuffer(),this.CommandEncoder=void 0}set Workgroups(e){this.#n=Q(e).map(Math.ceil)}get Pipeline(){let{Name:e,Device:t}=this;return class extends qt{constructor(n=e){super(t,n)}}}Destroy(){super.Destroy(),this.Workgroups=1}},Xt=class t{static#n=[];static#e=null;static#t=null;static#r={powerPreference:void 0,forceFallbackAdapter:!1};static OnLost;static#i={label:void 0,requiredFeatures:new Set,requiredLimits:void 0};static#a(e){this.#i.label??=e&&`${e} Device`||``}static async CreateQuerySet(e,t){let n=(await this.GPUDevice).createQuerySet({type:e,count:t});return this.#n.push(n),n}static Renderer(e,t=``,n={}){return n.format??=this.PreferredCanvasFormat,this.#a(t),(async()=>{let r=await this.GPUDevice;return new Proxy(Jt,{construct:i=>new i(r,t,e,n)})})()}static Computation(e=``){return this.#a(e),(async()=>{let t=await this.GPUDevice;return new Proxy(Yt,{construct:n=>new n(t,e)})})()}static Texture(e){return(async()=>{let t=await this.GPUDevice;return new Proxy(x,{construct:n=>new n(t,e)})})()}static Destroy(e,t){this.#n.forEach(e=>e.destroy()),(e=Q(e)).forEach(e=>e?.destroy()),(t=Q(t)).forEach(e=>e?.destroy()),this.#e?.destroy(),this.#n.splice(0),this.#i.requiredFeatures.clear(),this.#t=this.#e=null,this.DescriptorLabel=this.RequiredLimits=void 0,this.PowerPreference=this.ForceFallbackAdapter=void 0}static#s(n){if(t.OnLost)return t.OnLost(n);let r=(n.message&&` | Message: ${n.message}`)??`.`;i(e.DEVICE_LOST,`Reason: ${n.reason}`+r)}static#o(){return!navigator.gpu&&i(e.WEBGPU_NOT_SUPPORTED),async()=>{let t=await navigator.gpu.requestAdapter(this.#r);return!t&&i(e.ADAPTER_NOT_FOUND),this.#t=t}}static#u(){return async()=>{let{requiredFeatures:t,requiredLimits:n,label:r}=this.#i,a=await(await this.Adapter).requestDevice({requiredFeatures:t,requiredLimits:n,defaultQueue:{label:r}});return!a&&i(e.DEVICE_NOT_FOUND),a.lost.then(this.#s),this.#e=a}}static set PowerPreference(e){this.#r.powerPreference=e}static set ForceFallbackAdapter(e){this.#r.forceFallbackAdapter=e}static set DescriptorLabel(e){this.#i.label=e}static async SetRequiredFeatures(t){let n=(await this.Adapter).features;return(t=Q(t)).forEach(t=>n.has(t)?this.#i.requiredFeatures.add(t):r(e.FEATURE_NOT_FOUND,`"${t}".
It will be skipped when requesting a GPUDevice.`)),this.#i.requiredFeatures}static set RequiredLimits(e){this.#i.requiredLimits=e}static get PreferredCanvasFormat(){return!navigator.gpu&&i(e.WEBGPU_NOT_SUPPORTED),navigator.gpu.getPreferredCanvasFormat()}static get Adapter(){return(async()=>this.#t??await this.#o()())()}static get GPUDevice(){return(async()=>this.#e??await this.#u()())()}static get VERSION(){return`0.2.1`}},Zt=(Qt=Array,$t=e=>e.fill(0),class extends Qt{constructor(...e){super(...e),$t(this)}}),Qt,$t,q=1e-6,en={__proto__:null,get EPSILON(){return q},degToRad:e=>e*Math.PI/180,euclideanModulo:(e,t)=>(e%t+t)%t,inverseLerp:(e,t,n)=>{let r=t-e;return Math.abs(t-e)<q?e:(n-e)/r},lerp:(e,t,n)=>e+(t-e)*n,radToDeg:e=>180*e/Math.PI,setEpsilon:e=>{let t=q;return q=e,t}},tn=new Map;function nn(e){let t=tn.get(e);return t||(t=(e=>{function t(t=0,n=0){let r=new e(2);return t!==void 0&&(r[0]=t,n!==void 0&&(r[1]=n)),r}function n(t,n,r){let i=r??new e(2);return i[0]=t[0]-n[0],i[1]=t[1]-n[1],i}function r(t,n,r,i){let a=i??new e(2);return a[0]=t[0]+r*(n[0]-t[0]),a[1]=t[1]+r*(n[1]-t[1]),a}function i(t,n,r){let i=r??new e(2);return i[0]=t[0]*n,i[1]=t[1]*n,i}function a(t,n){let r=n??new e(2);return r[0]=1/t[0],r[1]=1/t[1],r}function o(e,t){return e[0]*t[0]+e[1]*t[1]}function s(e){let t=e[0],n=e[1];return Math.sqrt(t*t+n*n)}function c(e){let t=e[0],n=e[1];return t*t+n*n}function l(e,t){let n=e[0]-t[0],r=e[1]-t[1];return Math.sqrt(n*n+r*r)}function u(e,t){let n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r}function d(t,n){let r=n??new e(2),i=t[0],a=t[1],o=Math.sqrt(i*i+a*a);return o>1e-5?(r[0]=i/o,r[1]=a/o):(r[0]=0,r[1]=0),r}function f(t,n){let r=n??new e(2);return r[0]=t[0],r[1]=t[1],r}function p(t,n,r){let i=r??new e(2);return i[0]=t[0]*n[0],i[1]=t[1]*n[1],i}function m(t,n,r){let i=r??new e(2);return i[0]=t[0]/n[0],i[1]=t[1]/n[1],i}function h(t,n,r){let a=r??new e(2);return d(t,a),i(a,n,a)}return{create:t,fromValues:t,set:(t,n,r)=>{let i=r??new e(2);return i[0]=t,i[1]=n,i},ceil:(t,n)=>{let r=n??new e(2);return r[0]=Math.ceil(t[0]),r[1]=Math.ceil(t[1]),r},floor:(t,n)=>{let r=n??new e(2);return r[0]=Math.floor(t[0]),r[1]=Math.floor(t[1]),r},round:(t,n)=>{let r=n??new e(2);return r[0]=Math.round(t[0]),r[1]=Math.round(t[1]),r},clamp:(t,n=0,r=1,i)=>{let a=i??new e(2);return a[0]=Math.min(r,Math.max(n,t[0])),a[1]=Math.min(r,Math.max(n,t[1])),a},add:(t,n,r)=>{let i=r??new e(2);return i[0]=t[0]+n[0],i[1]=t[1]+n[1],i},addScaled:(t,n,r,i)=>{let a=i??new e(2);return a[0]=t[0]+n[0]*r,a[1]=t[1]+n[1]*r,a},angle:(e,t)=>{let n=e[0],r=e[1],i=t[0],a=t[1],s=Math.sqrt(n*n+r*r)*Math.sqrt(i*i+a*a),c=s&&o(e,t)/s;return Math.acos(c)},subtract:n,sub:n,equalsApproximately:(e,t)=>Math.abs(e[0]-t[0])<q&&Math.abs(e[1]-t[1])<q,equals:(e,t)=>e[0]===t[0]&&e[1]===t[1],lerp:r,lerpV:(t,n,r,i)=>{let a=i??new e(2);return a[0]=t[0]+r[0]*(n[0]-t[0]),a[1]=t[1]+r[1]*(n[1]-t[1]),a},max:(t,n,r)=>{let i=r??new e(2);return i[0]=Math.max(t[0],n[0]),i[1]=Math.max(t[1],n[1]),i},min:(t,n,r)=>{let i=r??new e(2);return i[0]=Math.min(t[0],n[0]),i[1]=Math.min(t[1],n[1]),i},mulScalar:i,scale:i,divScalar:(t,n,r)=>{let i=r??new e(2);return i[0]=t[0]/n,i[1]=t[1]/n,i},inverse:a,invert:a,cross:(t,n,r)=>{let i=r??new e(3),a=t[0]*n[1]-t[1]*n[0];return i[0]=0,i[1]=0,i[2]=a,i},dot:o,length:s,len:s,lengthSq:c,lenSq:c,distance:l,dist:l,distanceSq:u,distSq:u,normalize:d,negate:(t,n)=>{let r=n??new e(2);return r[0]=-t[0],r[1]=-t[1],r},copy:f,clone:f,multiply:p,mul:p,divide:m,div:m,random:(t=1,n)=>{let r=n??new e(2),i=2*Math.random()*Math.PI;return r[0]=Math.cos(i)*t,r[1]=Math.sin(i)*t,r},zero:t=>{let n=t??new e(2);return n[0]=0,n[1]=0,n},transformMat4:(t,n,r)=>{let i=r??new e(2),a=t[0],o=t[1];return i[0]=a*n[0]+o*n[4]+n[12],i[1]=a*n[1]+o*n[5]+n[13],i},transformMat3:(t,n,r)=>{let i=r??new e(2),a=t[0],o=t[1];return i[0]=n[0]*a+n[4]*o+n[8],i[1]=n[1]*a+n[5]*o+n[9],i},rotate:(t,n,r,i)=>{let a=i??new e(2),o=t[0]-n[0],s=t[1]-n[1],c=Math.sin(r),l=Math.cos(r);return a[0]=o*l-s*c+n[0],a[1]=o*c+s*l+n[1],a},setLength:h,truncate:(t,n,r)=>{let i=r??new e(2);return s(t)>n?h(t,n,i):f(t,i)},midpoint:(t,n,i)=>r(t,n,.5,i??new e(2))}})(e),tn.set(e,t)),t}var rn=new Map;function an(e){let t=rn.get(e);return t||(t=(e=>{function t(t,n,r){let i=new e(3);return t!==void 0&&(i[0]=t,n!==void 0&&(i[1]=n,r!==void 0&&(i[2]=r))),i}function n(t,n,r){let i=r??new e(3);return i[0]=t[0]-n[0],i[1]=t[1]-n[1],i[2]=t[2]-n[2],i}function r(t,n,r,i){let a=i??new e(3);return a[0]=t[0]+r*(n[0]-t[0]),a[1]=t[1]+r*(n[1]-t[1]),a[2]=t[2]+r*(n[2]-t[2]),a}function i(t,n,r){let i=r??new e(3);return i[0]=t[0]*n,i[1]=t[1]*n,i[2]=t[2]*n,i}function a(t,n){let r=n??new e(3);return r[0]=1/t[0],r[1]=1/t[1],r[2]=1/t[2],r}function o(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function s(e){let t=e[0],n=e[1],r=e[2];return Math.sqrt(t*t+n*n+r*r)}function c(e){let t=e[0],n=e[1],r=e[2];return t*t+n*n+r*r}function l(e,t){let n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+r*r+i*i)}function u(e,t){let n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return n*n+r*r+i*i}function d(t,n){let r=n??new e(3),i=t[0],a=t[1],o=t[2],s=Math.sqrt(i*i+a*a+o*o);return s>1e-5?(r[0]=i/s,r[1]=a/s,r[2]=o/s):(r[0]=0,r[1]=0,r[2]=0),r}function f(t,n){let r=n??new e(3);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r}function p(t,n,r){let i=r??new e(3);return i[0]=t[0]*n[0],i[1]=t[1]*n[1],i[2]=t[2]*n[2],i}function m(t,n,r){let i=r??new e(3);return i[0]=t[0]/n[0],i[1]=t[1]/n[1],i[2]=t[2]/n[2],i}function h(t,n,r){let a=r??new e(3);return d(t,a),i(a,n,a)}return{create:t,fromValues:t,set:(t,n,r,i)=>{let a=i??new e(3);return a[0]=t,a[1]=n,a[2]=r,a},ceil:(t,n)=>{let r=n??new e(3);return r[0]=Math.ceil(t[0]),r[1]=Math.ceil(t[1]),r[2]=Math.ceil(t[2]),r},floor:(t,n)=>{let r=n??new e(3);return r[0]=Math.floor(t[0]),r[1]=Math.floor(t[1]),r[2]=Math.floor(t[2]),r},round:(t,n)=>{let r=n??new e(3);return r[0]=Math.round(t[0]),r[1]=Math.round(t[1]),r[2]=Math.round(t[2]),r},clamp:(t,n=0,r=1,i)=>{let a=i??new e(3);return a[0]=Math.min(r,Math.max(n,t[0])),a[1]=Math.min(r,Math.max(n,t[1])),a[2]=Math.min(r,Math.max(n,t[2])),a},add:(t,n,r)=>{let i=r??new e(3);return i[0]=t[0]+n[0],i[1]=t[1]+n[1],i[2]=t[2]+n[2],i},addScaled:(t,n,r,i)=>{let a=i??new e(3);return a[0]=t[0]+n[0]*r,a[1]=t[1]+n[1]*r,a[2]=t[2]+n[2]*r,a},angle:(e,t)=>{let n=e[0],r=e[1],i=e[2],a=t[0],s=t[1],c=t[2],l=Math.sqrt(n*n+r*r+i*i)*Math.sqrt(a*a+s*s+c*c),u=l&&o(e,t)/l;return Math.acos(u)},subtract:n,sub:n,equalsApproximately:(e,t)=>Math.abs(e[0]-t[0])<q&&Math.abs(e[1]-t[1])<q&&Math.abs(e[2]-t[2])<q,equals:(e,t)=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2],lerp:r,lerpV:(t,n,r,i)=>{let a=i??new e(3);return a[0]=t[0]+r[0]*(n[0]-t[0]),a[1]=t[1]+r[1]*(n[1]-t[1]),a[2]=t[2]+r[2]*(n[2]-t[2]),a},max:(t,n,r)=>{let i=r??new e(3);return i[0]=Math.max(t[0],n[0]),i[1]=Math.max(t[1],n[1]),i[2]=Math.max(t[2],n[2]),i},min:(t,n,r)=>{let i=r??new e(3);return i[0]=Math.min(t[0],n[0]),i[1]=Math.min(t[1],n[1]),i[2]=Math.min(t[2],n[2]),i},mulScalar:i,scale:i,divScalar:(t,n,r)=>{let i=r??new e(3);return i[0]=t[0]/n,i[1]=t[1]/n,i[2]=t[2]/n,i},inverse:a,invert:a,cross:(t,n,r)=>{let i=r??new e(3),a=t[2]*n[0]-t[0]*n[2],o=t[0]*n[1]-t[1]*n[0];return i[0]=t[1]*n[2]-t[2]*n[1],i[1]=a,i[2]=o,i},dot:o,length:s,len:s,lengthSq:c,lenSq:c,distance:l,dist:l,distanceSq:u,distSq:u,normalize:d,negate:(t,n)=>{let r=n??new e(3);return r[0]=-t[0],r[1]=-t[1],r[2]=-t[2],r},copy:f,clone:f,multiply:p,mul:p,divide:m,div:m,random:(t=1,n)=>{let r=n??new e(3),i=2*Math.random()*Math.PI,a=2*Math.random()-1,o=Math.sqrt(1-a*a)*t;return r[0]=Math.cos(i)*o,r[1]=Math.sin(i)*o,r[2]=a*t,r},zero:t=>{let n=t??new e(3);return n[0]=0,n[1]=0,n[2]=0,n},transformMat4:(t,n,r)=>{let i=r??new e(3),a=t[0],o=t[1],s=t[2],c=n[3]*a+n[7]*o+n[11]*s+n[15]||1;return i[0]=(n[0]*a+n[4]*o+n[8]*s+n[12])/c,i[1]=(n[1]*a+n[5]*o+n[9]*s+n[13])/c,i[2]=(n[2]*a+n[6]*o+n[10]*s+n[14])/c,i},transformMat4Upper3x3:(t,n,r)=>{let i=r??new e(3),a=t[0],o=t[1],s=t[2];return i[0]=a*n[0]+o*n[4]+s*n[8],i[1]=a*n[1]+o*n[5]+s*n[9],i[2]=a*n[2]+o*n[6]+s*n[10],i},transformMat3:(t,n,r)=>{let i=r??new e(3),a=t[0],o=t[1],s=t[2];return i[0]=a*n[0]+o*n[4]+s*n[8],i[1]=a*n[1]+o*n[5]+s*n[9],i[2]=a*n[2]+o*n[6]+s*n[10],i},transformQuat:(t,n,r)=>{let i=r??new e(3),a=n[0],o=n[1],s=n[2],c=2*n[3],l=t[0],u=t[1],d=t[2],f=o*d-s*u,p=s*l-a*d,m=a*u-o*l;return i[0]=l+f*c+2*(o*m-s*p),i[1]=u+p*c+2*(s*f-a*m),i[2]=d+m*c+2*(a*p-o*f),i},getTranslation:(t,n)=>{let r=n??new e(3);return r[0]=t[12],r[1]=t[13],r[2]=t[14],r},getAxis:(t,n,r)=>{let i=r??new e(3),a=4*n;return i[0]=t[a+0],i[1]=t[a+1],i[2]=t[a+2],i},getScaling:(t,n)=>{let r=n??new e(3),i=t[0],a=t[1],o=t[2],s=t[4],c=t[5],l=t[6],u=t[8],d=t[9],f=t[10];return r[0]=Math.sqrt(i*i+a*a+o*o),r[1]=Math.sqrt(s*s+c*c+l*l),r[2]=Math.sqrt(u*u+d*d+f*f),r},rotateX:(t,n,r,i)=>{let a=i??new e(3),o=[],s=[];return o[0]=t[0]-n[0],o[1]=t[1]-n[1],o[2]=t[2]-n[2],s[0]=o[0],s[1]=o[1]*Math.cos(r)-o[2]*Math.sin(r),s[2]=o[1]*Math.sin(r)+o[2]*Math.cos(r),a[0]=s[0]+n[0],a[1]=s[1]+n[1],a[2]=s[2]+n[2],a},rotateY:(t,n,r,i)=>{let a=i??new e(3),o=[],s=[];return o[0]=t[0]-n[0],o[1]=t[1]-n[1],o[2]=t[2]-n[2],s[0]=o[2]*Math.sin(r)+o[0]*Math.cos(r),s[1]=o[1],s[2]=o[2]*Math.cos(r)-o[0]*Math.sin(r),a[0]=s[0]+n[0],a[1]=s[1]+n[1],a[2]=s[2]+n[2],a},rotateZ:(t,n,r,i)=>{let a=i??new e(3),o=[],s=[];return o[0]=t[0]-n[0],o[1]=t[1]-n[1],o[2]=t[2]-n[2],s[0]=o[0]*Math.cos(r)-o[1]*Math.sin(r),s[1]=o[0]*Math.sin(r)+o[1]*Math.cos(r),s[2]=o[2],a[0]=s[0]+n[0],a[1]=s[1]+n[1],a[2]=s[2]+n[2],a},setLength:h,truncate:(t,n,r)=>{let i=r??new e(3);return s(t)>n?h(t,n,i):f(t,i)},midpoint:(t,n,i)=>r(t,n,.5,i??new e(3))}})(e),rn.set(e,t)),t}var on=new Map;function sn(e){let t=on.get(e);return t||(t=(e=>{let t=nn(e),n=an(e);function r(t,n,r){let i=r??new e(12);return i[0]=t[0]*n,i[1]=t[1]*n,i[2]=t[2]*n,i[4]=t[4]*n,i[5]=t[5]*n,i[6]=t[6]*n,i[8]=t[8]*n,i[9]=t[9]*n,i[10]=t[10]*n,i}function i(t,n){let r=n??new e(12);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[8]=t[8],r[9]=t[9],r[10]=t[10],r}function a(t){let n=t??new e(12);return n[0]=1,n[1]=0,n[2]=0,n[4]=0,n[5]=1,n[6]=0,n[8]=0,n[9]=0,n[10]=1,n}function o(t,n){let r=n??new e(12),i=t[0],a=t[1],o=t[2],s=t[4],c=t[5],l=t[6],u=t[8],d=t[9],f=t[10],p=f*c-l*d,m=-f*s+l*u,h=d*s-c*u,g=1/(i*p+a*m+o*h);return r[0]=p*g,r[1]=(-f*a+o*d)*g,r[2]=(l*a-o*c)*g,r[4]=m*g,r[5]=(f*i-o*u)*g,r[6]=(-l*i+o*s)*g,r[8]=h*g,r[9]=(-d*i+a*u)*g,r[10]=(c*i-a*s)*g,r}function s(t,n,r){let i=r??new e(12),a=t[0],o=t[1],s=t[2],c=t[4],l=t[5],u=t[6],d=t[8],f=t[9],p=t[10],m=n[0],h=n[1],g=n[2],_=n[4],v=n[5],y=n[6],b=n[8],x=n[9],S=n[10];return i[0]=a*m+c*h+d*g,i[1]=o*m+l*h+f*g,i[2]=s*m+u*h+p*g,i[4]=a*_+c*v+d*y,i[5]=o*_+l*v+f*y,i[6]=s*_+u*v+p*y,i[8]=a*b+c*x+d*S,i[9]=o*b+l*x+f*S,i[10]=s*b+u*x+p*S,i}function c(t,n){let r=n??new e(12),i=Math.cos(t),a=Math.sin(t);return r[0]=i,r[1]=a,r[2]=0,r[4]=-a,r[5]=i,r[6]=0,r[8]=0,r[9]=0,r[10]=1,r}function l(t,n,r){let i=r??new e(12),a=t[0],o=t[1],s=t[2],c=t[4],l=t[5],u=t[6],d=Math.cos(n),f=Math.sin(n);return i[0]=d*a+f*c,i[1]=d*o+f*l,i[2]=d*s+f*u,i[4]=d*c-f*a,i[5]=d*l-f*o,i[6]=d*u-f*s,t!==i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10]),i}return{add:(t,n,r)=>{let i=r??new e(12);return i[0]=t[0]+n[0],i[1]=t[1]+n[1],i[2]=t[2]+n[2],i[4]=t[4]+n[4],i[5]=t[5]+n[5],i[6]=t[6]+n[6],i[8]=t[8]+n[8],i[9]=t[9]+n[9],i[10]=t[10]+n[10],i},clone:i,copy:i,create:(t,n,r,i,a,o,s,c,l)=>{let u=new e(12);return u[3]=0,u[7]=0,u[11]=0,t!==void 0&&(u[0]=t,n!==void 0&&(u[1]=n,r!==void 0&&(u[2]=r,i!==void 0&&(u[4]=i,a!==void 0&&(u[5]=a,o!==void 0&&(u[6]=o,s!==void 0&&(u[8]=s,c!==void 0&&(u[9]=c,l!==void 0&&(u[10]=l))))))))),u},determinant:e=>{let t=e[0],n=e[1],r=e[2],i=e[4],a=e[5],o=e[6],s=e[8],c=e[9],l=e[10];return t*(a*l-c*o)-i*(n*l-c*r)+s*(n*o-a*r)},equals:(e,t)=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10],equalsApproximately:(e,t)=>Math.abs(e[0]-t[0])<q&&Math.abs(e[1]-t[1])<q&&Math.abs(e[2]-t[2])<q&&Math.abs(e[4]-t[4])<q&&Math.abs(e[5]-t[5])<q&&Math.abs(e[6]-t[6])<q&&Math.abs(e[8]-t[8])<q&&Math.abs(e[9]-t[9])<q&&Math.abs(e[10]-t[10])<q,fromMat4:(t,n)=>{let r=n??new e(12);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=0,r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=0,r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=0,r},fromQuat:(t,n)=>{let r=n??new e(12),i=t[0],a=t[1],o=t[2],s=t[3],c=i+i,l=a+a,u=o+o,d=i*c,f=a*c,p=a*l,m=o*c,h=o*l,g=o*u,_=s*c,v=s*l,y=s*u;return r[0]=1-p-g,r[1]=f+y,r[2]=m-v,r[3]=0,r[4]=f-y,r[5]=1-d-g,r[6]=h+_,r[7]=0,r[8]=m+v,r[9]=h-_,r[10]=1-d-p,r[11]=0,r},get3DScaling:(e,t)=>{let r=t??n.create(),i=e[0],a=e[1],o=e[2],s=e[4],c=e[5],l=e[6],u=e[8],d=e[9],f=e[10];return r[0]=Math.sqrt(i*i+a*a+o*o),r[1]=Math.sqrt(s*s+c*c+l*l),r[2]=Math.sqrt(u*u+d*d+f*f),r},getAxis:(e,n,r)=>{let i=r??t.create(),a=4*n;return i[0]=e[a+0],i[1]=e[a+1],i},getScaling:(e,n)=>{let r=n??t.create(),i=e[0],a=e[1],o=e[4],s=e[5];return r[0]=Math.sqrt(i*i+a*a),r[1]=Math.sqrt(o*o+s*s),r},getTranslation:(e,n)=>{let r=n??t.create();return r[0]=e[8],r[1]=e[9],r},identity:a,inverse:o,invert:o,mul:s,mulScalar:r,multiply:s,multiplyScalar:r,negate:(t,n)=>{let r=n??new e(12);return r[0]=-t[0],r[1]=-t[1],r[2]=-t[2],r[4]=-t[4],r[5]=-t[5],r[6]=-t[6],r[8]=-t[8],r[9]=-t[9],r[10]=-t[10],r},rotate:l,rotateX:(t,n,r)=>{let i=r??new e(12),a=t[4],o=t[5],s=t[6],c=t[8],l=t[9],u=t[10],d=Math.cos(n),f=Math.sin(n);return i[4]=d*a+f*c,i[5]=d*o+f*l,i[6]=d*s+f*u,i[8]=d*c-f*a,i[9]=d*l-f*o,i[10]=d*u-f*s,t!==i&&(i[0]=t[0],i[1]=t[1],i[2]=t[2]),i},rotateY:(t,n,r)=>{let i=r??new e(12),a=t[0],o=t[1],s=t[2],c=t[8],l=t[9],u=t[10],d=Math.cos(n),f=Math.sin(n);return i[0]=d*a-f*c,i[1]=d*o-f*l,i[2]=d*s-f*u,i[8]=d*c+f*a,i[9]=d*l+f*o,i[10]=d*u+f*s,t!==i&&(i[4]=t[4],i[5]=t[5],i[6]=t[6]),i},rotateZ:l,rotation:c,rotationX:(t,n)=>{let r=n??new e(12),i=Math.cos(t),a=Math.sin(t);return r[0]=1,r[1]=0,r[2]=0,r[4]=0,r[5]=i,r[6]=a,r[8]=0,r[9]=-a,r[10]=i,r},rotationY:(t,n)=>{let r=n??new e(12),i=Math.cos(t),a=Math.sin(t);return r[0]=i,r[1]=0,r[2]=-a,r[4]=0,r[5]=1,r[6]=0,r[8]=a,r[9]=0,r[10]=i,r},rotationZ:c,scale:(t,n,r)=>{let i=r??new e(12),a=n[0],o=n[1];return i[0]=a*t[0],i[1]=a*t[1],i[2]=a*t[2],i[4]=o*t[4],i[5]=o*t[5],i[6]=o*t[6],t!==i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10]),i},scale3D:(t,n,r)=>{let i=r??new e(12),a=n[0],o=n[1],s=n[2];return i[0]=a*t[0],i[1]=a*t[1],i[2]=a*t[2],i[4]=o*t[4],i[5]=o*t[5],i[6]=o*t[6],i[8]=s*t[8],i[9]=s*t[9],i[10]=s*t[10],i},scaling:(t,n)=>{let r=n??new e(12);return r[0]=t[0],r[1]=0,r[2]=0,r[4]=0,r[5]=t[1],r[6]=0,r[8]=0,r[9]=0,r[10]=1,r},scaling3D:(t,n)=>{let r=n??new e(12);return r[0]=t[0],r[1]=0,r[2]=0,r[4]=0,r[5]=t[1],r[6]=0,r[8]=0,r[9]=0,r[10]=t[2],r},set:(t,n,r,i,a,o,s,c,l,u)=>{let d=u??new e(12);return d[0]=t,d[1]=n,d[2]=r,d[3]=0,d[4]=i,d[5]=a,d[6]=o,d[7]=0,d[8]=s,d[9]=c,d[10]=l,d[11]=0,d},setAxis:(e,t,n,r)=>{let a=r===e?e:i(e,r),o=4*n;return a[o+0]=t[0],a[o+1]=t[1],a},setTranslation:(e,t,n)=>{let r=n??a();return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[4]=e[4],r[5]=e[5],r[6]=e[6]),r[8]=t[0],r[9]=t[1],r[10]=1,r},translate:(t,n,r)=>{let i=r??new e(12),a=n[0],o=n[1],s=t[0],c=t[1],l=t[2],u=t[4],d=t[5],f=t[6],p=t[8],m=t[9],h=t[10];return t!==i&&(i[0]=s,i[1]=c,i[2]=l,i[4]=u,i[5]=d,i[6]=f),i[8]=s*a+u*o+p,i[9]=c*a+d*o+m,i[10]=l*a+f*o+h,i},translation:(t,n)=>{let r=n??new e(12);return r[0]=1,r[1]=0,r[2]=0,r[4]=0,r[5]=1,r[6]=0,r[8]=t[0],r[9]=t[1],r[10]=1,r},transpose:(t,n)=>{let r=n??new e(12);if(r===t){let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,r}let i=t[0],a=t[1],o=t[2],s=t[4],c=t[5],l=t[6],u=t[8],d=t[9],f=t[10];return r[0]=i,r[1]=s,r[2]=u,r[4]=a,r[5]=c,r[6]=d,r[8]=o,r[9]=l,r[10]=f,r},uniformScale:(t,n,r)=>{let i=r??new e(12);return i[0]=n*t[0],i[1]=n*t[1],i[2]=n*t[2],i[4]=n*t[4],i[5]=n*t[5],i[6]=n*t[6],t!==i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10]),i},uniformScale3D:(t,n,r)=>{let i=r??new e(12);return i[0]=n*t[0],i[1]=n*t[1],i[2]=n*t[2],i[4]=n*t[4],i[5]=n*t[5],i[6]=n*t[6],i[8]=n*t[8],i[9]=n*t[9],i[10]=n*t[10],i},uniformScaling:(t,n)=>{let r=n??new e(12);return r[0]=t,r[1]=0,r[2]=0,r[4]=0,r[5]=t,r[6]=0,r[8]=0,r[9]=0,r[10]=1,r},uniformScaling3D:(t,n)=>{let r=n??new e(12);return r[0]=t,r[1]=0,r[2]=0,r[4]=0,r[5]=t,r[6]=0,r[8]=0,r[9]=0,r[10]=t,r}}})(e),on.set(e,t)),t}var cn=new Map;function ln(e){let t=cn.get(e);return t||(t=(e=>{let t=an(e);function n(t,n,r){let i=r??new e(16);return i[0]=t[0]*n,i[1]=t[1]*n,i[2]=t[2]*n,i[3]=t[3]*n,i[4]=t[4]*n,i[5]=t[5]*n,i[6]=t[6]*n,i[7]=t[7]*n,i[8]=t[8]*n,i[9]=t[9]*n,i[10]=t[10]*n,i[11]=t[11]*n,i[12]=t[12]*n,i[13]=t[13]*n,i[14]=t[14]*n,i[15]=t[15]*n,i}let r=n;function i(t,n){let r=n??new e(16);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r}let a=i;function o(t){let n=t??new e(16);return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function s(t,n){let r=n??new e(16),i=t[0],a=t[1],o=t[2],s=t[3],c=t[4],l=t[5],u=t[6],d=t[7],f=t[8],p=t[9],m=t[10],h=t[11],g=t[12],_=t[13],v=t[14],y=t[15],b=m*y,x=v*h,S=u*y,C=v*d,w=u*h,T=m*d,E=o*y,D=v*s,O=o*h,ee=m*s,te=o*d,ne=u*s,re=f*_,ie=g*p,ae=c*_,oe=g*l,se=c*p,ce=f*l,le=i*_,ue=g*a,k=i*p,de=f*a,fe=i*l,pe=c*a,me=b*l+C*p+w*_-(x*l+S*p+T*_),A=x*a+E*p+ee*_-(b*a+D*p+O*_),j=S*a+D*l+te*_-(C*a+E*l+ne*_),he=T*a+O*l+ne*p-(w*a+ee*l+te*p),M=1/(i*me+c*A+f*j+g*he);return r[0]=M*me,r[1]=M*A,r[2]=M*j,r[3]=M*he,r[4]=M*(x*c+S*f+T*g-(b*c+C*f+w*g)),r[5]=M*(b*i+D*f+O*g-(x*i+E*f+ee*g)),r[6]=M*(C*i+E*c+ne*g-(S*i+D*c+te*g)),r[7]=M*(w*i+ee*c+te*f-(T*i+O*c+ne*f)),r[8]=M*(re*d+oe*h+se*y-(ie*d+ae*h+ce*y)),r[9]=M*(ie*s+le*h+de*y-(re*s+ue*h+k*y)),r[10]=M*(ae*s+ue*d+fe*y-(oe*s+le*d+pe*y)),r[11]=M*(ce*s+k*d+pe*h-(se*s+de*d+fe*h)),r[12]=M*(ae*m+ce*v+ie*u-(se*v+re*u+oe*m)),r[13]=M*(k*v+re*o+ue*m-(le*m+de*v+ie*o)),r[14]=M*(le*u+pe*v+oe*o-(fe*v+ae*o+ue*u)),r[15]=M*(fe*m+se*o+de*u-(k*u+pe*m+ce*o)),r}let c=s;function l(t,n,r){let i=r??new e(16),a=t[0],o=t[1],s=t[2],c=t[3],l=t[4],u=t[5],d=t[6],f=t[7],p=t[8],m=t[9],h=t[10],g=t[11],_=t[12],v=t[13],y=t[14],b=t[15],x=n[0],S=n[1],C=n[2],w=n[3],T=n[4],E=n[5],D=n[6],O=n[7],ee=n[8],te=n[9],ne=n[10],re=n[11],ie=n[12],ae=n[13],oe=n[14],se=n[15];return i[0]=a*x+l*S+p*C+_*w,i[1]=o*x+u*S+m*C+v*w,i[2]=s*x+d*S+h*C+y*w,i[3]=c*x+f*S+g*C+b*w,i[4]=a*T+l*E+p*D+_*O,i[5]=o*T+u*E+m*D+v*O,i[6]=s*T+d*E+h*D+y*O,i[7]=c*T+f*E+g*D+b*O,i[8]=a*ee+l*te+p*ne+_*re,i[9]=o*ee+u*te+m*ne+v*re,i[10]=s*ee+d*te+h*ne+y*re,i[11]=c*ee+f*te+g*ne+b*re,i[12]=a*ie+l*ae+p*oe+_*se,i[13]=o*ie+u*ae+m*oe+v*se,i[14]=s*ie+d*ae+h*oe+y*se,i[15]=c*ie+f*ae+g*oe+b*se,i}let u=l,d=t.create(),f=t.create(),p=t.create();function m(t,n,r){let i=r??new e(16),a=t[0],o=t[1],s=t[2],c=Math.sqrt(a*a+o*o+s*s);a/=c,o/=c,s/=c;let l=a*a,u=o*o,d=s*s,f=Math.cos(n),p=Math.sin(n),m=1-f;return i[0]=l+(1-l)*f,i[1]=a*o*m+s*p,i[2]=a*s*m-o*p,i[3]=0,i[4]=a*o*m-s*p,i[5]=u+(1-u)*f,i[6]=o*s*m+a*p,i[7]=0,i[8]=a*s*m+o*p,i[9]=o*s*m-a*p,i[10]=d+(1-d)*f,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function h(t,n,r,i){let a=i??new e(16),o=n[0],s=n[1],c=n[2],l=Math.sqrt(o*o+s*s+c*c);o/=l,s/=l,c/=l;let u=o*o,d=s*s,f=c*c,p=Math.cos(r),m=Math.sin(r),h=1-p,g=u+(1-u)*p,_=o*s*h+c*m,v=o*c*h-s*m,y=o*s*h-c*m,b=d+(1-d)*p,x=s*c*h+o*m,S=o*c*h+s*m,C=s*c*h-o*m,w=f+(1-f)*p,T=t[0],E=t[1],D=t[2],O=t[3],ee=t[4],te=t[5],ne=t[6],re=t[7],ie=t[8],ae=t[9],oe=t[10],se=t[11];return a[0]=g*T+_*ee+v*ie,a[1]=g*E+_*te+v*ae,a[2]=g*D+_*ne+v*oe,a[3]=g*O+_*re+v*se,a[4]=y*T+b*ee+x*ie,a[5]=y*E+b*te+x*ae,a[6]=y*D+b*ne+x*oe,a[7]=y*O+b*re+x*se,a[8]=S*T+C*ee+w*ie,a[9]=S*E+C*te+w*ae,a[10]=S*D+C*ne+w*oe,a[11]=S*O+C*re+w*se,t!==a&&(a[12]=t[12],a[13]=t[13],a[14]=t[14],a[15]=t[15]),a}return{add:(t,n,r)=>{let i=r??new e(16);return i[0]=t[0]+n[0],i[1]=t[1]+n[1],i[2]=t[2]+n[2],i[3]=t[3]+n[3],i[4]=t[4]+n[4],i[5]=t[5]+n[5],i[6]=t[6]+n[6],i[7]=t[7]+n[7],i[8]=t[8]+n[8],i[9]=t[9]+n[9],i[10]=t[10]+n[10],i[11]=t[11]+n[11],i[12]=t[12]+n[12],i[13]=t[13]+n[13],i[14]=t[14]+n[14],i[15]=t[15]+n[15],i},aim:(n,r,i,a)=>{let o=a??new e(16);return t.normalize(t.subtract(r,n,p),p),t.normalize(t.cross(i,p,d),d),t.normalize(t.cross(p,d,f),f),o[0]=d[0],o[1]=d[1],o[2]=d[2],o[3]=0,o[4]=f[0],o[5]=f[1],o[6]=f[2],o[7]=0,o[8]=p[0],o[9]=p[1],o[10]=p[2],o[11]=0,o[12]=n[0],o[13]=n[1],o[14]=n[2],o[15]=1,o},axisRotate:h,axisRotation:m,cameraAim:(n,r,i,a)=>{let o=a??new e(16);return t.normalize(t.subtract(n,r,p),p),t.normalize(t.cross(i,p,d),d),t.normalize(t.cross(p,d,f),f),o[0]=d[0],o[1]=d[1],o[2]=d[2],o[3]=0,o[4]=f[0],o[5]=f[1],o[6]=f[2],o[7]=0,o[8]=p[0],o[9]=p[1],o[10]=p[2],o[11]=0,o[12]=n[0],o[13]=n[1],o[14]=n[2],o[15]=1,o},clone:a,copy:i,create:(t,n,r,i,a,o,s,c,l,u,d,f,p,m,h,g)=>{let _=new e(16);return t!==void 0&&(_[0]=t,n!==void 0&&(_[1]=n,r!==void 0&&(_[2]=r,i!==void 0&&(_[3]=i,a!==void 0&&(_[4]=a,o!==void 0&&(_[5]=o,s!==void 0&&(_[6]=s,c!==void 0&&(_[7]=c,l!==void 0&&(_[8]=l,u!==void 0&&(_[9]=u,d!==void 0&&(_[10]=d,f!==void 0&&(_[11]=f,p!==void 0&&(_[12]=p,m!==void 0&&(_[13]=m,h!==void 0&&(_[14]=h,g!==void 0&&(_[15]=g)))))))))))))))),_},determinant:e=>{let t=e[0],n=e[1],r=e[2],i=e[3],a=e[4],o=e[5],s=e[6],c=e[7],l=e[8],u=e[9],d=e[10],f=e[11],p=e[12],m=e[13],h=e[14],g=e[15],_=d*g,v=h*f,y=s*g,b=h*c,x=s*f,S=d*c,C=r*g,w=h*i,T=r*f,E=d*i,D=r*c,O=s*i;return t*(_*o+b*u+x*m-(v*o+y*u+S*m))+a*(v*n+C*u+E*m-(_*n+w*u+T*m))+l*(y*n+w*o+D*m-(b*n+C*o+O*m))+p*(S*n+T*o+O*u-(x*n+E*o+D*u))},equals:(e,t)=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15],equalsApproximately:(e,t)=>Math.abs(e[0]-t[0])<q&&Math.abs(e[1]-t[1])<q&&Math.abs(e[2]-t[2])<q&&Math.abs(e[3]-t[3])<q&&Math.abs(e[4]-t[4])<q&&Math.abs(e[5]-t[5])<q&&Math.abs(e[6]-t[6])<q&&Math.abs(e[7]-t[7])<q&&Math.abs(e[8]-t[8])<q&&Math.abs(e[9]-t[9])<q&&Math.abs(e[10]-t[10])<q&&Math.abs(e[11]-t[11])<q&&Math.abs(e[12]-t[12])<q&&Math.abs(e[13]-t[13])<q&&Math.abs(e[14]-t[14])<q&&Math.abs(e[15]-t[15])<q,fromMat3:(t,n)=>{let r=n??new e(16);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=0,r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=0,r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},fromQuat:(t,n)=>{let r=n??new e(16),i=t[0],a=t[1],o=t[2],s=t[3],c=i+i,l=a+a,u=o+o,d=i*c,f=a*c,p=a*l,m=o*c,h=o*l,g=o*u,_=s*c,v=s*l,y=s*u;return r[0]=1-p-g,r[1]=f+y,r[2]=m-v,r[3]=0,r[4]=f-y,r[5]=1-d-g,r[6]=h+_,r[7]=0,r[8]=m+v,r[9]=h-_,r[10]=1-d-p,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},frustum:(t,n,r,i,a,o,s)=>{let c=s??new e(16),l=n-t,u=i-r,d=a-o;return c[0]=2*a/l,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=2*a/u,c[6]=0,c[7]=0,c[8]=(t+n)/l,c[9]=(i+r)/u,c[10]=o/d,c[11]=-1,c[12]=0,c[13]=0,c[14]=a*o/d,c[15]=0,c},frustumReverseZ:(t,n,r,i,a,o=1/0,s)=>{let c=s??new e(16),l=n-t,u=i-r;if(c[0]=2*a/l,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=2*a/u,c[6]=0,c[7]=0,c[8]=(t+n)/l,c[9]=(i+r)/u,c[11]=-1,c[12]=0,c[13]=0,c[15]=0,o===1/0)c[10]=0,c[14]=a;else{let e=1/(o-a);c[10]=a*e,c[14]=o*a*e}return c},getAxis:(e,n,r)=>{let i=r??t.create(),a=4*n;return i[0]=e[a+0],i[1]=e[a+1],i[2]=e[a+2],i},getScaling:(e,n)=>{let r=n??t.create(),i=e[0],a=e[1],o=e[2],s=e[4],c=e[5],l=e[6],u=e[8],d=e[9],f=e[10];return r[0]=Math.sqrt(i*i+a*a+o*o),r[1]=Math.sqrt(s*s+c*c+l*l),r[2]=Math.sqrt(u*u+d*d+f*f),r},getTranslation:(e,n)=>{let r=n??t.create();return r[0]=e[12],r[1]=e[13],r[2]=e[14],r},identity:o,inverse:s,invert:c,lookAt:(n,r,i,a)=>{let o=a??new e(16);return t.normalize(t.subtract(n,r,p),p),t.normalize(t.cross(i,p,d),d),t.normalize(t.cross(p,d,f),f),o[0]=d[0],o[1]=f[0],o[2]=p[0],o[3]=0,o[4]=d[1],o[5]=f[1],o[6]=p[1],o[7]=0,o[8]=d[2],o[9]=f[2],o[10]=p[2],o[11]=0,o[12]=-(d[0]*n[0]+d[1]*n[1]+d[2]*n[2]),o[13]=-(f[0]*n[0]+f[1]*n[1]+f[2]*n[2]),o[14]=-(p[0]*n[0]+p[1]*n[1]+p[2]*n[2]),o[15]=1,o},mul:u,mulScalar:r,multiply:l,multiplyScalar:n,negate:(t,n)=>{let r=n??new e(16);return r[0]=-t[0],r[1]=-t[1],r[2]=-t[2],r[3]=-t[3],r[4]=-t[4],r[5]=-t[5],r[6]=-t[6],r[7]=-t[7],r[8]=-t[8],r[9]=-t[9],r[10]=-t[10],r[11]=-t[11],r[12]=-t[12],r[13]=-t[13],r[14]=-t[14],r[15]=-t[15],r},ortho:(t,n,r,i,a,o,s)=>{let c=s??new e(16);return c[0]=2/(n-t),c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=2/(i-r),c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=1/(a-o),c[11]=0,c[12]=(n+t)/(t-n),c[13]=(i+r)/(r-i),c[14]=a/(a-o),c[15]=1,c},perspective:(t,n,r,i,a)=>{let o=a??new e(16),s=Math.tan(.5*Math.PI-.5*t);if(o[0]=s/n,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=s,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=-1,o[12]=0,o[13]=0,o[15]=0,Number.isFinite(i)){let e=1/(r-i);o[10]=i*e,o[14]=i*r*e}else o[10]=-1,o[14]=-r;return o},perspectiveReverseZ:(t,n,r,i=1/0,a)=>{let o=a??new e(16),s=1/Math.tan(.5*t);if(o[0]=s/n,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=s,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=-1,o[12]=0,o[13]=0,o[15]=0,i===1/0)o[10]=0,o[14]=r;else{let e=1/(i-r);o[10]=r*e,o[14]=i*r*e}return o},rotate:h,rotateX:(t,n,r)=>{let i=r??new e(16),a=t[4],o=t[5],s=t[6],c=t[7],l=t[8],u=t[9],d=t[10],f=t[11],p=Math.cos(n),m=Math.sin(n);return i[4]=p*a+m*l,i[5]=p*o+m*u,i[6]=p*s+m*d,i[7]=p*c+m*f,i[8]=p*l-m*a,i[9]=p*u-m*o,i[10]=p*d-m*s,i[11]=p*f-m*c,t!==i&&(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i},rotateY:(t,n,r)=>{let i=r??new e(16),a=t[0],o=t[1],s=t[2],c=t[3],l=t[8],u=t[9],d=t[10],f=t[11],p=Math.cos(n),m=Math.sin(n);return i[0]=p*a-m*l,i[1]=p*o-m*u,i[2]=p*s-m*d,i[3]=p*c-m*f,i[8]=p*l+m*a,i[9]=p*u+m*o,i[10]=p*d+m*s,i[11]=p*f+m*c,t!==i&&(i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i},rotateZ:(t,n,r)=>{let i=r??new e(16),a=t[0],o=t[1],s=t[2],c=t[3],l=t[4],u=t[5],d=t[6],f=t[7],p=Math.cos(n),m=Math.sin(n);return i[0]=p*a+m*l,i[1]=p*o+m*u,i[2]=p*s+m*d,i[3]=p*c+m*f,i[4]=p*l-m*a,i[5]=p*u-m*o,i[6]=p*d-m*s,i[7]=p*f-m*c,t!==i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i},rotation:m,rotationX:(t,n)=>{let r=n??new e(16),i=Math.cos(t),a=Math.sin(t);return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=i,r[6]=a,r[7]=0,r[8]=0,r[9]=-a,r[10]=i,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},rotationY:(t,n)=>{let r=n??new e(16),i=Math.cos(t),a=Math.sin(t);return r[0]=i,r[1]=0,r[2]=-a,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=a,r[9]=0,r[10]=i,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},rotationZ:(t,n)=>{let r=n??new e(16),i=Math.cos(t),a=Math.sin(t);return r[0]=i,r[1]=a,r[2]=0,r[3]=0,r[4]=-a,r[5]=i,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},scale:(t,n,r)=>{let i=r??new e(16),a=n[0],o=n[1],s=n[2];return i[0]=a*t[0],i[1]=a*t[1],i[2]=a*t[2],i[3]=a*t[3],i[4]=o*t[4],i[5]=o*t[5],i[6]=o*t[6],i[7]=o*t[7],i[8]=s*t[8],i[9]=s*t[9],i[10]=s*t[10],i[11]=s*t[11],t!==i&&(i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i},scaling:(t,n)=>{let r=n??new e(16);return r[0]=t[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},set:(t,n,r,i,a,o,s,c,l,u,d,f,p,m,h,g,_)=>{let v=_??new e(16);return v[0]=t,v[1]=n,v[2]=r,v[3]=i,v[4]=a,v[5]=o,v[6]=s,v[7]=c,v[8]=l,v[9]=u,v[10]=d,v[11]=f,v[12]=p,v[13]=m,v[14]=h,v[15]=g,v},setAxis:(e,t,n,r)=>{let a=r===e?r:i(e,r),o=4*n;return a[o+0]=t[0],a[o+1]=t[1],a[o+2]=t[2],a},setTranslation:(e,t,n)=>{let r=n??o();return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11]),r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r},translate:(t,n,r)=>{let i=r??new e(16),a=n[0],o=n[1],s=n[2],c=t[0],l=t[1],u=t[2],d=t[3],f=t[4],p=t[5],m=t[6],h=t[7],g=t[8],_=t[9],v=t[10],y=t[11],b=t[12],x=t[13],S=t[14],C=t[15];return t!==i&&(i[0]=c,i[1]=l,i[2]=u,i[3]=d,i[4]=f,i[5]=p,i[6]=m,i[7]=h,i[8]=g,i[9]=_,i[10]=v,i[11]=y),i[12]=c*a+f*o+g*s+b,i[13]=l*a+p*o+_*s+x,i[14]=u*a+m*o+v*s+S,i[15]=d*a+h*o+y*s+C,i},translation:(t,n)=>{let r=n??new e(16);return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r},transpose:(t,n)=>{let r=n??new e(16);if(r===t){let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,r}let i=t[0],a=t[1],o=t[2],s=t[3],c=t[4],l=t[5],u=t[6],d=t[7],f=t[8],p=t[9],m=t[10],h=t[11],g=t[12],_=t[13],v=t[14],y=t[15];return r[0]=i,r[1]=c,r[2]=f,r[3]=g,r[4]=a,r[5]=l,r[6]=p,r[7]=_,r[8]=o,r[9]=u,r[10]=m,r[11]=v,r[12]=s,r[13]=d,r[14]=h,r[15]=y,r},uniformScale:(t,n,r)=>{let i=r??new e(16);return i[0]=n*t[0],i[1]=n*t[1],i[2]=n*t[2],i[3]=n*t[3],i[4]=n*t[4],i[5]=n*t[5],i[6]=n*t[6],i[7]=n*t[7],i[8]=n*t[8],i[9]=n*t[9],i[10]=n*t[10],i[11]=n*t[11],t!==i&&(i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i},uniformScaling:(t,n)=>{let r=n??new e(16);return r[0]=t,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}}})(e),cn.set(e,t)),t}var un=new Map;function dn(e){let t=un.get(e);return t||(t=(e=>{let t=an(e);function n(t,n,r,i){let a=new e(4);return t!==void 0&&(a[0]=t,n!==void 0&&(a[1]=n,r!==void 0&&(a[2]=r,i!==void 0&&(a[3]=i)))),a}let r=n;function i(t,n,r){let i=r??new e(4),a=.5*n,o=Math.sin(a);return i[0]=o*t[0],i[1]=o*t[1],i[2]=o*t[2],i[3]=Math.cos(a),i}function a(t,n,r){let i=r??new e(4),a=t[0],o=t[1],s=t[2],c=t[3],l=n[0],u=n[1],d=n[2],f=n[3];return i[0]=a*f+c*l+o*d-s*u,i[1]=o*f+c*u+s*l-a*d,i[2]=s*f+c*d+a*u-o*l,i[3]=c*f-a*l-o*u-s*d,i}let o=a;function s(t,n,r,i){let a=i??new e(4),o=t[0],s=t[1],c=t[2],l=t[3],u,d,f=n[0],p=n[1],m=n[2],h=n[3],g=o*f+s*p+c*m+l*h;if(g<0&&(g=-g,f=-f,p=-p,m=-m,h=-h),1-g>q){let e=Math.acos(g),t=Math.sin(e);u=Math.sin((1-r)*e)/t,d=Math.sin(r*e)/t}else u=1-r,d=r;return a[0]=u*o+d*f,a[1]=u*s+d*p,a[2]=u*c+d*m,a[3]=u*l+d*h,a}function c(t,n){let r=n??new e(4);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r}let l=c;function u(t,n,r){let i=r??new e(4);return i[0]=t[0]-n[0],i[1]=t[1]-n[1],i[2]=t[2]-n[2],i[3]=t[3]-n[3],i}let d=u;function f(t,n,r){let i=r??new e(4);return i[0]=t[0]*n,i[1]=t[1]*n,i[2]=t[2]*n,i[3]=t[3]*n,i}let p=f;function m(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function h(e){let t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)}let g=h;function _(e){let t=e[0],n=e[1],r=e[2],i=e[3];return t*t+n*n+r*r+i*i}let v=_;function y(t,n){let r=n??new e(4),i=t[0],a=t[1],o=t[2],s=t[3],c=Math.sqrt(i*i+a*a+o*o+s*s);return c>1e-5?(r[0]=i/c,r[1]=a/c,r[2]=o/c,r[3]=s/c):(r[0]=0,r[1]=0,r[2]=0,r[3]=1),r}let b=t.create(),x=t.create(),S=t.create(),C=new e(4),w=new e(4);return{create:n,fromValues:r,set:(t,n,r,i,a)=>{let o=a??new e(4);return o[0]=t,o[1]=n,o[2]=r,o[3]=i,o},fromAxisAngle:i,toAxisAngle:(e,n)=>{let r=n??t.create(3),i=2*Math.acos(e[3]),a=Math.sin(.5*i);return a>q?(r[0]=e[0]/a,r[1]=e[1]/a,r[2]=e[2]/a):(r[0]=1,r[1]=0,r[2]=0),{angle:i,axis:r}},angle:(e,t)=>{let n=m(e,t);return Math.acos(2*n*n-1)},multiply:a,mul:o,rotateX:(t,n,r)=>{let i=r??new e(4),a=.5*n,o=t[0],s=t[1],c=t[2],l=t[3],u=Math.sin(a),d=Math.cos(a);return i[0]=o*d+l*u,i[1]=s*d+c*u,i[2]=c*d-s*u,i[3]=l*d-o*u,i},rotateY:(t,n,r)=>{let i=r??new e(4),a=.5*n,o=t[0],s=t[1],c=t[2],l=t[3],u=Math.sin(a),d=Math.cos(a);return i[0]=o*d-c*u,i[1]=s*d+l*u,i[2]=c*d+o*u,i[3]=l*d-s*u,i},rotateZ:(t,n,r)=>{let i=r??new e(4),a=.5*n,o=t[0],s=t[1],c=t[2],l=t[3],u=Math.sin(a),d=Math.cos(a);return i[0]=o*d+s*u,i[1]=s*d-o*u,i[2]=c*d+l*u,i[3]=l*d-c*u,i},slerp:s,inverse:(t,n)=>{let r=n??new e(4),i=t[0],a=t[1],o=t[2],s=t[3],c=i*i+a*a+o*o+s*s,l=c?1/c:0;return r[0]=-i*l,r[1]=-a*l,r[2]=-o*l,r[3]=s*l,r},conjugate:(t,n)=>{let r=n??new e(4);return r[0]=-t[0],r[1]=-t[1],r[2]=-t[2],r[3]=t[3],r},fromMat:(t,n)=>{let r=n??new e(4),i=t[0]+t[5]+t[10];if(i>0){let e=Math.sqrt(i+1);r[3]=.5*e;let n=.5/e;r[0]=(t[6]-t[9])*n,r[1]=(t[8]-t[2])*n,r[2]=(t[1]-t[4])*n}else{let e=0;t[5]>t[0]&&(e=1),t[10]>t[4*e+e]&&(e=2);let n=(e+1)%3,i=(e+2)%3,a=Math.sqrt(t[4*e+e]-t[4*n+n]-t[4*i+i]+1);r[e]=.5*a;let o=.5/a;r[3]=(t[4*n+i]-t[4*i+n])*o,r[n]=(t[4*n+e]+t[4*e+n])*o,r[i]=(t[4*i+e]+t[4*e+i])*o}return r},fromEuler:(t,n,r,i,a)=>{let o=a??new e(4),s=.5*t,c=.5*n,l=.5*r,u=Math.sin(s),d=Math.cos(s),f=Math.sin(c),p=Math.cos(c),m=Math.sin(l),h=Math.cos(l);switch(i){case`xyz`:o[0]=u*p*h+d*f*m,o[1]=d*f*h-u*p*m,o[2]=d*p*m+u*f*h,o[3]=d*p*h-u*f*m;break;case`xzy`:o[0]=u*p*h-d*f*m,o[1]=d*f*h-u*p*m,o[2]=d*p*m+u*f*h,o[3]=d*p*h+u*f*m;break;case`yxz`:o[0]=u*p*h+d*f*m,o[1]=d*f*h-u*p*m,o[2]=d*p*m-u*f*h,o[3]=d*p*h+u*f*m;break;case`yzx`:o[0]=u*p*h+d*f*m,o[1]=d*f*h+u*p*m,o[2]=d*p*m-u*f*h,o[3]=d*p*h-u*f*m;break;case`zxy`:o[0]=u*p*h-d*f*m,o[1]=d*f*h+u*p*m,o[2]=d*p*m+u*f*h,o[3]=d*p*h-u*f*m;break;case`zyx`:o[0]=u*p*h-d*f*m,o[1]=d*f*h+u*p*m,o[2]=d*p*m-u*f*h,o[3]=d*p*h+u*f*m;break;default:throw Error(`Unknown rotation order: ${i}`)}return o},copy:c,clone:l,add:(t,n,r)=>{let i=r??new e(4);return i[0]=t[0]+n[0],i[1]=t[1]+n[1],i[2]=t[2]+n[2],i[3]=t[3]+n[3],i},subtract:u,sub:d,mulScalar:f,scale:p,divScalar:(t,n,r)=>{let i=r??new e(4);return i[0]=t[0]/n,i[1]=t[1]/n,i[2]=t[2]/n,i[3]=t[3]/n,i},dot:m,lerp:(t,n,r,i)=>{let a=i??new e(4);return a[0]=t[0]+r*(n[0]-t[0]),a[1]=t[1]+r*(n[1]-t[1]),a[2]=t[2]+r*(n[2]-t[2]),a[3]=t[3]+r*(n[3]-t[3]),a},length:h,len:g,lengthSq:_,lenSq:v,normalize:y,equalsApproximately:(e,t)=>Math.abs(e[0]-t[0])<q&&Math.abs(e[1]-t[1])<q&&Math.abs(e[2]-t[2])<q&&Math.abs(e[3]-t[3])<q,equals:(e,t)=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3],identity:t=>{let n=t??new e(4);return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n},rotationTo:(n,r,a)=>{let o=a??new e(4),s=t.dot(n,r);return s<-.999999?(t.cross(x,n,b),t.len(b)<1e-6&&t.cross(S,n,b),t.normalize(b,b),i(b,Math.PI,o),o):s>.999999?(o[0]=0,o[1]=0,o[2]=0,o[3]=1,o):(t.cross(n,r,b),o[0]=b[0],o[1]=b[1],o[2]=b[2],o[3]=1+s,y(o,o))},sqlerp:(t,n,r,i,a,o)=>{let c=o??new e(4);return s(t,i,a,C),s(n,r,a,w),s(C,w,2*a*(1-a),c),c}}})(e),un.set(e,t)),t}var fn=new Map;function pn(e){let t=fn.get(e);return t||(t=(e=>{function t(t,n,r,i){let a=new e(4);return t!==void 0&&(a[0]=t,n!==void 0&&(a[1]=n,r!==void 0&&(a[2]=r,i!==void 0&&(a[3]=i)))),a}function n(t,n,r){let i=r??new e(4);return i[0]=t[0]-n[0],i[1]=t[1]-n[1],i[2]=t[2]-n[2],i[3]=t[3]-n[3],i}function r(t,n,r,i){let a=i??new e(4);return a[0]=t[0]+r*(n[0]-t[0]),a[1]=t[1]+r*(n[1]-t[1]),a[2]=t[2]+r*(n[2]-t[2]),a[3]=t[3]+r*(n[3]-t[3]),a}function i(t,n,r){let i=r??new e(4);return i[0]=t[0]*n,i[1]=t[1]*n,i[2]=t[2]*n,i[3]=t[3]*n,i}function a(t,n){let r=n??new e(4);return r[0]=1/t[0],r[1]=1/t[1],r[2]=1/t[2],r[3]=1/t[3],r}function o(e){let t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)}function s(e){let t=e[0],n=e[1],r=e[2],i=e[3];return t*t+n*n+r*r+i*i}function c(e,t){let n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],a=e[3]-t[3];return Math.sqrt(n*n+r*r+i*i+a*a)}function l(e,t){let n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],a=e[3]-t[3];return n*n+r*r+i*i+a*a}function u(t,n){let r=n??new e(4),i=t[0],a=t[1],o=t[2],s=t[3],c=Math.sqrt(i*i+a*a+o*o+s*s);return c>1e-5?(r[0]=i/c,r[1]=a/c,r[2]=o/c,r[3]=s/c):(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function d(t,n){let r=n??new e(4);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r}function f(t,n,r){let i=r??new e(4);return i[0]=t[0]*n[0],i[1]=t[1]*n[1],i[2]=t[2]*n[2],i[3]=t[3]*n[3],i}function p(t,n,r){let i=r??new e(4);return i[0]=t[0]/n[0],i[1]=t[1]/n[1],i[2]=t[2]/n[2],i[3]=t[3]/n[3],i}function m(t,n,r){let a=r??new e(4);return u(t,a),i(a,n,a)}return{create:t,fromValues:t,set:(t,n,r,i,a)=>{let o=a??new e(4);return o[0]=t,o[1]=n,o[2]=r,o[3]=i,o},ceil:(t,n)=>{let r=n??new e(4);return r[0]=Math.ceil(t[0]),r[1]=Math.ceil(t[1]),r[2]=Math.ceil(t[2]),r[3]=Math.ceil(t[3]),r},floor:(t,n)=>{let r=n??new e(4);return r[0]=Math.floor(t[0]),r[1]=Math.floor(t[1]),r[2]=Math.floor(t[2]),r[3]=Math.floor(t[3]),r},round:(t,n)=>{let r=n??new e(4);return r[0]=Math.round(t[0]),r[1]=Math.round(t[1]),r[2]=Math.round(t[2]),r[3]=Math.round(t[3]),r},clamp:(t,n=0,r=1,i)=>{let a=i??new e(4);return a[0]=Math.min(r,Math.max(n,t[0])),a[1]=Math.min(r,Math.max(n,t[1])),a[2]=Math.min(r,Math.max(n,t[2])),a[3]=Math.min(r,Math.max(n,t[3])),a},add:(t,n,r)=>{let i=r??new e(4);return i[0]=t[0]+n[0],i[1]=t[1]+n[1],i[2]=t[2]+n[2],i[3]=t[3]+n[3],i},addScaled:(t,n,r,i)=>{let a=i??new e(4);return a[0]=t[0]+n[0]*r,a[1]=t[1]+n[1]*r,a[2]=t[2]+n[2]*r,a[3]=t[3]+n[3]*r,a},subtract:n,sub:n,equalsApproximately:(e,t)=>Math.abs(e[0]-t[0])<q&&Math.abs(e[1]-t[1])<q&&Math.abs(e[2]-t[2])<q&&Math.abs(e[3]-t[3])<q,equals:(e,t)=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3],lerp:r,lerpV:(t,n,r,i)=>{let a=i??new e(4);return a[0]=t[0]+r[0]*(n[0]-t[0]),a[1]=t[1]+r[1]*(n[1]-t[1]),a[2]=t[2]+r[2]*(n[2]-t[2]),a[3]=t[3]+r[3]*(n[3]-t[3]),a},max:(t,n,r)=>{let i=r??new e(4);return i[0]=Math.max(t[0],n[0]),i[1]=Math.max(t[1],n[1]),i[2]=Math.max(t[2],n[2]),i[3]=Math.max(t[3],n[3]),i},min:(t,n,r)=>{let i=r??new e(4);return i[0]=Math.min(t[0],n[0]),i[1]=Math.min(t[1],n[1]),i[2]=Math.min(t[2],n[2]),i[3]=Math.min(t[3],n[3]),i},mulScalar:i,scale:i,divScalar:(t,n,r)=>{let i=r??new e(4);return i[0]=t[0]/n,i[1]=t[1]/n,i[2]=t[2]/n,i[3]=t[3]/n,i},inverse:a,invert:a,dot:(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3],length:o,len:o,lengthSq:s,lenSq:s,distance:c,dist:c,distanceSq:l,distSq:l,normalize:u,negate:(t,n)=>{let r=n??new e(4);return r[0]=-t[0],r[1]=-t[1],r[2]=-t[2],r[3]=-t[3],r},copy:d,clone:d,multiply:f,mul:f,divide:p,div:p,zero:t=>{let n=t??new e(4);return n[0]=0,n[1]=0,n[2]=0,n[3]=0,n},transformMat4:(t,n,r)=>{let i=r??new e(4),a=t[0],o=t[1],s=t[2],c=t[3];return i[0]=n[0]*a+n[4]*o+n[8]*s+n[12]*c,i[1]=n[1]*a+n[5]*o+n[9]*s+n[13]*c,i[2]=n[2]*a+n[6]*o+n[10]*s+n[14]*c,i[3]=n[3]*a+n[7]*o+n[11]*s+n[15]*c,i},setLength:m,truncate:(t,n,r)=>{let i=r??new e(4);return o(t)>n?m(t,n,i):d(t,i)},midpoint:(t,n,i)=>r(t,n,.5,i??new e(4))}})(e),fn.set(e,t)),t}function mn(e,t,n,r,i,a){return{mat3:sn(e),mat4:ln(t),quat:dn(n),vec2:nn(r),vec3:an(i),vec4:pn(a)}}var{mat3:J,mat4:Y,quat:hn,vec2:gn,vec3:_n,vec4:vn}=mn(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array);mn(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),mn(Zt,Array,Array,Array,Array,Array);var X={Clamp:(e,t=0,n=1)=>Math.max(t,Math.min(e,n)),RandomInt:(e,t)=>(Math.random()*(t-e+1)|0)+e,Random:(e=0,t=1)=>Math.random()*(t-e)+e,SmootherStep:(e,t=0,n=1)=>e<=t?0:e>=n?1:(e=(e-t)/(n-t))*e*e*(e*(6*e-15)+10),SmoothStep:(e,t=0,n=1)=>e<=t?0:e>=n?1:(e=(e-t)/(n-t))*e*(3-2*e),EuclideanModulo:en.euclideanModulo,DegreesToRadians:en.degToRad,RadiansToDegrees:en.radToDeg,InverseLerp:en.inverseLerp,SetEpsilon:en.setEpsilon,EPSILON:en.EPSILON,Lerp:en.lerp,PHI:.5*Math.sqrt(5)+.5,DELTA_UPDATE:1/.06,DELTA_FRAME:1/60,RAD:Math.PI/180,DEG:180/Math.PI,HPI:Math.PI/2,TAU:2*Math.PI,Mat3:J,Mat4:Y,Quat:hn,Vec2:gn,Vec3:_n,Vec4:vn},yn=class e{#n=0;#e=0;#t=0;#r=1;constructor(e=0,t,n,r=255){typeof t==`number`&&typeof n==`number`?this.RGBA=[e,t,n,r]:this.Set(e,r)}Set(e,t=255){let n=Cn(e,t);return this.#n=n[0],this.#e=n[1],this.#t=n[2],this.#r=n[3],this}Premultiply(t,n){n??=new e,t??=this.#r;let r=this.#n*t,i=this.#e*t,a=this.#t*t;return n.rgba=[r,i,a,t],n}Random(e=1){return this.rgb=[X.Random(),X.Random(),X.Random(),e??X.Random()],this}Equals(e){let[t,n,r,i=1]=typeof e==`number`&&Cn(e)||Sn(e);return this.#n===t&&this.#e===n&&this.#t===r&&this.#r===i}set rgb(e){this.#n=e[0],this.#e=e[1],this.#t=e[2],this.#r=e[3]??1}get rgb(){return[this.#n,this.#e,this.#t]}set a(e){this.#r=e}get a(){return this.#r}set rgba(e){this.rgb=e}get rgba(){return this.rgb.concat(this.#r)}set RGB(e){this.#n=e[0]/255,this.#e=e[1]/255,this.#t=e[2]/255,this.#r=(e[3]??255)/255}get RGB(){return[255*this.#n,255*this.#e,255*this.#t]}set A(e){this.#r=e/255}get A(){return 255*this.#r}set RGBA(e){this.RGB=e}get RGBA(){return this.RGB.concat(this.A)}};function Z(e){for(let t in e)e[t]={value:e[t]};return Object.freeze(Object.create(null,e))}function bn(e){switch(e){case 2:return`unorm8x2`;case 4:return`float32`;case 8:return`float32x2`;case 12:return`float32x3`;case 16:return`float32x4`}}function xn(e){switch(e){case`uint8x2`:case`sint8x2`:case`unorm8x2`:case`snorm8x2`:return 2;case`uint32`:case`sint32`:case`float32`:case`uint8x4`:case`sint8x4`:case`unorm8x4`:case`snorm8x4`:case`uint16x2`:case`sint16x2`:case`unorm16x2`:case`snorm16x2`:case`float16x2`:return 4;case`uint16x4`:case`sint16x4`:case`uint32x2`:case`sint32x2`:case`unorm16x4`:case`snorm16x4`:case`float16x4`:case`float32x2`:return 8;case`uint32x3`:case`sint32x3`:case`float32x3`:return 12;case`uint32x4`:case`sint32x4`:case`float32x4`:return 16}return 0}function Q(e){return Array.isArray(e)&&e||[e]}function Sn(e){return e instanceof yn&&e.rgba||Object.values(e)}function Cn(e,t=255){return[(e>>16&255)/255,(e>>8&255)/255,(255&e)/255,t/255]}function wn(e){return e instanceof GPUShaderModule&&e||e.module}function Tn(e,t){return e.createBuffer(t)}function En(e,t,n,r=0,i,a){e.writeBuffer(t,r,n,i,a)}function Dn(e,t,n,r,i,a){return e[0]=t,e[1]=n,e[2]=r,e[3]=i,e[4]=a,a!==void 0&&(e[3]=a,e[4]=i),e}var On=Z({INDEX:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,VERTEX:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,STORAGE:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,UNIFORM:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,READABLE:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST,WRITABLE:GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC,QUERY:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),kn={operation:`add`,srcFactor:`one`,dstFactor:`zero`},An={operation:`add`,srcFactor:`one`,dstFactor:`one`},jn={operation:`add`,srcFactor:`one`,dstFactor:`one-minus-src-alpha`},Mn={operation:`add`,srcFactor:`one-minus-dst-alpha`,dstFactor:`one`},Nn={operation:`add`,srcFactor:`dst-alpha`,dstFactor:`zero`},Pn={operation:`add`,srcFactor:`zero`,dstFactor:`src-alpha`},Fn={operation:`add`,srcFactor:`one-minus-dst-alpha`,dstFactor:`zero`},In={operation:`add`,srcFactor:`zero`,dstFactor:`one-minus-src-alpha`},Ln={operation:`add`,srcFactor:`dst-alpha`,dstFactor:`one-minus-src-alpha`},Rn={operation:`add`,srcFactor:`one-minus-dst-alpha`,dstFactor:`src-alpha`},zn=Z({COPY:Z({color:kn,alpha:kn}),ADDITIVE:Z({color:An,alpha:An}),SOURCE_OVER:Z({color:jn,alpha:jn}),DESTINATION_OVER:Z({color:Mn,alpha:Mn}),SOURCE_IN:Z({color:Nn,alpha:Nn}),DESTINATION_IN:Z({color:Pn,alpha:Pn}),SOURCE_OUT:Z({color:Fn,alpha:Fn}),DESTINATION_OUT:Z({color:In,alpha:In}),ALPHA_ADDITIVE:Z({color:{operation:`add`,srcFactor:`src-alpha`,dstFactor:`one-minus-src-alpha`},alpha:An}),SOURCE_ATOP:Z({color:Ln,alpha:Ln}),DESTINATION_ATOP:Z({color:Rn,alpha:Rn})}),Bn=class{Children=[];Label;#n=null;RotationOrder=`XYZ`;TransformationOrder=`TRS`;ProjectionMatrix=Y.identity();#e=Y.identity();#t=Y.identity();#r=_n.set(1,1,1);#i=_n.create();#a=_n.create();constructor(e,t=null){this.Label=e,this.Parent=t}Find(e){let t=null;return this.Traverse(n=>{if(n.Label===e)return t=n}),t}Add(e){(e=Q(e)).forEach(e=>e.Parent=this)}Remove(e){(e=Q(e)).forEach(e=>e.Parent=null)}Traverse(e){if(!e(this))for(let t=0,n=this.Children.length;t<n;++t)this.Children[t].Traverse(e)}ResetLocalMatrix(){Y.identity(this.#e)}UpdateWorldMatrix(){this.#s(),this.#n?Y.multiply(this.#n.WorldMatrix,this.#e,this.#t):Y.copy(this.#e,this.#t),this.Children.forEach(e=>e.UpdateWorldMatrix())}#s(){Y.identity(this.#e);let e=this.TransformationOrder.split(``);for(let t=0,n=e.length;t<n;t++)switch(e[t]){case`T`:Y.translate(this.#e,this.#i,this.#e);break;case`R`:for(let e=0,t=this.RotationOrder.length;e<t;++e){let t=this.RotationOrder[e],n=this.#a[t.charCodeAt()-88];Y[`rotate${t}`](this.#e,n,this.#e)}break;case`S`:Y.scale(this.#e,this.#r,this.#e)}}UpdateProjectionMatrix(e){let t=this.#n&&this.#t||this.#e;return Y.multiply(e,t,this.ProjectionMatrix)}ResetProjectionMatrix(){Y.identity(this.ProjectionMatrix)}RotateAxis(e,t){Y.rotate(this.#e,e,t,this.#e)}RotateX(e){Y.rotateX(this.#e,e,this.#e)}RotateY(e){Y.rotateY(this.#e,e,this.#e)}RotateZ(e){Y.rotateZ(this.#e,e,this.#e)}Scale(e){Y.scale(this.#e,e,this.#e)}set Transform(e){Y.identity(this.#e);let[t,n,r]=e,i=this.TransformationOrder.split(``);for(let e=0,a=i.length;e<a;e++)switch(i[e]){case`T`:t&&(this.Position=t);break;case`R`:n&&(this.Rotation=n);break;case`S`:r&&(this.Scaling=r)}}set Position(e){_n.copy(e,this.#i),Y.translate(this.#e,e,this.#e)}get Position(){return this.#i}set Rotation(e){_n.copy(e,this.#a);for(let t=0,n=this.RotationOrder.length;t<n;++t){let n=this.RotationOrder[t],r=e[n.charCodeAt()-88];Y[`rotate${n}`](this.#e,r,this.#e)}}get Rotation(){return this.#a}set Scaling(e){_n.copy(e,this.#r),Y.scale(this.#e,e,this.#e)}get Scaling(){return this.#r}get LocalMatrix(){return this.#e}get WorldMatrix(){return this.#t}set Parent(e){if(this.#n){let e=this.#n.Children.indexOf(this);0<=e&&this.#n.Children.splice(e,1)}e&&e.Children.push(this),this.#n=e}get Parent(){return this.#n}},Vn=class{#n;#e;#t;Transparent=!1;#r=crypto.randomUUID();#i;#a;#s=new yn(0,0);constructor(e=16777215,t=`Mesh`){this.Color=e,this.#n=t}CreateColorBuffer(e,t=this.#n){let{color:n,buffer:r}=e.CreateUniformBuffer(`color`,{label:`${t} Color Buffer`});this.#e=n,this.#t=e,this.#a=r,this.#e.set(this.#i),e.WriteBuffer(r,n)}SetBlendConstant(e){if(!e?.BlendConstant||!this.#s.Equals(e.BlendConstant))return this.#t.BlendConstant=this.#s}set BlendConstant(e){typeof e==`number`&&this.#s.Set(e)||(this.#s.rgba=Sn(e))}get BlendConstant(){return this.#s}get ColorBuffer(){return this.#a}set Color(e){this.#i=typeof e==`number`&&Cn(e)||Sn(e),this.#e?.fill(1).set(this.#i),this.#t?.WriteBuffer(this.#a,this.#e)}get Color(){return this.#i}get ID(){return this.#r}Destroy(){this.#t=void 0,this.#a?.destroy(),this.#a=void 0}},Hn=class{Children=[];Label;#n=null;TransformationOrder=`TRS`;ProjectionMatrix=J.identity();#e=J.identity();#t=J.identity();#r=gn.create();#i=gn.set(1,1);#a=0;constructor(e,t=null){this.Label=e,this.Parent=t}Find(e){let t=null;return this.Traverse(n=>n.Label===e&&(t=n)||!1),t}Add(e){(e=Q(e)).forEach(e=>e.Parent=this)}Remove(e){(e=Q(e)).forEach(e=>e.Parent=null)}Traverse(e){if(!e(this))for(let t=0,n=this.Children.length;t<n;++t)this.Children[t].Traverse(e)}ResetLocalMatrix(){J.identity(this.#e)}UpdateWorldMatrix(){this.UpdateLocalMatrix(),this.#n?J.multiply(this.#n.WorldMatrix,this.#e,this.#t):J.copy(this.#e,this.#t),this.Children.forEach(e=>e.UpdateWorldMatrix())}UpdateLocalMatrix(){J.identity(this.#e);let e=this.TransformationOrder.split(``);for(let t=0,n=e.length;t<n;t++)switch(e[t]){case`T`:J.translate(this.#e,this.#r,this.#e);break;case`R`:J.rotate(this.#e,this.#a,this.#e);break;case`S`:J.scale(this.#e,this.#i,this.#e)}}UpdateProjectionMatrix(e){let t=this.#n&&this.#t||this.#e;return J.multiply(e,t,this.ProjectionMatrix)}ResetProjectionMatrix(){J.identity(this.ProjectionMatrix)}Rotate(e){J.rotate(this.#e,e,this.#e)}Scale(e){J.scale(this.#e,e,this.#e)}set Transform(e){J.identity(this.#e);let[t,n,r]=e,i=this.TransformationOrder.split(``);for(let e=0,a=i.length;e<a;e++)switch(i[e]){case`T`:t&&(this.Position=t);break;case`R`:n!==void 0&&(this.Rotation=n);break;case`S`:r&&(this.Scaling=r)}}set Position(e){gn.copy(e,this.#r),J.translate(this.#e,e,this.#e)}get Position(){return this.#r}set Rotation(e){this.#a=e,J.rotate(this.#e,e,this.#e)}get Rotation(){return this.#a}set Scaling(e){gn.copy(e,this.#i),J.scale(this.#e,e,this.#e)}get Scaling(){return this.#i}get LocalMatrix(){return this.#e}get WorldMatrix(){return this.#t}set Parent(e){if(this.#n){let e=this.#n.Children.indexOf(this);0<=e&&this.#n.Children.splice(e,1)}e&&e.Children.push(this),this.#n=e}get Parent(){return this.#n}},Un=class{#n;#e;#t;Transparent=!1;#r=crypto.randomUUID();#i;#a;#s=new yn(0,0);constructor(e=16777215,t=`Shape`){this.Color=e,this.#n=t}CreateColorBuffer(e,t=this.#n){let{color:n,buffer:r}=e.CreateUniformBuffer(`color`,{label:`${t} Color Buffer`});this.#e=n,this.#t=e,this.#a=r,this.#e.set(this.#i),e.WriteBuffer(r,n)}SetBlendConstant(e){if(!e?.BlendConstant||!this.#s.Equals(e.BlendConstant))return this.#t.BlendConstant=this.#s}set BlendConstant(e){typeof e==`number`&&this.#s.Set(e)||(this.#s.rgba=Sn(e))}get BlendConstant(){return this.#s}get ColorBuffer(){return this.#a}set Color(e){this.#i=typeof e==`number`&&Cn(e)||Sn(e),this.#e?.fill(1).set(this.#i),this.#t?.WriteBuffer(this.#a,this.#e)}get Color(){return this.#i}get ID(){return this.#r}Destroy(){this.#t=void 0,this.#a?.destroy(),this.#a=void 0}},Wn=class extends Hn{#n;Visible=!0;#e;#t;#r;#i=gn.set(0,0);#a=gn.set(0,0);#s=Z({min:gn.create(),max:gn.create()});#o=[];constructor(e,t,n=`Shape`,r=null){super(n,r),this.#n=e,this.#t=t===void 0&&new Un||t}SetRenderPipeline(e,t){this.#e=e,this.#n.CreateBuffers(e),this.#t?.CreateColorBuffer(e),this.#u(t)}#u(e,t){let{projection:n,buffer:r}=this.#e.CreateUniformBuffer(`shapeModelViewProjection`,{label:`${this.Label} Projection Buffer`,...t});this.ProjectionMatrix=J.identity(n),this.#r=r,e=Q(e),this.#o=this.#e.SetBindGroupFromResources([r,this.#t?.ColorBuffer,...e].filter(Boolean),0,0,`${this.Label} Bind Group`)}UpdateProjectionMatrix(e){let t=super.UpdateProjectionMatrix(e);return this.#e.WriteBuffer(this.#r,t),t}UpdateLocalMatrix(){super.UpdateLocalMatrix();let e=this.LocalMatrix,{Radius:t}=this.#n;this.#s.min[0]=e[8]-t,this.#s.min[1]=e[9]-t,this.#s.max[0]=e[8]+t,this.#s.max[1]=e[9]+t,J.translate(e,this.#i,e),this.#a[0]=this.#i[0]+this.#s.max[0],this.#a[1]=this.#i[1]+this.#s.max[1]}SetBindGroups(){!this.#e&&i(e.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `Shape.SetRenderPipeline` method before setting its data."),this.#e.BindGroups=this.#o}get ProjectionBuffer(){return this.#r}set Origin(e){this.#i[0]=-e[0],this.#i[1]=-e[1];let t=this.LocalMatrix;J.translate(t,e,t)}get Origin(){return this.#i}get Center(){return this.#a}get BoundingBox(){return this.#s}get Geometry(){return this.#n}get Material(){return this.#t}get Pipeline(){return this.#e}Destroy(){this.#n.Destroy(),this.#t?.Destroy(),this.#e=void 0,this.#o.splice(0),this.#r?.destroy(),this.#r=void 0}},Gn=class extends Bn{Children=[];#n=new Set;MainCamera;constructor(e=`Scene`){super(e),Reflect.deleteProperty(this,`ProjectionMatrix`)}Find(e){let t=super.Find(e);if(t)return t;for(let t of this.#n)if(t.Label===e)return t;return null}Add(e){return super.Add(e)}Remove(e){return super.Remove(e)}AddCamera(e){this.#n.add(e),this.#n.size===1&&(this.MainCamera=e)}RemoveCamera(e){this.#n.delete(e),this.MainCamera===e&&(this.MainCamera=void 0)}Traverse(e){return super.Traverse(e)}ResetLocalMatrix(){r(e.INVALID_CALL,"method: `Scene.ResetLocalMatrix`.")}UpdateProjectionMatrix(t){r(e.INVALID_CALL,"method: `Scene.UpdateProjectionMatrix`.")}ResetProjectionMatrix(){r(e.INVALID_CALL,"method: `Scene.ResetProjectionMatrix`.")}RotateAxis(t,n){r(e.INVALID_CALL,"method: `Scene.RotateAxis`.")}RotateX(t){r(e.INVALID_CALL,"method: `Scene.RotateX`.")}RotateY(t){r(e.INVALID_CALL,"method: `Scene.RotateY`.")}RotateZ(t){r(e.INVALID_CALL,"method: `Scene.RotateZ`.")}Rotate(t){r(e.INVALID_CALL,"method: `Scene.Rotate`.")}Scale(t){r(e.INVALID_CALL,"method: `Scene.Scale`.")}Destroy(){this.Traverse(e=>this!==e&&e.Destroy?.()),this.MainCamera=void 0,this.Children.splice(0),this.#n.clear()}set Transform(t){r(e.INVALID_CALL,"setter: `Scene.Transform`.")}set Position(t){r(e.INVALID_CALL,"setter: `Scene.Position`.")}get Position(){r(e.INVALID_CALL,"getter: `Scene.Position`.")}set Rotation(t){r(e.INVALID_CALL,"setter: `Scene.Rotation`.")}get Rotation(){r(e.INVALID_CALL,"getter: `Scene.Rotation`.")}set Scaling(t){r(e.INVALID_CALL,"setter: `Scene.Scaling`.")}get Scaling(){r(e.INVALID_CALL,"getter: `Scene.Scaling`.")}get LocalMatrix(){r(e.INVALID_CALL,"getter: `Scene.LocalMatrix`.")}},Kn=class{Label;DrawParams=[];IndexFormat;#n=crypto.randomUUID();VertexBuffers;IndexBuffer;constructor(e=`Mesh`,t){this.IndexFormat=t,this.Label=e}SetDrawParams(e,t,n,r,i){return Dn(this.DrawParams,...arguments)}CreateVertexBuffer(e,t,n=this.Label){let r=e.CreateVertexBuffer(t,{label:`${n} Vertex Buffer`});this.VertexBuffers=e.SetVertexBuffers(r),e.WriteBuffer(r,t)}CreateIndexBuffer(e,t,n=this.Label){let r=e.CreateIndexBuffer(t,{label:`${n} Index Buffer`});e.SetDrawParams.apply(e,this.SetDrawParams(t.length)),this.IndexBuffer=e.SetIndexBuffer(r,this.IndexFormat),e.WriteBuffer(r,t)}get Vertices(){return this.DrawParams[0]}get ID(){return this.#n}Destroy(){this.IndexBuffer?.buffer.destroy(),this.IndexBuffer=void 0,this.VertexBuffers&&=(this.VertexBuffers[0]?.buffer.destroy(),this.VertexBuffers.splice(0),void 0)}},qn=Z({TRIANGLE:3,SQUARE:4,PENTAGON:5,HEXAGON:6,HEPTAGON:7,OCTAGON:8,NONAGON:9,DECAGON:10,DODECAGON:12}),Jn=Object.freeze(Object.defineProperty({__proto__:null,Cube:class extends Kn{#n;#e;constructor(e=`Cube`){super(e,`uint16`)}GetPositionBufferLayout(e,t={name:`position`,format:`float32x3`},n=`vertex`,r=`vertex`){return e.CreateVertexBufferLayout(t,n,r)}CreateTextureCoordsBuffer(e,t,n=`vertex`,r=`vertex`){t??=`textureCoords`;let i=new Float32Array([.5,.5,.75,.5,.5,1,.75,1,.25,.5,.5,.5,.25,1,.5,1,0,0,0,.5,.25,0,.25,.5,.5,0,.5,.5,.75,0,.75,.5,0,.5,.25,.5,0,1,.25,1,.25,0,.5,0,.25,.5,.5,.5]);return this.AddVertexBuffer(e,i,t,n,r)}AddVertexBuffer(e,t,n,r=`vertex`,i=`vertex`){let{buffer:a,layout:o}=e.CreateVertexBuffer(n,this.Vertices,r,i);return this.VertexBuffers=e.AddVertexBuffers(a),e.WriteBuffer(a,t),{buffer:a,layout:o}}#t(e,t=this.Label){super.CreateVertexBuffer(e,this.#e??new Float32Array([-.5,.5,.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,-.5,.5]),t)}#r(e,t=this.Label){super.CreateIndexBuffer(e,this.#n??new Uint16Array([0,1,2,2,1,3,4,5,6,6,5,7,8,9,10,10,9,11,12,13,14,14,13,15,16,17,18,18,17,19,20,21,22,22,21,23]),t)}CreateBuffers(e,t=this.Label){this.#t(e,t),this.#r(e,t)}set VertexData(e){this.#e=e}set IndexData(e){this.#n=e}get Vertices(){return(this.#e&&this.#e.length/3)??this.#n?.length??super.Vertices??24}Destroy(){super.Destroy(),this.#n=void 0,this.#e=void 0}},Mesh:Kn,Shape:class{#n;#e;DrawParams=[];IndexFormat;#t;#r=crypto.randomUUID();#i;#a;VertexBuffers;IndexBuffer;constructor(e={segments:`SQUARE`,radius:0}){let t=e.segments,n=typeof t==`number`&&t;this.#n=e.radius??0,this.#e=n||qn[t||`SQUARE`],this.#t={label:`Shape`,...e},this.IndexFormat=e.indexFormat??`uint16`}GetPositionBufferLayout(e,t=`position`,n=`vertex`,r=`vertex`){return e.CreateVertexBufferLayout(t,n,r)}SetDrawParams(e,t,n,r,i){return Dn(this.DrawParams,...arguments)}#s(e,t=this.#t.label){let n=this.#a;if(!n){n=new Float32Array(6*(this.#e+1));let{endAngle:e=X.TAU,startAngle:t=0,innerRadius:r=0}=this.#t,i=e-t;for(let e=0,a=0,o=this.#e;a<=o;++a){let s=t+a*i/o,c=Math.cos(s),l=Math.sin(s);n[e++]=c*this.#n,n[e++]=l*this.#n,n[e++]=c*r,n[e++]=l*r}}let r=e.CreateVertexBuffer(n,{label:`${t} Vertex Buffer`});this.VertexBuffers=e.SetVertexBuffers(r),e.WriteBuffer(r,n)}#o(e,t=this.#t.label){let n=this.#i;if(!n){n=new Uint16Array(6*this.#e);for(let e=0,t=0,r=this.#e;t<r;++t){let r=2*t;n[e++]=r+1,n[e++]=r+3,n[e++]=r+2,n[e++]=r+2,n[e++]=r+0,n[e++]=r+1}}let r=e.CreateIndexBuffer(n,{label:`${t} Index Buffer`});e.SetDrawParams.apply(e,this.SetDrawParams(n.length)),this.IndexBuffer=e.SetIndexBuffer(r,this.IndexFormat),e.WriteBuffer(r,n)}CreateBuffers(e,t=this.#t.label){this.#s(e,t),this.#o(e,t)}set VertexData(e){this.#a=e}set IndexData(e){this.#i=e}get Vertices(){return this.DrawParams[0]}get Radius(){return this.#n}get ID(){return this.#r}Destroy(){this.IndexBuffer?.buffer.destroy(),this.IndexBuffer=void 0,this.#a=void 0,this.#i=void 0,this.VertexBuffers&&=(this.VertexBuffers[0]?.buffer.destroy(),this.VertexBuffers.splice(0),void 0)}}},Symbol.toStringTag,{value:`Module`}));Object.freeze(Object.defineProperty({__proto__:null,Mesh:Vn,Shape:Un},Symbol.toStringTag,{value:`Module`}));var Yn=class{#n;#e;#t;#r;constructor(e,t){if(this.#t=t.get(63)??t.entries().next().value[1],this.#r=e.common.lineHeight,this.#e=t,e.kernings){this.#n=new Map;for(let t of e.kernings){let e=this.#n.get(t.first);e||(e=new Map,this.#n.set(t.first,e)),e.set(t.second,t.amount)}}}GetCharacter(e){return this.#e.get(e)??this.#t}GetXAdvance(e,t=-1){let n=this.GetCharacter(e);if(t>-1){let r=this.#n.get(e);if(r)return n.xadvance+(r.get(t)??0)}return n.xadvance}get LineHeight(){return this.#r}},Xn=class{#n;#e;#t;#r;#i;#a;#s;#o;#u;#c=new Float32Array(8);constructor(e=`MSDFText`){this.#n=e}CreateRenderPipeline(e){this.#e=e,this.#r=new this.#e.Pipeline;let t=this.#r.CreateShaderModule(h),n=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT;return this.#o=this.#r.CreateBindGroupLayout([this.#e.CreateSamplerBindingLayout(),this.#e.CreateTextureBindingLayout(),this.#e.CreateBufferBindingLayout(`read-only-storage`,!1,0,GPUShaderStage.VERTEX),this.#e.CreateBufferBindingLayout(void 0,!1,0,GPUShaderStage.VERTEX)]),this.#u=this.#r.CreateBindGroupLayout(this.#e.CreateBufferBindingLayout(`read-only-storage`,!1,0,n)),this.#e.AddPipeline(this.#r,{layout:this.#r.CreatePipelineLayout([this.#o,this.#u]),primitive:this.#r.CreatePrimitiveState(`triangle-strip`,void 0,`uint32`),depthStencil:this.#r.CreateDepthStencilState(void 0,!1),vertex:this.#r.CreateVertexState(t),fragment:this.#r.CreateFragmentState(t,this.#r.CreateColorTargetState(zn.ALPHA_ADDITIVE))})}async#l(e){return this.#s.CopyImageToTexture(await this.#s.CreateImageBitmap(e),{mipmaps:!1,create:{label:`${this.#n} Font Texture`}})}#f(e,t,n){let r=0,i=0,a=e.charCodeAt(0),o=[0,0],s=[],{LineHeight:c}=t;for(let l=0,u=0,d=a,f=e.length,p=f-1;l<f;d=a,++l)switch(a=l<p&&e.charCodeAt(l+1)||-1,d){case 10:case 13:r=Math.max(r,o[0]),s.push(o[0]),o[1]-=c,o[0]=0,u++;break;case 32:o[0]+=t.GetXAdvance(d);break;default:n?.(o,u,t.GetCharacter(d).c),o[0]+=t.GetXAdvance(d,a),i++}return s.push(o[0]),r=Math.max(r,o[0]),{lineWidths:s,instances:i,height:c*s.length,width:r}}async LoadFont(t,n=!1,r){!this.#r&&i(e.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `MSDFText.CreateRenderPipeline` method before loading a font file."),this.#t=n;let a=t.lastIndexOf(`/`)+1;this.#s=new(await(Xt.Texture()));let o=a&&t.substring(0,a)||``,s=await(await fetch(t,r)).json(),c=s.pages.map(e=>this.#l(o+e)),{buffer:l}=this.#r.CreateStorageBuffer(`Characters`,{label:`${this.#n} Characters Buffer`,length:s.chars.length,mappedAtCreation:!0});this.#i=this.#r.CreateUniformBuffer(`Camera`,{label:`${this.#n} Camera Buffer`}).buffer;let u=new Map,d=1/s.common.scaleW,f=1/s.common.scaleH,p=new Float32Array(l.getMappedRange());for(let e=0,t=0,n=s.chars.length;e<n;t+=8,++e){let n=s.chars[e];p[t+0]=n.x*d,p[t+1]=n.y*f,p[t+2]=n.width*d,p[t+3]=n.height*f,p[t+4]=n.width,p[t+5]=n.height,p[t+6]=n.xoffset,p[t+7]=-n.yoffset,u.set(n.id,Object.assign({c:e},n))}let m=this.#s.CreateSampler({label:`${this.#n} Sampler`,maxAnisotropy:16,filter:`linear`});return l.unmap(),this.#a=await Promise.all(c),this.#r.SetBindGroupFromResources([m,this.#a[0].createView(),l,this.#i],0,this.#o),new Yn(s,u)}Write(t,n,r=0,a=.01,o=!1){!this.#r&&i(e.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `MSDFText.CreateRenderPipeline` method before writing a string.");let s=this.#r.CreateStorageBuffer(`Text`,{label:`${this.#n} Storage Buffer`,size:16*t.length+96,mappedAtCreation:!0}).buffer,c=new Float32Array(s.getMappedRange()),l,u=24;return o?(l=this.#f(t,n),this.#f(t,n,([e,t],n,r)=>{let{lineWidths:i,width:a,height:o}=l,s=-.5*a- -.5*(a-i[n]);c[u+0]=e+s,c[u+1]=t+.5*o,c[u+2]=r,u+=4})):l=this.#f(t,n,([e,t],n,r)=>{c[u+0]=e,c[u+1]=t,c[u+2]=r,u+=4}),s.unmap(),this.#r.BindGroups.length===1?this.#r.AddBindGroupFromResources(s,0,this.#u):this.#r.BindGroups[1].bindGroup=this.#r.CreateBindGroup(this.#r.CreateBindGroupEntries(s),this.#u),this.#r.SetDrawParams(4,l.instances),this.#r.EncodeRenderBundle(this.#e.CreateRenderBundleEncoder()),this.#c.set([.5-this.#t,a]),this.#r.WriteBuffer(s,this.#c,0,0,2),this.SetColor(r,s),s}SetTransform(t,n){!this.#r&&i(e.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `MSDFText.CreateRenderPipeline` method before setting transform matrix."),this.#r.WriteBuffer(n,t,32,0,16)}SetColor(t,n){!this.#r&&i(e.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `MSDFText.CreateRenderPipeline` method before setting text color."),this.#c.set(typeof t==`number`&&Cn(t)||Sn(t),4),this.#r.WriteBuffer(n,this.#c,16,4,4)}SetScale(t,n){!this.#r&&i(e.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `MSDFText.CreateRenderPipeline` method before setting text scale."),this.#c[1]=t,this.#r.WriteBuffer(n,this.#c,4,1,1)}UpdatePerspective(t){!this.#r&&i(e.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `MSDFText.CreateRenderPipeline` method before updating projection matrix."),this.#r.WriteBuffer(this.#i,t.LocalMatrix,0),this.#r.WriteBuffer(this.#i,t.ProjectionMatrix,64)}get Pipeline(){return this.#r}Destroy(){this.#a?.forEach(e=>e?.destroy()),this.#i?.destroy(),this.#r.Destroy(),this.#s?.Destroy()}},Zn=class extends Bn{#n=_n.set(0,1,0);#e=60;#t=1;#r=1e3;#i=innerWidth/innerHeight;#a=Y.identity();#s=new Float32Array(24);#o=Y.identity();constructor(e=60,t=1,n=1e3,r=innerWidth/innerHeight){super(`PerspectiveCamera`),this.#e=e,this.#t=t,this.#r=n,this.#i=typeof r==`number`?r:r.AspectRatio,this.UpdateProjectionMatrix()}#u(e=!1){let[t,n,r,i,a,o,s,c,l,u,d,f,p,m,h,g]=this.#o;if(this.#s[0]=p+l,this.#s[1]=m+u,this.#s[2]=h+d,this.#s[3]=g+f,this.#s[4]=p-l,this.#s[5]=m-u,this.#s[6]=h-d,this.#s[7]=g-f,this.#s[8]=p-a,this.#s[9]=m-o,this.#s[10]=h-s,this.#s[11]=g-c,this.#s[12]=p-t,this.#s[13]=m-n,this.#s[14]=h-r,this.#s[15]=g-i,this.#s[16]=p+a,this.#s[17]=m+o,this.#s[18]=h+s,this.#s[19]=g+c,this.#s[20]=p+t,this.#s[21]=m+n,this.#s[22]=h+r,this.#s[23]=g+i,!e)return this.#s;for(let e=0;e<6;++e){let t=4*e,n=Math.hypot(this.#s[t+0],this.#s[t+1],this.#s[t+2])||1;this.#s[t+0]/=n,this.#s[t+1]/=n,this.#s[t+2]/=n,this.#s[t+3]/=n}return this.#s}UpdateViewProjectionMatrix(){return Y.inverse(this.LocalMatrix,this.#a),Y.multiply(this.ProjectionMatrix,this.#a,this.#o),this.#u(),this.#o}UpdateProjectionMatrix(){let e=X.DegreesToRadians(this.#e);return Y.perspective(e,this.#i,this.#t,this.#r,this.ProjectionMatrix)}LookAt(e,t=this.#n){return Y.lookAt(this.Position,e,t,this.#a),Y.multiply(this.ProjectionMatrix,this.#a,this.#o)}get ViewProjectionMatrix(){return this.#o}get Frustum(){return this.#s}set FieldOfView(e){this.#e=e,this.UpdateProjectionMatrix()}get FieldOfView(){return this.#e}set AspectRatio(e){this.#i=typeof e==`number`?e:e.AspectRatio,this.UpdateProjectionMatrix()}get AspectRatio(){return this.#i}set Near(e){this.#t=e,this.UpdateProjectionMatrix()}get Near(){return this.#t}set Far(e){this.#r=e,this.UpdateProjectionMatrix()}get Far(){return this.#r}},Qn=class extends Hn{#n=0;#e=innerWidth;#t=innerHeight;#r=0;#i=new Float32Array(4);constructor(e=innerWidth,t=innerHeight){super(`Camera2D`),this.Size=typeof e!=`number`&&e.CanvasSize||[e,t]}#a(e=!1){}UpdateProjectionMatrix(){let e=this.#n,t=this.#e,n=this.#t,r=this.#r;return J.set(2/t,0,0,0,-2/n,0,r/t*2-1,e/n*-2+1,1,this.ProjectionMatrix),this.#a(),this.ProjectionMatrix}set Size([e,t]){this.#e=e,this.#t=t,this.UpdateProjectionMatrix()}set Top(e){this.#n=e,this.UpdateProjectionMatrix()}get Top(){return this.#n}set Right(e){this.#e=e,this.UpdateProjectionMatrix()}get Right(){return this.#e}set Bottom(e){this.#t=e,this.UpdateProjectionMatrix()}get Bottom(){return this.#t}set Left(e){this.#r=e,this.UpdateProjectionMatrix()}get Left(){return this.#r}get Frustum(){return this.#i}};
/**
* @module UWAL
* @author Ustym Ukhman <ustym.ukhman@gmail.com>
* @description Unopinionated WebGPU Abstraction Library
* @version 0.2.1
* @license MIT
*/console.info(`%cUWAL v0.2.1`,`background:#005a9c;padding:3px;color:#fff;`);var $n=``+new URL(`../PressStart2P.json`,import.meta.url).href,er=new yn,tr,nr,rr,ir,ar=document.getElementById(`game`),$=new(await(Xt.Renderer(ar))),{colorAttachments:or}=$.CreatePassDescriptor($.CreateColorAttachment(er),$.CreateDepthStencilAttachment());$.SetCanvasSize(innerWidth-64,innerHeight-24);var sr=new $.Pipeline,cr=sr.CreateShaderModule(b.Shape),{value:lr}=or[Symbol.iterator]().next(),ur=Float32Array.BYTES_PER_ELEMENT*6+2;ur*=Float32Array.BYTES_PER_ELEMENT;var dr=new Zn,fr=Float32Array.from([12,12]),pr,mr,[hr,gr]=$.CanvasSize,_r=new Qn($),vr=[hr/2,gr/2],yr,br,xr=new Gn,Sr=[0,0],Cr=[0,0];xr.AddCamera(_r);var wr=16,Tr=[0,0],Er=!1,Dr=0,Or=4,kr,Ar=60;{let e=new Float32Array(32),t=new $.Pipeline,n=new Jn.Shape({radius:8}),r=t.CreateShaderModule([b.Shape,`
    @vertex fn textureVertex(
        @location(0) position: vec2f,
        @location(1) translation: f32
    ) -> @builtin(position) vec4f
    {
        let clipSpace = GetVertexClipSpace(position).xy;
        return vec4f(clipSpace + vec2f(0, translation), 0, 1);
    }`]),{buffer:i,layout:a}=t.CreateVertexBuffer(`translation`,32,`instance`,`textureVertex`);await $.AddPipeline(t,{depthStencil:sr.CreateDepthStencilState(void 0,!1),fragment:t.CreateFragmentState(r),vertex:t.CreateVertexState(r,[n.GetPositionBufferLayout(t),a],void 0,`textureVertex`)}),br=new Wn(n),br.SetRenderPipeline(t),br.Rotation=Math.PI/4,xr.Add(br);for(let t=32;t--;)e.set([t/32*2-1],t);t.AddVertexBuffers(i),t.WriteBuffer(i,e),n.SetDrawParams(n.Vertices,32)}{let e=new Jn.Shape({segments:32,radius:16});await $.AddPipeline(sr,{depthStencil:sr.CreateDepthStencilState(void 0,!1),fragment:sr.CreateFragmentState(cr),vertex:sr.CreateVertexState(cr,e.GetPositionBufferLayout(sr))}),yr=new Wn(e),yr.SetRenderPipeline(sr),xr.Add(yr)}{rr=new Xn,ir=await rr.CreateRenderPipeline($);let e=await rr.LoadFont($n);tr=rr.Write(`0`,e,16777215),nr=rr.Write(`0`,e,16777215)}function jr(){let[e,t]=Sr,{min:n,max:r}=yr.BoundingBox,[i,a]=$.CanvasSize,o=(Math.sign(e)+1&&mr||pr).Position[1],s=o-Tr[0]<=r[1]&&n[1]<=o+Tr[0]&&Tr[0]-Cr[0]||0;if(o=pr.Position[1]+Dr*wr,pr.Position[1]=X.Clamp(o,...Tr),n[0]<=s||r[0]>=i-s)if(s)Or=Math.min(Or+2,32),e*=-1;else return Pr((Math.sign(e)+1)/-2+1),mr.Position[1]=vr[1],yr.Position[0]=vr[0],yr.Position[1]=vr[1],$.Render(!1),$.Render(xr),Nr();(n[1]<=0||r[1]>=a)&&(t*=-1),0<Ar&&!--Ar?(Cr[1]=mr.Position[1]-yr.Position[1],setTimeout(()=>Ar=X.RandomInt(4,Or),X.RandomInt(16384,32768))):Ar||(mr.Position[1]=X.Clamp(yr.Position[1]+Cr[1],...Tr)),yr.Position[0]+=e*Or,yr.Position[1]+=t*Or,Sr[0]=e,Sr[1]=t,$.Render(!1),$.Render(xr),kr=requestAnimationFrame(jr)}function Mr(){if(Er)return location.reload();$.SetCanvasSize(innerWidth-64,innerHeight-24);let[e,t]=$.CanvasSize;dr.AspectRatio=$.AspectRatio,dr.UpdateViewProjectionMatrix(),_r.Size=$.CanvasSize,vr[0]=e/2,vr[1]=t/2;let n=t/8,r=t/16,i=t/64;yr.Position=vr,br.Position=[vr[0],vr[1]-i];{let i=n;Cr[0]=r,pr&&mr&&(xr.Remove([pr,mr]),pr.Destroy(),mr.Destroy()),Tr[1]=t-(Tr[0]=i/Math.sqrt(2));let a=new Jn.Shape({radius:i});pr=new Wn(a),mr=new Wn(a),pr.SetRenderPipeline(sr),mr.SetRenderPipeline(sr),pr.Position=[-r,vr[1]],mr.Position=[e+r,vr[1]],pr.Rotation=Math.PI/4,mr.Rotation=Math.PI/4,xr.Add(pr),xr.Add(mr)}{let t=X.Mat4.translation([e/-696,1.6,-4]),n=X.Mat4.translation([e/960,1.6,-4]);rr.SetTransform(t,tr),rr.SetTransform(n,nr),rr.UpdatePerspective(dr)}$.Render(!1),$.Render(xr)}function Nr(){let e=X.RandomInt(0,1)*2-1,t=X.RandomInt(0,1)*2-1;Sr[0]=e*X.Random(.5),Sr[1]=t*X.Random(.5),Or=Ar=4,Cr[1]=0}function Pr(e){if(++fr[e]===22)return Fr(fr[0]===22);let t=e&&nr||tr;ir.WriteBuffer(t,fr,ur,e,1)}async function Fr(e){fr[0]=fr[1]=94;let t=e&&`win`||`lose`,n=new Xn;await n.CreateRenderPipeline($);let r=X.Mat4.translation([0,-.4,-4]),i=n.Write(`Game Over\nYou ${t}!`,await n.LoadFont($n),16777215,.01,!0);ir.WriteBuffer(tr,fr,ur,0,1),ir.WriteBuffer(nr,fr,ur,1,1),lr.clearValue=er.Set(e&&32768||8388608).rgba,n.SetTransform(r,i),n.UpdatePerspective(dr),sr.Active=yr.Visible=pr.Visible=mr.Visible=!1,ar.classList.add(t),cancelAnimationFrame(kr),$.Render(!1),$.Render(xr),Er=!0}function Ir(e){switch(e.code){case`Space`:if(Er)return location.reload();yr.Position[0]===vr[0]&&yr.Position[1]===vr[1]&&(Nr(),jr());break;case`ArrowUp`:Dr=-1;break;case`ArrowDown`:Dr=1;break}}addEventListener(`keydown`,Ir,!1),addEventListener(`keyup`,()=>Dr=0,!1),addEventListener(`resize`,Mr,!1),Mr();